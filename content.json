{"meta":{"title":"ctzzhang","subtitle":null,"description":null,"author":"Ctzzhang","url":"http://localhost:4000","root":"/"},"pages":[{"title":"å…³äº","date":"2019-06-16T07:30:14.312Z","updated":"2019-06-16T07:30:14.312Z","comments":false,"path":"about/index.html","permalink":"http://localhost:4000/about/index.html","excerpt":"","text":"æ¬¢è¿è®¿é—®æˆ‘çš„åšå®¢ï¼Œæˆ‘ä¼šä¿æŒä¸å®šæœŸæ›´æ–°ã€‚/** * * â”â”â”â”â”â”ç¥å…½å‡ºæ²¡â”â”â”â”â”â”â”â”“ â”â”“â”ƒ â”ƒ + +â”ƒ â” â”ƒ ++ + + +â–ˆâ–ˆâ–ˆâ–ˆâ”â–ˆâ–ˆâ–ˆâ–ˆ â”ƒ ğŸš‚ğŸš‚ğŸš‚-&lt;-&lt; æ¬¢è¿è®¿é—® https://ctzzhang.github.io/â”ƒ â”ƒ +â”ƒ â”» â”ƒ + +â”ƒ â”ƒâ”—â”â”“ â”â”â”›Code is far away from bug with the animal protectingâ”ƒ â”ƒ ç¥å…½æŠ¤ä½“ï¼Œæ°¸æ— bugâ”ƒ â”ƒ +â”ƒ â”—â”â”â”â”“+â”ƒ â”£â”“ ğŸ“¬ è”ç³»æˆ‘ï¼štzzhang021.com(at)163.comâ”ƒ â”â”› + +â”—â”“â”“â”â”â”³â”“â”â”› +â”ƒâ”«â”« â”ƒâ”«â”«â”—â”»â”› â”—â”»â”›/"},{"title":"åˆ†ç±»","date":"2019-06-16T07:30:14.382Z","updated":"2019-06-16T07:30:14.382Z","comments":false,"path":"categories/index.html","permalink":"http://localhost:4000/categories/index.html","excerpt":"","text":""},{"title":"ä¹¦å•","date":"2019-06-16T07:30:14.364Z","updated":"2019-06-16T07:30:14.364Z","comments":false,"path":"books/index.html","permalink":"http://localhost:4000/books/index.html","excerpt":"","text":""},{"title":"å‹æƒ…é“¾æ¥","date":"2019-06-16T07:30:14.380Z","updated":"2019-06-16T07:30:14.380Z","comments":true,"path":"links/index.html","permalink":"http://localhost:4000/links/index.html","excerpt":"","text":""},{"title":"Repositories","date":"2019-06-16T07:30:14.625Z","updated":"2019-06-16T07:30:14.625Z","comments":false,"path":"repository/index.html","permalink":"http://localhost:4000/repository/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2019-06-16T07:30:14.367Z","updated":"2019-06-16T07:30:14.367Z","comments":false,"path":"tags/index.html","permalink":"http://localhost:4000/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"Redis åŸºæ•°æ ‘","slug":"Redis-åŸºæ•°æ ‘","date":"2019-06-19T14:41:33.000Z","updated":"2019-06-19T15:30:53.948Z","comments":true,"path":"2019/06/19/Redis-åŸºæ•°æ ‘/","link":"","permalink":"http://localhost:4000/2019/06/19/Redis-åŸºæ•°æ ‘/","excerpt":"","text":"Redis åŸºæ•°æ ‘1. ç®€ä»‹Rax æ˜¯ Redis å†…éƒ¨æ¯”è¾ƒç‰¹æ®Šçš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒæ˜¯ä¸€ä¸ªæœ‰åºå­—å…¸æ ‘ (åŸºæ•°æ ‘ Radix Tree)ï¼ŒæŒ‰ç…§ key çš„å­—å…¸åºæ’åˆ—ï¼Œæ”¯æŒå¿«é€Ÿåœ°å®šä½ã€æ’å…¥å’Œåˆ é™¤æ“ä½œã€‚Redis äº”å¤§åŸºç¡€æ•°æ®ç»“æ„é‡Œé¢ï¼Œèƒ½ä½œä¸ºå­—å…¸ä½¿ç”¨çš„æœ‰ hash å’Œ zsetã€‚hash ä¸å…·å¤‡æ’åºåŠŸèƒ½ï¼Œzset åˆ™æ˜¯æŒ‰ç…§ score è¿›è¡Œæ’åºçš„ã€‚rax è·Ÿ zset çš„ä¸åŒåœ¨äºå®ƒæ˜¯æŒ‰ç…§ key è¿›è¡Œæ’åºçš„ã€‚Redis ä½œè€…è®¤ä¸º rax çš„ç»“æ„éå¸¸æ˜“äºç†è§£ï¼Œä½†æ˜¯å®ç°å´æœ‰ç›¸å½“çš„å¤æ‚åº¦ï¼Œéœ€è¦è€ƒè™‘å¾ˆå¤šçš„è¾¹ç•Œæ¡ä»¶ï¼Œéœ€è¦å¤„ç†èŠ‚ç‚¹çš„åˆ†è£‚ã€åˆå¹¶ï¼Œä¸€ä¸å°å¿ƒå°±ä¼šå‡ºé”™ã€‚2. åº”ç”¨ä½ å¯ä»¥å°†ä¸€æœ¬è‹±è¯­å­—å…¸çœ‹æˆä¸€æ£µ radix treeï¼Œå®ƒæ‰€æœ‰çš„å•è¯éƒ½æ˜¯æŒ‰ç…§å­—å…¸åºè¿›è¡Œæ’åˆ—ï¼Œæ¯ä¸ªè¯æ±‡éƒ½ä¼šé™„å¸¦ä¸€ä¸ªè§£é‡Šï¼Œè¿™ä¸ªè§£é‡Šå°±æ˜¯ key å¯¹åº”çš„ valueã€‚æœ‰äº†è¿™æ£µæ ‘ï¼Œä½ å°±å¯ä»¥å¿«é€Ÿåœ°æ£€ç´¢å•è¯ï¼Œè¿˜å¯ä»¥æŸ¥è¯¢ä»¥æŸä¸ªå‰ç¼€å¼€å¤´çš„å•è¯æœ‰å“ªäº›ã€‚ä½ ä¹Ÿå¯ä»¥å°†å…¬å®‰å±€çš„äººå‘˜æ¡£æ¡ˆä¿¡æ¯çœ‹æˆä¸€æ£µ radix treeï¼Œå®ƒçš„ key æ˜¯æ¯ä¸ªäººçš„èº«ä»½è¯å·ï¼Œvalue æ˜¯è¿™ä¸ªäººçš„å±¥å†ã€‚å› ä¸ºèº«ä»½è¯å·çš„ç¼–ç çš„å‰ç¼€æ˜¯æŒ‰ç…§åœ°åŒºè¿›è¡Œä¸€çº§ä¸€çº§åˆ’åˆ†çš„ï¼Œè¿™ç‚¹å’Œå•è¯éå¸¸ç±»ä¼¼ã€‚æœ‰äº†è¿™æ£µæ ‘ï¼Œä½ å°±å¯ä»¥å¿«é€Ÿåœ°å®šä½å‡ºäººå‘˜æ¡£æ¡ˆï¼Œè¿˜å¯ä»¥å¿«é€ŸæŸ¥è¯¢å‡ºæŸä¸ªå°ç‰‡åŒºéƒ½æœ‰å“ªäº›äººã€‚Radix tree è¿˜å¯ä»¥åº”ç”¨äºæ—¶é—´åºåˆ—åº”ç”¨ï¼Œkey ä¸ºæ—¶é—´æˆ³ï¼Œvalue ä¸ºå‘ç”Ÿåœ¨å…·ä½“æ—¶é—´çš„äº‹ä»¶å†…å®¹ã€‚å› ä¸ºæ—¶é—´æˆ³çš„ç¼–ç ä¹Ÿæ˜¯æŒ‰ç…§ã€å¹´æœˆæ—¥æ—¶åˆ†ç§’æ¯«ç§’å¾®ç§’çº³ç§’ã€‘è¿›è¡Œä¸€çº§ä¸€çº§åˆ’åˆ†çš„ï¼Œæ‰€ä»¥å®ƒä¹Ÿå¯ä»¥ä½¿ç”¨å­—å…¸åºæ¥æ’åºã€‚æœ‰äº†è¿™æ£µæ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¿«é€Ÿå®šä½å‡ºæŸä¸ªå…·ä½“æ—¶é—´å‘ç”Ÿäº†ä»€ä¹ˆäº‹ï¼Œä¹Ÿå¯ä»¥æŸ¥è¯¢å‡ºä¸€æ®µæ—¶é—´å†…éƒ½æœ‰å“ªäº›äº‹å‘ç”Ÿã€‚æˆ‘ä»¬ç»å¸¸ä½¿ç”¨çš„ Web æœåŠ¡å™¨çš„ Router å®ƒä¹Ÿæ˜¯ä¸€æ£µ radix treeã€‚è¿™æ£µæ ‘ä¸ŠæŒ‚æ»¡äº† URL è§„åˆ™ï¼Œæ¯ä¸ª URL è§„åˆ™ä¸Šéƒ½ä¼šé™„ä¸Šä¸€ä¸ªè¯·æ±‚å¤„ç†å™¨ã€‚å½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬æ‹¿è¿™ä¸ªè¯·æ±‚çš„ URL æ²¿ç€æ ‘è¿›è¡Œéå†ï¼Œæ‰¾åˆ°ç›¸åº”çš„è¯·æ±‚å¤„ç†å™¨æ¥å¤„ç†ã€‚å› ä¸º URL ä¸­å¯èƒ½å­˜åœ¨æ­£åˆ™ patternï¼Œè€Œä¸”åŒä¸€å±‚çš„èŠ‚ç‚¹å¯¹é¡ºåºæ²¡æœ‰è¦æ±‚ï¼Œæ‰€ä»¥å®ƒä¸ç®—æ˜¯ä¸€æ£µä¸¥æ ¼çš„ radix treeã€‚123456789101112131415161718# golang çš„ HttpRouter åº“The router relies on a tree structure which makes heavy use of *common prefixes*it is basically a *compact* [*prefix tree*](https://en.wikipedia.org/wiki/Trie)(or just [*Radix tree*](https://en.wikipedia.org/wiki/Radix_tree)).Nodes with a common prefix also share a common parent.Here is a short example what the routing tree for the `GET` request method could look like:Priority Path Handle9 \\ *&lt;1&gt;3 â”œs nil2 |â”œearch\\ *&lt;2&gt;1 |â””upport\\ *&lt;3&gt;2 â”œblog\\ *&lt;4&gt;1 | â””:post nil1 | â””\\ *&lt;5&gt;2 â”œabout-us\\ *&lt;6&gt;1 | â””team\\ *&lt;7&gt;1 â””contact\\ *&lt;8&gt;Rax è¢«ç”¨åœ¨ Redis Stream ç»“æ„é‡Œé¢ç”¨äºå­˜å‚¨æ¶ˆæ¯é˜Ÿåˆ—ï¼Œåœ¨ Stream é‡Œé¢æ¶ˆæ¯ ID çš„å‰ç¼€æ˜¯æ—¶é—´æˆ³ + åºå·ï¼Œè¿™æ ·çš„æ¶ˆæ¯å¯ä»¥ç†è§£ä¸ºæ—¶é—´åºåˆ—æ¶ˆæ¯ã€‚ä½¿ç”¨ Rax ç»“æ„è¿›è¡Œå­˜å‚¨å°±å¯ä»¥å¿«é€Ÿåœ°æ ¹æ®æ¶ˆæ¯ ID å®šä½åˆ°å…·ä½“çš„æ¶ˆæ¯ï¼Œç„¶åç»§ç»­éå†æŒ‡å®šæ¶ˆæ¯ä¹‹åçš„æ‰€æœ‰æ¶ˆæ¯ã€‚3. ç»“æ„rax ä¸­æœ‰éå¸¸å¤šçš„èŠ‚ç‚¹ï¼Œæ ¹èŠ‚ç‚¹ã€å¶èŠ‚ç‚¹å’Œä¸­é—´èŠ‚ç‚¹ï¼Œæœ‰äº›ä¸­é—´èŠ‚ç‚¹å¸¦æœ‰ valueï¼Œæœ‰äº›ä¸­é—´èŠ‚ç‚¹çº¯ç²¹æ˜¯ç»“æ„æ€§éœ€è¦æ²¡æœ‰å¯¹åº”çš„ valueã€‚1234567struct raxNode &#123;int&lt;1&gt; isKey; // æ˜¯å¦æ²¡æœ‰ keyï¼Œæ²¡æœ‰ key çš„æ˜¯æ ¹èŠ‚ç‚¹int&lt;1&gt; isNull; // æ˜¯å¦æ²¡æœ‰å¯¹åº”çš„ valueï¼Œæ— æ„ä¹‰çš„ä¸­é—´èŠ‚ç‚¹int&lt;1&gt; isCompressed; // æ˜¯å¦å‹ç¼©å­˜å‚¨ï¼Œè¿™ä¸ªå‹ç¼©çš„æ¦‚å¿µæ¯”è¾ƒç‰¹åˆ«int&lt;29&gt; size; // å­èŠ‚ç‚¹çš„æ•°é‡æˆ–è€…æ˜¯å‹ç¼©å­—ç¬¦ä¸²çš„é•¿åº¦ (isCompressed)byte[] data; // è·¯ç”±é”®ã€å­èŠ‚ç‚¹æŒ‡é’ˆã€value éƒ½åœ¨è¿™é‡Œ&#125;rax æ˜¯ä¸€æ£µæ¯”è¾ƒç‰¹æ®Šçš„ radix treeï¼Œå®ƒåœ¨ç»“æ„ä¸Šä¸æ˜¯æ ‡å‡†çš„ radix treeã€‚å¦‚æœä¸€ä¸ªä¸­é—´èŠ‚ç‚¹æœ‰å¤šä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè·¯ç”±é”®å°±åªæ˜¯ä¸€ä¸ªå­—ç¬¦ã€‚å¦‚æœåªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè·¯ç”±é”®å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚åè€…å°±æ˜¯æ‰€è°“çš„ã€Œå‹ç¼©ã€å½¢å¼ï¼Œå¤šä¸ªå­—ç¬¦å‹åœ¨ä¸€èµ·çš„å­—ç¬¦ä¸²ã€‚æ¯”å¦‚å‰é¢çš„é‚£æ£µå­—å…¸æ ‘åœ¨ Rax ç®—æ³•ä¸­å°†å‘ˆç°å‡ºå¦‚ä¸‹ç»“æ„ï¼šå›¾ä¸­çš„æ·±è“è‰²èŠ‚ç‚¹å°±æ˜¯ã€Œå‹ç¼©ã€èŠ‚ç‚¹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬å†ç»†çœ‹raxNode.dataé‡Œé¢å­˜å‚¨çš„åˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒå¤æ‚çš„ç»“æ„ï¼ŒæŒ‰ç…§å‹ç¼©ä¸å¦åˆ†ä¸ºä¸¤ç§ç»“æ„å‹ç¼©ç»“æ„ å­èŠ‚ç‚¹å¦‚æœåªæœ‰ä¸€ä¸ªï¼Œé‚£å°±æ˜¯å‹ç¼©ç»“æ„ï¼Œdata å­—æ®µå¦‚ä¸‹ä¼ªä»£ç æ‰€ç¤ºï¼š1234567struct data &#123;optional struct &#123; // å–å†³äº header çš„ size å­—æ®µæ˜¯å¦ä¸ºé›¶byte[] childKey; // è·¯ç”±é”®raxNode* childNode; // å­èŠ‚ç‚¹æŒ‡é’ˆ&#125; child;optional string value; // å–å†³äº header çš„ isNull å­—æ®µ&#125;å¦‚æœæ˜¯å¶å­èŠ‚ç‚¹ï¼Œchild å­—æ®µå°±ä¸å­˜åœ¨ã€‚å¦‚æœæ˜¯æ— æ„ä¹‰çš„ä¸­é—´èŠ‚ç‚¹ (isNull)ï¼Œé‚£ä¹ˆ value å­—æ®µå°±ä¸å­˜åœ¨ã€‚éå‹ç¼©èŠ‚ç‚¹ å¦‚æœå­èŠ‚ç‚¹æœ‰å¤šä¸ªï¼Œé‚£å°±ä¸æ˜¯å‹ç¼©ç»“æ„ï¼Œå­˜åœ¨å¤šä¸ªè·¯ç”±é”®ï¼Œä¸€ä¸ªé”®æ˜¯ä¸€ä¸ªå­—ç¬¦ã€‚12345struct data &#123;byte[] childKeys; // è·¯ç”±é”®å­—ç¬¦åˆ—è¡¨raxNode*[] childNodes; // å¤šä¸ªå­èŠ‚ç‚¹æŒ‡é’ˆoptional string value; // å–å†³äº header çš„ isNull å­—æ®µ&#125;ä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°å¦‚æœå­èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”è·¯ç”±é”®å­—ç¬¦ä¸²çš„é•¿åº¦ä¸º 1 å‘¢ï¼Œé‚£åˆ°åº•ç®—å‹ç¼©è¿˜æ˜¯éå‹ç¼©ï¼Ÿä»”ç»†æ€è€ƒä¸€ä¸‹ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‹ç¼©å’Œéå‹ç¼©åœ¨æ•°æ®ç»“æ„è¡¨ç°å½¢å¼ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä¸ç®¡ isCompressed æ˜¯ 0 è¿˜å¥½æ˜¯ 1ï¼Œç»“æ„éƒ½æ˜¯ä¸€æ ·çš„ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[]},{"title":"Redis ç´§å‡‘åˆ—è¡¨ç»“æ„","slug":"Redis-ç´§å‡‘åˆ—è¡¨ç»“æ„","date":"2019-06-19T14:37:42.000Z","updated":"2019-06-19T15:30:42.573Z","comments":true,"path":"2019/06/19/Redis-ç´§å‡‘åˆ—è¡¨ç»“æ„/","link":"","permalink":"http://localhost:4000/2019/06/19/Redis-ç´§å‡‘åˆ—è¡¨ç»“æ„/","excerpt":"","text":"Redis ç´§å‡‘åˆ—è¡¨ç»“æ„1. ç®€ä»‹Redis 5.0 åˆå¼•å…¥äº†ä¸€ä¸ªæ–°çš„æ•°æ®ç»“æ„ listpackï¼Œå®ƒæ˜¯å¯¹ ziplist ç»“æ„çš„æ”¹è¿›ï¼Œåœ¨å­˜å‚¨ç©ºé—´ä¸Šä¼šæ›´åŠ èŠ‚çœï¼Œè€Œä¸”ç»“æ„ä¸Šä¹Ÿæ¯” ziplist è¦ç²¾ç®€ã€‚å®ƒçš„æ•´ä½“å½¢å¼å’Œ ziplist è¿˜æ˜¯æ¯”è¾ƒæ¥è¿‘çš„ï¼Œå¦‚æœä½ è®¤çœŸé˜…è¯»äº† ziplist çš„å†…éƒ¨ç»“æ„åˆ†æï¼Œé‚£ä¹ˆ listpack ä¹Ÿæ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ã€‚123456struct listpack&lt;T&gt; &#123;int32 total_bytes; // å ç”¨çš„æ€»å­—èŠ‚æ•°int16 size; // å…ƒç´ ä¸ªæ•°T[] entries; // ç´§å‡‘æ’åˆ—çš„å…ƒç´ åˆ—è¡¨int8 end; // åŒ zlend ä¸€æ ·ï¼Œæ’ä¸º 0xFF&#125;é¦–å…ˆè¿™ä¸ª listpack è·Ÿ ziplist çš„ç»“æ„å‡ ä¹ä¸€æ‘¸ä¸€æ ·ï¼Œåªæ˜¯å°‘äº†ä¸€ä¸ªzltail_offsetå­—æ®µã€‚ziplist é€šè¿‡è¿™ä¸ªå­—æ®µæ¥å®šä½å‡ºæœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œç”¨äºé€†åºéå†ã€‚ä¸è¿‡ listpack å¯ä»¥é€šè¿‡å…¶å®ƒæ–¹å¼æ¥å®šä½å‡ºæœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œæ‰€ä»¥zltail_offsetå­—æ®µå°±çœæ‰äº†ã€‚12345struct lpentry &#123;int&lt;var&gt; encoding;optional byte[] content;int&lt;var&gt; length;&#125;å…ƒç´ çš„ç»“æ„å’Œ ziplist çš„å…ƒç´ ç»“æ„ä¹Ÿå¾ˆç±»ä¼¼ï¼Œéƒ½æ˜¯åŒ…å«ä¸‰ä¸ªå­—æ®µã€‚ä¸åŒçš„æ˜¯é•¿åº¦å­—æ®µæ”¾åœ¨äº†å…ƒç´ çš„å°¾éƒ¨ï¼Œè€Œä¸”å­˜å‚¨çš„ä¸æ˜¯ä¸Šä¸€ä¸ªå…ƒç´ çš„é•¿åº¦ï¼Œæ˜¯å½“å‰å…ƒç´ çš„é•¿åº¦ã€‚æ­£æ˜¯å› ä¸ºé•¿åº¦æ”¾åœ¨äº†å°¾éƒ¨ï¼Œæ‰€ä»¥å¯ä»¥çœå»äº†zltail_offsetå­—æ®µæ¥æ ‡è®°æœ€åä¸€ä¸ªå…ƒç´ çš„ä½ç½®ï¼Œè¿™ä¸ªä½ç½®å¯ä»¥é€šè¿‡total_byteså­—æ®µå’Œæœ€åä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å­—æ®µè®¡ç®—å‡ºæ¥ã€‚é•¿åº¦å­—æ®µä½¿ç”¨ varint è¿›è¡Œç¼–ç ï¼Œä¸åŒäº skiplist å…ƒç´ é•¿åº¦çš„ç¼–ç ä¸º 1 ä¸ªå­—èŠ‚æˆ–è€… 5 ä¸ªå­—èŠ‚ï¼Œlistpack å…ƒç´ é•¿åº¦çš„ç¼–ç å¯ä»¥æ˜¯ 1ã€2ã€3ã€4ã€5 ä¸ªå­—èŠ‚ã€‚åŒ UTF8 ç¼–ç ä¸€æ ·ï¼Œå®ƒé€šè¿‡å­—èŠ‚çš„æœ€é«˜ä¸ºæ˜¯å¦ä¸º 1 æ¥å†³å®šç¼–ç çš„é•¿åº¦ã€‚åŒæ ·ï¼ŒRedis ä¸ºäº†è®© listpack å…ƒç´ æ”¯æŒå¾ˆå¤šç±»å‹ï¼Œå®ƒå¯¹ encoding å­—æ®µä¹Ÿè¿›è¡Œäº†è¾ƒä¸ºå¤æ‚çš„è®¾è®¡ã€‚0xxxxxxx è¡¨ç¤ºéè´Ÿå°æ•´æ•°ï¼Œå¯ä»¥è¡¨ç¤º0~127ã€‚10xxxxxx è¡¨ç¤ºå°å­—ç¬¦ä¸²ï¼Œé•¿åº¦èŒƒå›´æ˜¯0~63ï¼Œcontentå­—æ®µä¸ºå­—ç¬¦ä¸²çš„å†…å®¹ã€‚110xxxxx yyyyyyyy è¡¨ç¤ºæœ‰ç¬¦å·æ•´æ•°ï¼ŒèŒƒå›´æ˜¯-2048~2047ã€‚1110xxxx yyyyyyyy è¡¨ç¤ºä¸­ç­‰é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œé•¿åº¦èŒƒå›´æ˜¯0~4095ï¼Œcontentå­—æ®µä¸ºå­—ç¬¦ä¸²çš„å†…å®¹ã€‚11110000 aaaaaaaa bbbbbbbb cccccccc dddddddd è¡¨ç¤ºå¤§å­—ç¬¦ä¸²ï¼Œå››ä¸ªå­—èŠ‚è¡¨ç¤ºé•¿åº¦ï¼Œcontentå­—æ®µä¸ºå­—ç¬¦ä¸²å†…å®¹ã€‚11110001 aaaaaaaa bbbbbbbb è¡¨ç¤º 2 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚11110010 aaaaaaaa bbbbbbbb cccccccc è¡¨ç¤º 3 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚11110011 aaaaaaaa bbbbbbbb cccccccc dddddddd è¡¨ç¤º 4 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚11110011 aaaaaaaa â€¦ hhhhhhhh è¡¨ç¤º 8 å­—èŠ‚æœ‰ç¬¦å·æ•´æ•°ã€‚11111111 è¡¨ç¤º listpack çš„ç»“æŸç¬¦å·ï¼Œä¹Ÿå°±æ˜¯0xFFã€‚2. çº§è”æ›´æ–°listpack çš„è®¾è®¡å½»åº•æ¶ˆç­äº† ziplist å­˜åœ¨çš„çº§è”æ›´æ–°è¡Œä¸ºï¼Œå…ƒç´ ä¸å…ƒç´ ä¹‹é—´å®Œå…¨ç‹¬ç«‹ï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ªå…ƒç´ çš„é•¿åº¦å˜é•¿å°±å¯¼è‡´åç»­çš„å…ƒç´ å†…å®¹ä¼šå—åˆ°å½±å“ã€‚3. å–ä»£ ziplistlistpack çš„è®¾è®¡çš„ç›®çš„æ˜¯ç”¨æ¥å–ä»£ ziplistï¼Œä¸è¿‡å½“ä¸‹è¿˜æ²¡æœ‰åšå¥½æ›¿æ¢ ziplist çš„å‡†å¤‡ï¼Œå› ä¸ºæœ‰å¾ˆå¤šå…¼å®¹æ€§çš„é—®é¢˜éœ€è¦è€ƒè™‘ï¼Œziplist åœ¨ Redis æ•°æ®ç»“æ„ä¸­ä½¿ç”¨å¤ªå¹¿æ³›äº†ï¼Œæ›¿æ¢èµ·æ¥å¤æ‚åº¦ä¼šéå¸¸ä¹‹é«˜ã€‚å®ƒç›®å‰åªä½¿ç”¨åœ¨äº†æ–°å¢åŠ çš„ Stream æ•°æ®ç»“æ„ä¸­ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[]},{"title":"Redis è·³è·ƒåˆ—è¡¨ç»“æ„","slug":"Redis-è·³è·ƒåˆ—è¡¨ç»“æ„","date":"2019-06-19T14:29:39.000Z","updated":"2019-06-19T15:30:38.727Z","comments":true,"path":"2019/06/19/Redis-è·³è·ƒåˆ—è¡¨ç»“æ„/","link":"","permalink":"http://localhost:4000/2019/06/19/Redis-è·³è·ƒåˆ—è¡¨ç»“æ„/","excerpt":"","text":"Redis æ·±åº¦å†é™©ï¼šæ ¸å¿ƒåŸç†ä¸åº”ç”¨å®è·µ - è€éŒ¢ - æ˜é‡‘å°å†ŒRedis è·³è·ƒåˆ—è¡¨ç»“æ„1. ç®€ä»‹Redis çš„ zset æ˜¯ä¸€ä¸ªå¤åˆç»“æ„ï¼Œä¸€æ–¹é¢å®ƒéœ€è¦ä¸€ä¸ª hash ç»“æ„æ¥å­˜å‚¨ value å’Œ score çš„å¯¹åº”å…³ç³»ï¼Œå¦ä¸€æ–¹é¢éœ€è¦æä¾›æŒ‰ç…§ score æ¥æ’åºçš„åŠŸèƒ½ï¼Œè¿˜éœ€è¦èƒ½å¤ŸæŒ‡å®š score çš„èŒƒå›´æ¥è·å– value åˆ—è¡¨çš„åŠŸèƒ½ï¼Œè¿™å°±éœ€è¦å¦å¤–ä¸€ä¸ªç»“æ„ã€Œè·³è·ƒåˆ—è¡¨ã€ã€‚zset çš„å†…éƒ¨å®ç°æ˜¯ä¸€ä¸ª hash å­—å…¸åŠ ä¸€ä¸ªè·³è·ƒåˆ—è¡¨ (skiplist)ã€‚hash ç»“æ„åœ¨è®²å­—å…¸ç»“æ„æ—¶å·²ç»è¯¦ç»†åˆ†æè¿‡äº†ï¼Œå®ƒå¾ˆç±»ä¼¼äº Java è¯­è¨€ä¸­çš„ HashMap ç»“æ„ã€‚æœ¬èŠ‚æˆ‘ä»¬æ¥è®²è·³è·ƒåˆ—è¡¨ï¼Œå®ƒæ¯”è¾ƒå¤æ‚ï¼Œè¯»è€…è¦æœ‰å¿ƒç†å‡†å¤‡ã€‚2. åŸºæœ¬ç»“æ„ä¸Šå›¾å°±æ˜¯è·³è·ƒåˆ—è¡¨çš„ç¤ºæ„å›¾ï¼Œå›¾ä¸­åªç”»äº†å››å±‚ï¼ŒRedis çš„è·³è·ƒè¡¨å…±æœ‰ 64 å±‚ï¼Œæ„å‘³ç€æœ€å¤šå¯ä»¥å®¹çº³ 2^64 æ¬¡æ–¹ä¸ªå…ƒç´ ã€‚æ¯ä¸€ä¸ª kv å—å¯¹åº”çš„ç»“æ„å¦‚ä¸‹é¢çš„ä»£ç ä¸­çš„zslnodeç»“æ„ï¼Œkv header ä¹Ÿæ˜¯è¿™ä¸ªç»“æ„ï¼Œåªä¸è¿‡ value å­—æ®µæ˜¯ null å€¼â€”â€”æ— æ•ˆçš„ï¼Œscore æ˜¯ Double.MIN_VALUEï¼Œç”¨æ¥å«åº•çš„ã€‚kv ä¹‹é—´ä½¿ç”¨æŒ‡é’ˆä¸²èµ·æ¥å½¢æˆäº†åŒå‘é“¾è¡¨ç»“æ„ï¼Œå®ƒä»¬æ˜¯ æœ‰åº æ’åˆ—çš„ï¼Œä»å°åˆ°å¤§ã€‚ä¸åŒçš„ kv å±‚é«˜å¯èƒ½ä¸ä¸€æ ·ï¼Œå±‚æ•°è¶Šé«˜çš„ kv è¶Šå°‘ã€‚åŒä¸€å±‚çš„ kv ä¼šä½¿ç”¨æŒ‡é’ˆä¸²èµ·æ¥ã€‚æ¯ä¸€ä¸ªå±‚å…ƒç´ çš„éå†éƒ½æ˜¯ä» kv header å‡ºå‘ã€‚123456789101112struct zslnode &#123;string value;double score;zslnode*[] forwards; // å¤šå±‚è¿æ¥æŒ‡é’ˆzslnode* backward; // å›æº¯æŒ‡é’ˆ&#125;struct zsl &#123;zslnode* header; // è·³è·ƒåˆ—è¡¨å¤´æŒ‡é’ˆint maxLevel; // è·³è·ƒåˆ—è¡¨å½“å‰çš„æœ€é«˜å±‚map&lt;string, zslnode*&gt; ht; // hash ç»“æ„çš„æ‰€æœ‰é”®å€¼å¯¹&#125;3. æŸ¥æ‰¾è¿‡ç¨‹è®¾æƒ³å¦‚æœè·³è·ƒåˆ—è¡¨åªæœ‰ä¸€å±‚ä¼šæ€æ ·ï¼Ÿæ’å…¥åˆ é™¤æ“ä½œéœ€è¦å®šä½åˆ°ç›¸åº”çš„ä½ç½®èŠ‚ç‚¹ (å®šä½åˆ°æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å¤§çš„å…ƒç´ çš„å‰ä¸€ä¸ª)ï¼Œå®šä½çš„æ•ˆç‡è‚¯å®šæ¯”è¾ƒå·®ï¼Œå¤æ‚åº¦å°†ä¼šæ˜¯ O(n)ï¼Œå› ä¸ºéœ€è¦æŒ¨ä¸ªéå†ã€‚ä¹Ÿè®¸ä½ ä¼šæƒ³åˆ°äºŒåˆ†æŸ¥æ‰¾ï¼Œä½†æ˜¯äºŒåˆ†æŸ¥æ‰¾çš„ç»“æ„åªèƒ½æ˜¯æœ‰åºæ•°ç»„ã€‚è·³è·ƒåˆ—è¡¨æœ‰äº†å¤šå±‚ç»“æ„ä¹‹åï¼Œè¿™ä¸ªå®šä½çš„ç®—æ³•å¤æ‚åº¦å°†ä¼šé™åˆ° O(lg(n))ã€‚å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬è¦å®šä½åˆ°é‚£ä¸ªç´«è‰²çš„ kvï¼Œéœ€è¦ä» header çš„æœ€é«˜å±‚å¼€å§‹éå†æ‰¾åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ (æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ )ï¼Œç„¶åä»è¿™ä¸ªèŠ‚ç‚¹å¼€å§‹é™ä¸€å±‚å†éå†æ‰¾åˆ°ç¬¬äºŒä¸ªèŠ‚ç‚¹ (æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ )ï¼Œç„¶åä¸€ç›´é™åˆ°æœ€åº•å±‚è¿›è¡Œéå†å°±æ‰¾åˆ°äº†æœŸæœ›çš„èŠ‚ç‚¹ (æœ€åº•å±‚çš„æœ€åä¸€ä¸ªæ¯”æˆ‘ã€Œå°ã€çš„å…ƒç´ )ã€‚æˆ‘ä»¬å°†ä¸­é—´ç»è¿‡çš„ä¸€ç³»åˆ—èŠ‚ç‚¹ç§°ä¹‹ä¸ºã€Œæœç´¢è·¯å¾„ã€ï¼Œå®ƒæ˜¯ä»æœ€é«˜å±‚ä¸€ç›´åˆ°æœ€åº•å±‚çš„æ¯ä¸€å±‚æœ€åä¸€ä¸ªæ¯”ã€Œæˆ‘ã€å°çš„å…ƒç´ èŠ‚ç‚¹åˆ—è¡¨ã€‚æœ‰äº†è¿™ä¸ªæœç´¢è·¯å¾„ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ’å…¥è¿™ä¸ªæ–°èŠ‚ç‚¹äº†ã€‚ä¸è¿‡è¿™ä¸ªæ’å…¥è¿‡ç¨‹ä¹Ÿä¸æ˜¯ç‰¹åˆ«ç®€å•ã€‚å› ä¸ºæ–°æ’å…¥çš„èŠ‚ç‚¹åˆ°åº•æœ‰å¤šå°‘å±‚ï¼Œå¾—æœ‰ä¸ªç®—æ³•æ¥åˆ†é…ä¸€ä¸‹ï¼Œè·³è·ƒåˆ—è¡¨ä½¿ç”¨çš„æ˜¯éšæœºç®—æ³•ã€‚4. éšæœºå±‚æ•°å¯¹äºæ¯ä¸€ä¸ªæ–°æ’å…¥çš„èŠ‚ç‚¹ï¼Œéƒ½éœ€è¦è°ƒç”¨ä¸€ä¸ªéšæœºç®—æ³•ç»™å®ƒåˆ†é…ä¸€ä¸ªåˆç†çš„å±‚æ•°ã€‚ç›´è§‚ä¸ŠæœŸæœ›çš„ç›®æ ‡æ˜¯ 50% çš„ Level1ï¼Œ25% çš„ Level2ï¼Œ12.5% çš„ Level3ï¼Œä¸€ç›´åˆ°æœ€é¡¶å±‚2^-63ï¼Œå› ä¸ºè¿™é‡Œæ¯ä¸€å±‚çš„æ™‹å‡æ¦‚ç‡æ˜¯ 50%ã€‚12345678910/* Returns a random level for the new skiplist node we are going to create.* The return value of this function is between 1 and ZSKIPLIST_MAXLEVEL* (both inclusive), with a powerlaw-alike distribution where higher* levels are less likely to be returned. */int zslRandomLevel(void) &#123;int level = 1;while ((random()&amp;0xFFFF) &lt; (ZSKIPLIST_P * 0xFFFF))level += 1;return (level&lt;ZSKIPLIST_MAXLEVEL) ? level : ZSKIPLIST_MAXLEVEL;&#125;ä¸è¿‡ Redis æ ‡å‡†æºç ä¸­çš„æ™‹å‡æ¦‚ç‡åªæœ‰ 25%ï¼Œä¹Ÿå°±æ˜¯ä»£ç ä¸­çš„ ZSKIPLIST_P çš„å€¼ã€‚æ‰€ä»¥å®˜æ–¹çš„è·³è·ƒåˆ—è¡¨æ›´åŠ çš„æ‰å¹³åŒ–ï¼Œå±‚é«˜ç›¸å¯¹è¾ƒä½ï¼Œåœ¨å•ä¸ªå±‚ä¸Šéœ€è¦éå†çš„èŠ‚ç‚¹æ•°é‡ä¼šç¨å¤šä¸€ç‚¹ã€‚ä¹Ÿæ­£æ˜¯å› ä¸ºå±‚æ•°ä¸€èˆ¬ä¸é«˜ï¼Œæ‰€ä»¥éå†çš„æ—¶å€™ä»é¡¶å±‚å¼€å§‹å¾€ä¸‹éå†ä¼šéå¸¸æµªè´¹ã€‚è·³è·ƒåˆ—è¡¨ä¼šè®°å½•ä¸€ä¸‹å½“å‰çš„æœ€é«˜å±‚æ•°maxLevelï¼Œéå†æ—¶ä»è¿™ä¸ª maxLevel å¼€å§‹éå†æ€§èƒ½å°±ä¼šæé«˜å¾ˆå¤šã€‚5. æ’å…¥è¿‡ç¨‹ä¸‹é¢æ˜¯æ’å…¥è¿‡ç¨‹çš„æºç ï¼Œå®ƒç¨å¾®æœ‰ç‚¹é•¿ï¼Œä¸è¿‡æ•´ä½“çš„è¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869/* Insert a new node in the skiplist. Assumes the element does not already* exist (up to the caller to enforce that). The skiplist takes ownership* of the passed SDS string 'ele'. */zskiplistNode *zslInsert(zskiplist *zsl, double score, sds ele) &#123;// å­˜å‚¨æœç´¢è·¯å¾„zskiplistNode *update[ZSKIPLIST_MAXLEVEL], *x;// å­˜å‚¨ç»è¿‡çš„èŠ‚ç‚¹è·¨åº¦unsigned int rank[ZSKIPLIST_MAXLEVEL];int i, level;serverAssert(!isnan(score));x = zsl-&gt;header;// é€æ­¥é™çº§å¯»æ‰¾ç›®æ ‡èŠ‚ç‚¹ï¼Œå¾—åˆ°ã€Œæœç´¢è·¯å¾„ã€for (i = zsl-&gt;level-1; i &gt;= 0; i--) &#123;/* store rank that is crossed to reach the insert position */rank[i] = i == (zsl-&gt;level-1) ? 0 : rank[i+1];// å¦‚æœscoreç›¸ç­‰ï¼Œè¿˜éœ€è¦æ¯”è¾ƒvaluewhile (x-&gt;level[i].forward &amp;&amp;(x-&gt;level[i].forward-&gt;score &lt; score ||(x-&gt;level[i].forward-&gt;score == score &amp;&amp;sdscmp(x-&gt;level[i].forward-&gt;ele,ele) &lt; 0)))&#123;rank[i] += x-&gt;level[i].span;x = x-&gt;level[i].forward;&#125;update[i] = x;&#125;// æ­£å¼è¿›å…¥æ’å…¥è¿‡ç¨‹/* we assume the element is not already inside, since we allow duplicated* scores, reinserting the same element should never happen since the* caller of zslInsert() should test in the hash table if the element is* already inside or not. */// éšæœºä¸€ä¸ªå±‚æ•°level = zslRandomLevel();// å¡«å……è·¨åº¦if (level &gt; zsl-&gt;level) &#123;for (i = zsl-&gt;level; i &lt; level; i++) &#123;rank[i] = 0;update[i] = zsl-&gt;header;update[i]-&gt;level[i].span = zsl-&gt;length;&#125;// æ›´æ–°è·³è·ƒåˆ—è¡¨çš„å±‚é«˜zsl-&gt;level = level;&#125;// åˆ›å»ºæ–°èŠ‚ç‚¹x = zslCreateNode(level,score,ele);// é‡æ’ä¸€ä¸‹å‰å‘æŒ‡é’ˆfor (i = 0; i &lt; level; i++) &#123;x-&gt;level[i].forward = update[i]-&gt;level[i].forward;update[i]-&gt;level[i].forward = x;/* update span covered by update[i] as x is inserted here */x-&gt;level[i].span = update[i]-&gt;level[i].span - (rank[0] - rank[i]);update[i]-&gt;level[i].span = (rank[0] - rank[i]) + 1;&#125;/* increment span for untouched levels */for (i = level; i &lt; zsl-&gt;level; i++) &#123;update[i]-&gt;level[i].span++;&#125;// é‡æ’ä¸€ä¸‹åå‘æŒ‡é’ˆx-&gt;backward = (update[0] == zsl-&gt;header) ? NULL : update[0];if (x-&gt;level[0].forward)x-&gt;level[0].forward-&gt;backward = x;elsezsl-&gt;tail = x;zsl-&gt;length++;return x;&#125;é¦–å…ˆæˆ‘ä»¬åœ¨æœç´¢åˆé€‚æ’å…¥ç‚¹çš„è¿‡ç¨‹ä¸­å°†ã€Œæœç´¢è·¯å¾„ã€æ‘¸å‡ºæ¥äº†ï¼Œç„¶åå°±å¯ä»¥å¼€å§‹åˆ›å»ºæ–°èŠ‚ç‚¹äº†ï¼Œåˆ›å»ºçš„æ—¶å€™éœ€è¦ç»™è¿™ä¸ªèŠ‚ç‚¹éšæœºåˆ†é…ä¸€ä¸ªå±‚æ•°ï¼Œå†å°†æœç´¢è·¯å¾„ä¸Šçš„èŠ‚ç‚¹å’Œè¿™ä¸ªæ–°èŠ‚ç‚¹é€šè¿‡å‰å‘åå‘æŒ‡é’ˆä¸²èµ·æ¥ã€‚å¦‚æœåˆ†é…çš„æ–°èŠ‚ç‚¹çš„é«˜åº¦é«˜äºå½“å‰è·³è·ƒåˆ—è¡¨çš„æœ€å¤§é«˜åº¦ï¼Œå°±éœ€è¦æ›´æ–°ä¸€ä¸‹è·³è·ƒåˆ—è¡¨çš„æœ€å¤§é«˜åº¦ã€‚6. åˆ é™¤è¿‡ç¨‹åˆ é™¤è¿‡ç¨‹å’Œæ’å…¥è¿‡ç¨‹ç±»ä¼¼ï¼Œéƒ½éœ€å…ˆæŠŠè¿™ä¸ªã€Œæœç´¢è·¯å¾„ã€æ‰¾å‡ºæ¥ã€‚ç„¶åå¯¹äºæ¯ä¸ªå±‚çš„ç›¸å…³èŠ‚ç‚¹éƒ½é‡æ’ä¸€ä¸‹å‰å‘åå‘æŒ‡é’ˆå°±å¯ä»¥äº†ã€‚åŒæ—¶è¿˜è¦æ³¨æ„æ›´æ–°ä¸€ä¸‹æœ€é«˜å±‚æ•°maxLevelã€‚7. æ›´æ–°è¿‡ç¨‹å½“æˆ‘ä»¬è°ƒç”¨ zadd æ–¹æ³•æ—¶ï¼Œå¦‚æœå¯¹åº”çš„ value ä¸å­˜åœ¨ï¼Œé‚£å°±æ˜¯æ’å…¥è¿‡ç¨‹ã€‚å¦‚æœè¿™ä¸ª value å·²ç»å­˜åœ¨äº†ï¼Œåªæ˜¯è°ƒæ•´ä¸€ä¸‹ score çš„å€¼ï¼Œé‚£å°±éœ€è¦èµ°ä¸€ä¸ªæ›´æ–°çš„æµç¨‹ã€‚å‡è®¾è¿™ä¸ªæ–°çš„ score å€¼ä¸ä¼šå¸¦æ¥æ’åºä½ç½®ä¸Šçš„æ”¹å˜ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è°ƒæ•´ä½ç½®ï¼Œç›´æ¥ä¿®æ”¹å…ƒç´ çš„ score å€¼å°±å¯ä»¥äº†ã€‚ä½†æ˜¯å¦‚æœæ’åºä½ç½®æ”¹å˜äº†ï¼Œé‚£å°±è¦è°ƒæ•´ä½ç½®ã€‚é‚£è¯¥å¦‚ä½•è°ƒæ•´ä½ç½®å‘¢ï¼Ÿ12345678910111213141516/* Remove and re-insert when score changes. */if (score != curscore) &#123;zskiplistNode *node;serverAssert(zslDelete(zs-&gt;zsl,curscore,ele,&amp;node));znode = zslInsert(zs-&gt;zsl,score,node-&gt;ele);/* We reused the node-&gt;ele SDS string, free the node now* since zslInsert created a new one. */node-&gt;ele = NULL;zslFreeNode(node);/* Note that we did not removed the original element from* the hash table representing the sorted set, so we just* update the score. */dictGetVal(de) = &amp;znode-&gt;score; /* Update score ptr. */*flags |= ZADD_UPDATED;&#125;return 1;ä¸€ä¸ªç®€å•çš„ç­–ç•¥å°±æ˜¯å…ˆåˆ é™¤è¿™ä¸ªå…ƒç´ ï¼Œå†æ’å…¥è¿™ä¸ªå…ƒç´ ï¼Œéœ€è¦ç»è¿‡ä¸¤æ¬¡è·¯å¾„æœç´¢ã€‚Redis å°±æ˜¯è¿™ä¹ˆå¹²çš„ã€‚ ä¸è¿‡ Redis é‡åˆ° score å€¼æ”¹å˜äº†å°±ç›´æ¥åˆ é™¤å†æ’å…¥ï¼Œä¸ä¼šå»åˆ¤æ–­ä½ç½®æ˜¯å¦éœ€è¦è°ƒæ•´ï¼Œä»è¿™ç‚¹çœ‹ï¼ŒRedis çš„ zadd çš„ä»£ç ä¼¼ä¹è¿˜æœ‰ä¼˜åŒ–ç©ºé—´ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œè¯»è€…ä»¬å¯ä»¥ç»§ç»­è®¨è®ºã€‚8. å¦‚æœ score å€¼éƒ½ä¸€æ ·å‘¢ï¼Ÿåœ¨ä¸€ä¸ªæç«¯çš„æƒ…å†µä¸‹ï¼Œzset ä¸­æ‰€æœ‰çš„ score å€¼éƒ½æ˜¯ä¸€æ ·çš„ï¼Œzset çš„æŸ¥æ‰¾æ€§èƒ½ä¼šé€€åŒ–ä¸º O(n) ä¹ˆï¼ŸRedis ä½œè€…è‡ªç„¶è€ƒè™‘åˆ°äº†è¿™ä¸€ç‚¹ï¼Œæ‰€ä»¥ zset çš„æ’åºå…ƒç´ ä¸åªçœ‹ score å€¼ï¼Œå¦‚æœ score å€¼ç›¸åŒè¿˜éœ€è¦å†æ¯”è¾ƒ value å€¼ (å­—ç¬¦ä¸²æ¯”è¾ƒ)ã€‚9. å…ƒç´ æ’åæ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿå‰é¢æˆ‘ä»¬å•°å—¦äº†ä¸€å †ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªé‡è¦çš„å±æ€§æ²¡æœ‰æåˆ°ï¼Œé‚£å°±æ˜¯ zset å¯ä»¥è·å–å…ƒç´ çš„æ’å rankã€‚é‚£è¿™ä¸ª rank æ˜¯å¦‚ä½•ç®—å‡ºæ¥çš„ï¼Ÿå¦‚æœä»…ä»…ä½¿ç”¨ä¸Šé¢çš„ç»“æ„ï¼Œrank æ˜¯ä¸èƒ½ç®—å‡ºæ¥çš„ã€‚Redis åœ¨ skiplist çš„ forward æŒ‡é’ˆä¸Šè¿›è¡Œäº†ä¼˜åŒ–ï¼Œç»™æ¯ä¸€ä¸ª forward æŒ‡é’ˆéƒ½å¢åŠ äº† span å±æ€§ï¼Œspan æ˜¯ã€Œè·¨åº¦ã€çš„æ„æ€ï¼Œè¡¨ç¤ºä»å‰ä¸€ä¸ªèŠ‚ç‚¹æ²¿ç€å½“å‰å±‚çš„ forward æŒ‡é’ˆè·³åˆ°å½“å‰è¿™ä¸ªèŠ‚ç‚¹ä¸­é—´ä¼šè·³è¿‡å¤šå°‘ä¸ªèŠ‚ç‚¹ã€‚Redis åœ¨æ’å…¥åˆ é™¤æ“ä½œæ—¶ä¼šå°å¿ƒç¿¼ç¿¼åœ°æ›´æ–° span å€¼çš„å¤§å°ã€‚1234567891011struct zslforward &#123;zslnode* item;long span; // è·¨åº¦&#125;struct zsl &#123;String value;double score;zslforward*[] forwards; // å¤šå±‚è¿æ¥æŒ‡é’ˆzslnode* backward; // å›æº¯æŒ‡é’ˆ&#125;è¿™æ ·å½“æˆ‘ä»¬è¦è®¡ç®—ä¸€ä¸ªå…ƒç´ çš„æ’åæ—¶ï¼Œåªéœ€è¦å°†ã€Œæœç´¢è·¯å¾„ã€ä¸Šçš„ç»è¿‡çš„æ‰€æœ‰èŠ‚ç‚¹çš„è·¨åº¦ span å€¼è¿›è¡Œå åŠ å°±å¯ä»¥ç®—å‡ºå…ƒç´ çš„æœ€ç»ˆ rank å€¼ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[]},{"title":"Redis å¿«é€Ÿåˆ—è¡¨ç»“æ„","slug":"Redis-å¿«é€Ÿåˆ—è¡¨ç»“æ„","date":"2019-06-19T14:24:06.000Z","updated":"2019-06-19T15:30:46.945Z","comments":true,"path":"2019/06/19/Redis-å¿«é€Ÿåˆ—è¡¨ç»“æ„/","link":"","permalink":"http://localhost:4000/2019/06/19/Redis-å¿«é€Ÿåˆ—è¡¨ç»“æ„/","excerpt":"","text":"Redis å¿«é€Ÿåˆ—è¡¨ç»“æ„1. ç®€ä»‹Redis æ—©æœŸç‰ˆæœ¬å­˜å‚¨ list åˆ—è¡¨æ•°æ®ç»“æ„ä½¿ç”¨çš„æ˜¯å‹ç¼©åˆ—è¡¨ ziplist å’Œæ™®é€šçš„åŒå‘é“¾è¡¨ linkedlistï¼Œä¹Ÿå°±æ˜¯å…ƒç´ å°‘æ—¶ç”¨ ziplistï¼Œå…ƒç´ å¤šæ—¶ç”¨ linkedlistã€‚123456789101112// é“¾è¡¨çš„èŠ‚ç‚¹struct listNode&lt;T&gt; &#123;listNode* prev;listNode* next;T value;&#125;// é“¾è¡¨struct list &#123;listNode *head;listNode *tail;long length;&#125;è€ƒè™‘åˆ°é“¾è¡¨çš„é™„åŠ ç©ºé—´ç›¸å¯¹å¤ªé«˜ï¼Œprev å’Œ next æŒ‡é’ˆå°±è¦å å» 16 ä¸ªå­—èŠ‚ (64bit ç³»ç»Ÿçš„æŒ‡é’ˆæ˜¯ 8 ä¸ªå­—èŠ‚)ï¼Œå¦å¤–æ¯ä¸ªèŠ‚ç‚¹çš„å†…å­˜éƒ½æ˜¯å•ç‹¬åˆ†é…ï¼Œä¼šåŠ å‰§å†…å­˜çš„ç¢ç‰‡åŒ–ï¼Œå½±å“å†…å­˜ç®¡ç†æ•ˆç‡ã€‚åç»­ç‰ˆæœ¬å¯¹åˆ—è¡¨æ•°æ®ç»“æ„è¿›è¡Œäº†æ”¹é€ ï¼Œä½¿ç”¨ quicklist ä»£æ›¿äº† ziplist å’Œ linkedlistã€‚1234&gt; rpush codehole go java python(integer) 3&gt; debug object codeholeValue at:0x7fec2dc2bde0 refcount:1 encoding:quicklist serializedlength:31 lru:6101643 lru_seconds_idle:5 ql_nodes:1 ql_avg_node:3.00 ql_ziplist_max:-2 ql_compressed:0 ql_uncompressed_size:29æ³¨æ„è§‚å¯Ÿä¸Šé¢è¾“å‡ºå­—æ®µ encoding çš„å€¼ã€‚quicklist æ˜¯ ziplist å’Œ linkedlist çš„æ··åˆä½“ï¼Œå®ƒå°† linkedlist æŒ‰æ®µåˆ‡åˆ†ï¼Œæ¯ä¸€æ®µä½¿ç”¨ ziplist æ¥ç´§å‡‘å­˜å‚¨ï¼Œå¤šä¸ª ziplist ä¹‹é—´ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²æ¥èµ·æ¥ã€‚123456789101112131415161718192021222324struct ziplist &#123;...&#125;struct ziplist_compressed &#123;int32 size;byte[] compressed_data;&#125;struct quicklistNode &#123;quicklistNode* prev;quicklistNode* next;ziplist* zl; // æŒ‡å‘å‹ç¼©åˆ—è¡¨int32 size; // ziplist çš„å­—èŠ‚æ€»æ•°int16 count; // ziplist ä¸­çš„å…ƒç´ æ•°é‡int2 encoding; // å­˜å‚¨å½¢å¼ 2bitï¼ŒåŸç”Ÿå­—èŠ‚æ•°ç»„è¿˜æ˜¯ LZF å‹ç¼©å­˜å‚¨...&#125;struct quicklist &#123;quicklistNode* head;quicklistNode* tail;long count; // å…ƒç´ æ€»æ•°int nodes; // ziplist èŠ‚ç‚¹çš„ä¸ªæ•°int compressDepth; // LZF ç®—æ³•å‹ç¼©æ·±åº¦...&#125;icklist çš„å¤§è‡´ç»“æ„ã€‚ä¸ºäº†è¿›ä¸€æ­¥èŠ‚çº¦ç©ºé—´ï¼ŒRedis è¿˜ä¼šå¯¹ ziplist è¿›è¡Œå‹ç¼©å­˜å‚¨ï¼Œä½¿ç”¨ LZF ç®—æ³•å‹ç¼©ï¼Œå¯ä»¥é€‰æ‹©å‹ç¼©æ·±åº¦ã€‚2. æ¯ä¸ª ziplist å­˜å¤šå°‘å…ƒç´ ï¼Ÿquicklist å†…éƒ¨é»˜è®¤å•ä¸ª ziplist é•¿åº¦ä¸º 8k å­—èŠ‚ï¼Œè¶…å‡ºäº†è¿™ä¸ªå­—èŠ‚æ•°ï¼Œå°±ä¼šæ–°èµ·ä¸€ä¸ª ziplistã€‚ziplist çš„é•¿åº¦ç”±é…ç½®å‚æ•°list-max-ziplist-sizeå†³å®šã€‚1234567891011121314# Lists are also encoded in a special way to save a lot of space.# The number of entries allowed per internal list node can be specified# as a fixed maximum size or a maximum number of elements.# For a fixed maximum size, use -5 through -1, meaning:# -5: max size: 64 Kb &lt;-- not recommended for normal workloads# -4: max size: 32 Kb &lt;-- not recommended# -3: max size: 16 Kb &lt;-- probably not recommended# -2: max size: 8 Kb &lt;-- good# -1: max size: 4 Kb &lt;-- good# Positive numbers mean store up to _exactly_ that number of elements# per list node.# The highest performing option is usually -2 (8 Kb size) or -1 (4 Kb size),# but if your use case is unique, adjust the settings as necessary.list-max-ziplist-size -23. å‹ç¼©æ·±åº¦quicklist é»˜è®¤çš„å‹ç¼©æ·±åº¦æ˜¯ 0ï¼Œä¹Ÿå°±æ˜¯ä¸å‹ç¼©ã€‚å‹ç¼©çš„å®é™…æ·±åº¦ç”±é…ç½®å‚æ•°list-compress-depthå†³å®šã€‚ä¸ºäº†æ”¯æŒå¿«é€Ÿçš„ push/pop æ“ä½œï¼Œquicklist çš„é¦–å°¾ä¸¤ä¸ª ziplist ä¸å‹ç¼©ï¼Œæ­¤æ—¶æ·±åº¦å°±æ˜¯ 1ã€‚å¦‚æœæ·±åº¦ä¸º 2ï¼Œå°±è¡¨ç¤º quicklist çš„é¦–å°¾ç¬¬ä¸€ä¸ª ziplist ä»¥åŠé¦–å°¾ç¬¬äºŒä¸ª ziplist éƒ½ä¸å‹ç¼©ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[]},{"title":"Redis å‹ç¼©åˆ—è¡¨ç»“æ„","slug":"Redis-å‹ç¼©åˆ—è¡¨ç»“æ„","date":"2019-06-19T13:24:54.000Z","updated":"2019-06-19T15:26:00.641Z","comments":true,"path":"2019/06/19/Redis-å‹ç¼©åˆ—è¡¨ç»“æ„/","link":"","permalink":"http://localhost:4000/2019/06/19/Redis-å‹ç¼©åˆ—è¡¨ç»“æ„/","excerpt":"","text":"Redis å‹ç¼©åˆ—è¡¨ç»“æ„1.ç®€ä»‹Redis ä¸ºäº†èŠ‚çº¦å†…å­˜ç©ºé—´ä½¿ç”¨ï¼Œzset å’Œ hash å®¹å™¨å¯¹è±¡åœ¨å…ƒç´ ä¸ªæ•°è¾ƒå°‘çš„æ—¶å€™ï¼Œé‡‡ç”¨å‹ç¼©åˆ—è¡¨ (ziplist) è¿›è¡Œå­˜å‚¨ã€‚å‹ç¼©åˆ—è¡¨æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå…ƒç´ ä¹‹é—´ç´§æŒ¨ç€å­˜å‚¨ï¼Œæ²¡æœ‰ä»»ä½•å†—ä½™ç©ºéš™ã€‚12345678&gt; zadd programmings 1.0 go 2.0 python 3.0 java(integer) 3&gt; debug object programmingsValue at:0x7fec2de00020 refcount:1 encoding:ziplist serializedlength:36 lru:6022374 lru_seconds_idle:6&gt; hmset books go fast python slow java fastOK&gt; debug object booksValue at:0x7fec2de000c0 refcount:1 encoding:ziplist serializedlength:48 lru:6022478 lru_seconds_idle:1è¿™é‡Œï¼Œæ³¨æ„è§‚å¯Ÿ debug object è¾“å‡ºçš„ encoding å­—æ®µéƒ½æ˜¯ ziplistï¼Œè¿™å°±è¡¨ç¤ºå†…éƒ¨é‡‡ç”¨å‹ç¼©åˆ—è¡¨ç»“æ„è¿›è¡Œå­˜å‚¨ã€‚1234567struct ziplist&lt;T&gt; &#123;int32 zlbytes; // æ•´ä¸ªå‹ç¼©åˆ—è¡¨å ç”¨å­—èŠ‚æ•°int32 zltail_offset; // æœ€åä¸€ä¸ªå…ƒç´ è·ç¦»å‹ç¼©åˆ—è¡¨èµ·å§‹ä½ç½®çš„åç§»é‡ï¼Œç”¨äºå¿«é€Ÿå®šä½åˆ°æœ€åä¸€ä¸ªèŠ‚ç‚¹int16 zllength; // å…ƒç´ ä¸ªæ•°T[] entries; // å…ƒç´ å†…å®¹åˆ—è¡¨ï¼ŒæŒ¨ä¸ªæŒ¨ä¸ªç´§å‡‘å­˜å‚¨int8 zlend; // æ ‡å¿—å‹ç¼©åˆ—è¡¨çš„ç»“æŸï¼Œå€¼æ’ä¸º 0xFF&#125;å‹ç¼©åˆ—è¡¨ä¸ºäº†æ”¯æŒåŒå‘éå†ï¼Œæ‰€ä»¥æ‰ä¼šæœ‰ ztail_offset è¿™ä¸ªå­—æ®µï¼Œç”¨æ¥å¿«é€Ÿå®šä½åˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼Œç„¶åå€’ç€éå†ã€‚entry å—éšç€å®¹çº³çš„å…ƒç´ ç±»å‹ä¸åŒï¼Œä¹Ÿä¼šæœ‰ä¸ä¸€æ ·çš„ç»“æ„ã€‚12345struct entry &#123;int&lt;var&gt; prevlen; // å‰ä¸€ä¸ª entry çš„å­—èŠ‚é•¿åº¦int&lt;var&gt; encoding; // å…ƒç´ ç±»å‹ç¼–ç optional byte[] content; // å…ƒç´ å†…å®¹&#125;å®ƒçš„ prevlen å­—æ®µè¡¨ç¤ºå‰ä¸€ä¸ª entry çš„å­—èŠ‚é•¿åº¦ï¼Œå½“å‹ç¼©åˆ—è¡¨å€’ç€éå†æ—¶ï¼Œéœ€è¦é€šè¿‡è¿™ä¸ªå­—æ®µæ¥å¿«é€Ÿå®šä½åˆ°ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä½ç½®ã€‚å®ƒæ˜¯ä¸€ä¸ªå˜é•¿çš„æ•´æ•°ï¼Œå½“å­—ç¬¦ä¸²é•¿åº¦å°äº 254(0xFE) æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºï¼›å¦‚æœè¾¾åˆ°æˆ–è¶…å‡º 254(0xFE) é‚£å°±ä½¿ç”¨ 5 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯ 0xFE(254)ï¼Œå‰©ä½™å››ä¸ªå­—èŠ‚è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ã€‚ä½ å¯èƒ½ä¼šè§‰å¾—ç”¨ 5 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºå­—ç¬¦ä¸²é•¿åº¦ï¼Œæ˜¯ä¸æ˜¯å¤ªæµªè´¹äº†ã€‚æˆ‘ä»¬å¯ä»¥ç®—ä¸€ä¸‹ï¼Œå½“å­—ç¬¦ä¸²é•¿åº¦æ¯”è¾ƒé•¿çš„æ—¶å€™ï¼Œå…¶å® 5 ä¸ªå­—èŠ‚ä¹Ÿåªå ç”¨äº†ä¸åˆ°(5/(254+5))&lt;2%çš„ç©ºé—´ã€‚encodingå­—æ®µå­˜å‚¨äº†å…ƒç´ å†…å®¹çš„ç¼–ç ç±»å‹ä¿¡æ¯ï¼Œziplist é€šè¿‡è¿™ä¸ªå­—æ®µæ¥å†³å®šåé¢çš„ content å†…å®¹çš„å½¢å¼ã€‚Redis ä¸ºäº†èŠ‚çº¦å­˜å‚¨ç©ºé—´ï¼Œå¯¹ encoding å­—æ®µè¿›è¡Œäº†ç›¸å½“å¤æ‚çš„è®¾è®¡ã€‚Redis é€šè¿‡è¿™ä¸ªå­—æ®µçš„å‰ç¼€ä½æ¥è¯†åˆ«å…·ä½“å­˜å‚¨çš„æ•°æ®å½¢å¼ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹çœ‹ Redis æ˜¯å¦‚ä½•æ ¹æ®encodingçš„å‰ç¼€ä½æ¥åŒºåˆ†å†…å®¹çš„ï¼š00xxxxxx æœ€å¤§é•¿åº¦ä½ 63 çš„çŸ­å­—ç¬¦ä¸²ï¼Œåé¢çš„ 6 ä¸ªä½å­˜å‚¨å­—ç¬¦ä¸²çš„ä½æ•°ï¼Œå‰©ä½™çš„å­—èŠ‚å°±æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹ã€‚01xxxxxx xxxxxxxx ä¸­ç­‰é•¿åº¦çš„å­—ç¬¦ä¸²ï¼Œåé¢ 14 ä¸ªä½æ¥è¡¨ç¤ºå­—ç¬¦ä¸²çš„é•¿åº¦ï¼Œå‰©ä½™çš„å­—èŠ‚å°±æ˜¯å­—ç¬¦ä¸²çš„å†…å®¹ã€‚10000000 aaaaaaaa bbbbbbbb cccccccc dddddddd ç‰¹å¤§å­—ç¬¦ä¸²ï¼Œéœ€è¦ä½¿ç”¨é¢å¤– 4 ä¸ªå­—èŠ‚æ¥è¡¨ç¤ºé•¿åº¦ã€‚ç¬¬ä¸€ä¸ªå­—èŠ‚å‰ç¼€æ˜¯10ï¼Œå‰©ä½™ 6 ä½æ²¡æœ‰ä½¿ç”¨ï¼Œç»Ÿä¸€ç½®ä¸ºé›¶ã€‚åé¢è·Ÿç€å­—ç¬¦ä¸²å†…å®¹ã€‚ä¸è¿‡è¿™æ ·çš„å¤§å­—ç¬¦ä¸²æ˜¯æ²¡æœ‰æœºä¼šä½¿ç”¨çš„ï¼Œå‹ç¼©åˆ—è¡¨é€šå¸¸åªæ˜¯ç”¨æ¥å­˜å‚¨å°æ•°æ®çš„ã€‚11000000 è¡¨ç¤º int16ï¼Œåè·Ÿä¸¤ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚11010000 è¡¨ç¤º int32ï¼Œåè·Ÿå››ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚11100000 è¡¨ç¤º int64ï¼Œåè·Ÿå…­ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚11110000 è¡¨ç¤º int24ï¼Œåè·Ÿä¸‰ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚11111110 è¡¨ç¤º int8ï¼Œåè·Ÿä¸€ä¸ªå­—èŠ‚è¡¨ç¤ºæ•´æ•°ã€‚11111111 è¡¨ç¤º ziplist çš„ç»“æŸï¼Œä¹Ÿå°±æ˜¯ zlend çš„å€¼ 0xFFã€‚1111xxxx è¡¨ç¤ºæå°æ•´æ•°ï¼Œxxxx çš„èŒƒå›´åªèƒ½æ˜¯ (00011101), ä¹Ÿå°±æ˜¯113ï¼Œå› ä¸º0000ã€1110ã€1111éƒ½è¢«å ç”¨äº†ã€‚è¯»å–åˆ°çš„ value éœ€è¦å°† xxxx å‡ 1ï¼Œä¹Ÿå°±æ˜¯æ•´æ•°0~12å°±æ˜¯æœ€ç»ˆçš„ valueã€‚æ³¨æ„åˆ° content å­—æ®µåœ¨ç»“æ„ä½“ä¸­å®šä¹‰ä¸º optional ç±»å‹ï¼Œè¡¨ç¤ºè¿™ä¸ªå­—æ®µæ˜¯å¯é€‰çš„ï¼Œå¯¹äºå¾ˆå°çš„æ•´æ•°è€Œè¨€ï¼Œå®ƒçš„å†…å®¹å·²ç»å†…è”åˆ° encoding å­—æ®µçš„å°¾éƒ¨äº†ã€‚2.å¢åŠ å…ƒç´ å› ä¸º ziplist éƒ½æ˜¯ç´§å‡‘å­˜å‚¨ï¼Œæ²¡æœ‰å†—ä½™ç©ºé—´ (å¯¹æ¯”ä¸€ä¸‹ Redis çš„å­—ç¬¦ä¸²ç»“æ„)ã€‚æ„å‘³ç€æ’å…¥ä¸€ä¸ªæ–°çš„å…ƒç´ å°±éœ€è¦è°ƒç”¨ realloc æ‰©å±•å†…å­˜ã€‚å–å†³äºå†…å­˜åˆ†é…å™¨ç®—æ³•å’Œå½“å‰çš„ ziplist å†…å­˜å¤§å°ï¼Œrealloc å¯èƒ½ä¼šé‡æ–°åˆ†é…æ–°çš„å†…å­˜ç©ºé—´ï¼Œå¹¶å°†ä¹‹å‰çš„å†…å®¹ä¸€æ¬¡æ€§æ‹·è´åˆ°æ–°çš„åœ°å€ï¼Œä¹Ÿå¯èƒ½åœ¨åŸæœ‰çš„åœ°å€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œè¿™æ—¶å°±ä¸éœ€è¦è¿›è¡Œæ—§å†…å®¹çš„å†…å­˜æ‹·è´ã€‚å¦‚æœ ziplist å æ®å†…å­˜å¤ªå¤§ï¼Œé‡æ–°åˆ†é…å†…å­˜å’Œæ‹·è´å†…å­˜å°±ä¼šæœ‰å¾ˆå¤§çš„æ¶ˆè€—ã€‚æ‰€ä»¥ ziplist ä¸é€‚åˆå­˜å‚¨å¤§å‹å­—ç¬¦ä¸²ï¼Œå­˜å‚¨çš„å…ƒç´ ä¹Ÿä¸å®œè¿‡å¤šã€‚3.çº§è”æ›´æ–°123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175/* When an entry is inserted, we need to set the prevlen field of the next\\* entry to equal the length of the inserted entry. It can occur that this\\* length cannot be encoded in 1 byte and the next entry needs to be grow\\* a bit larger to hold the 5-byte encoded prevlen. This can be done for free,\\* because this only happens when an entry is already being inserted (which\\* causes a realloc and memmove). However, encoding the prevlen may require\\* that this entry is grown as well. This effect may cascade throughout\\* the ziplist when there are consecutive entries with a size close to\\* ZIP_BIG_PREVLEN, so we need to check that the prevlen can be encoded in\\* every consecutive entry.*\\* Note that this effect can also happen in reverse, where the bytes required\\* to encode the prevlen field can shrink. This effect is deliberately ignored,\\* because it can cause a \"flapping\" effect where a chain prevlen fields is\\* first grown and then shrunk again after consecutive inserts. Rather, the\\* field is allowed to stay larger than necessary, because a large prevlen\\* field implies the ziplist is holding large entries anyway.*\\* The pointer \"p\" points to the first entry that does NOT need to be\\* updated, i.e. consecutive fields MAY need an update. */**unsigned** **char** *__ziplistCascadeUpdate(**unsigned** **char** *zl, **unsigned** **char** *p) &#123;**size_t** curlen = intrev32ifbe(ZIPLIST_BYTES(zl)), rawlen, rawlensize;**size_t** offset, noffset, extra;**unsigned** **char** *np;zlentry cur, next;**while** (p[0] != ZIP_END) &#123;zipEntry(p, &amp;cur);rawlen = cur.headersize + cur.len;rawlensize = zipStorePrevEntryLength(NULL,rawlen);/* Abort if there is no next entry. */**if** (p[rawlen] == ZIP_END) **break**;zipEntry(p+rawlen, &amp;next);/* Abort when \"prevlen\" has not changed. */// prevlen çš„é•¿åº¦æ²¡æœ‰å˜ï¼Œä¸­æ–­çº§è”æ›´æ–°**if** (next.prevrawlen == rawlen) **break**;**if** (next.prevrawlensize &lt; rawlensize) &#123;/* The \"prevlen\" field of \"next\" needs more bytes to hold\\* the raw length of \"cur\". */// çº§è”æ‰©å±•offset = p-zl;extra = rawlensize-next.prevrawlensize;// æ‰©å¤§å†…å­˜zl = ziplistResize(zl,curlen+extra);p = zl+offset;/* Current pointer and offset for next element. */np = p+rawlen;noffset = np-zl;/* Update tail offset when next element is not the tail element. */// æ›´æ–° zltail_offset æŒ‡é’ˆ**if** ((zl+intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))) != np) &#123;ZIPLIST_TAIL_OFFSET(zl) =intrev32ifbe(intrev32ifbe(ZIPLIST_TAIL_OFFSET(zl))+extra);&#125;/* Move the tail to the back. */// ç§»åŠ¨å†…å­˜memmove(np+rawlensize,np+next.prevrawlensize,curlen-noffset-next.prevrawlensize-1);zipStorePrevEntryLength(np,rawlen);/* Advance the cursor */p += rawlen;curlen += extra;&#125; **else** &#123;**if** (next.prevrawlensize &gt; rawlensize) &#123;/* This would result in shrinking, which we want to avoid.\\* So, set \"rawlen\" in the available bytes. */// çº§è”æ”¶ç¼©ï¼Œä¸è¿‡è¿™é‡Œå¯ä»¥ä¸ç”¨æ”¶ç¼©äº†ï¼Œå› ä¸º 5 ä¸ªå­—èŠ‚ä¹Ÿæ˜¯å¯ä»¥å­˜å‚¨ 1 ä¸ªå­—èŠ‚çš„å†…å®¹çš„// è™½ç„¶æœ‰ç‚¹æµªè´¹ï¼Œä½†æ˜¯çº§è”æ›´æ–°å®åœ¨æ˜¯å¤ªå¯æ€•äº†ï¼Œæ‰€ä»¥æµªè´¹å°±æµªè´¹å§zipStorePrevEntryLengthLarge(p+rawlen,rawlen);&#125; **else** &#123;// å¤§å°æ²¡å˜ï¼Œæ”¹ä¸ªé•¿åº¦å€¼å°±å®Œäº‹äº†zipStorePrevEntryLength(p+rawlen,rawlen);&#125;/* Stop here, as the raw length of \"next\" has not changed. */**break**;&#125;&#125;**return** zl;&#125;å‰é¢æåˆ°æ¯ä¸ª entry éƒ½ä¼šæœ‰ä¸€ä¸ª prevlen å­—æ®µå­˜å‚¨å‰ä¸€ä¸ª entry çš„é•¿åº¦ã€‚å¦‚æœå†…å®¹å°äº 254 å­—èŠ‚ï¼Œprevlen ç”¨ 1 å­—èŠ‚å­˜å‚¨ï¼Œå¦åˆ™å°±æ˜¯ 5 å­—èŠ‚ã€‚è¿™æ„å‘³ç€å¦‚æœæŸä¸ª entry ç»è¿‡äº†ä¿®æ”¹æ“ä½œä» 253 å­—èŠ‚å˜æˆäº† 254 å­—èŠ‚ï¼Œé‚£ä¹ˆå®ƒçš„ä¸‹ä¸€ä¸ª entry çš„ prevlenå­—æ®µå°±è¦æ›´æ–°ï¼Œä» 1 ä¸ªå­—èŠ‚æ‰©å±•åˆ° 5 ä¸ªå­—èŠ‚ï¼›å¦‚æœè¿™ä¸ª entry çš„é•¿åº¦æœ¬æ¥ä¹Ÿæ˜¯ 253 å­—èŠ‚ï¼Œé‚£ä¹ˆåé¢ entry çš„ prevlen å­—æ®µè¿˜å¾—ç»§ç»­æ›´æ–°ã€‚å¦‚æœ ziplist é‡Œé¢æ¯ä¸ª entry æ°å¥½éƒ½å­˜å‚¨äº† 253 å­—èŠ‚çš„å†…å®¹ï¼Œé‚£ä¹ˆç¬¬ä¸€ä¸ª entry å†…å®¹çš„ä¿®æ”¹å°±ä¼šå¯¼è‡´åç»­æ‰€æœ‰ entry çš„çº§è”æ›´æ–°ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒè€—è´¹è®¡ç®—èµ„æºçš„æ“ä½œã€‚åˆ é™¤ä¸­é—´çš„æŸä¸ªèŠ‚ç‚¹ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´çº§è”æ›´æ–°ï¼Œè¯»è€…å¯ä»¥æ€è€ƒä¸€ä¸‹ä¸ºä»€ä¹ˆï¼Ÿ4.IntSet å°æ•´æ•°é›†åˆå½“ set é›†åˆå®¹çº³çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°å¹¶ä¸”å…ƒç´ ä¸ªæ•°è¾ƒå°æ—¶ï¼ŒRedis ä¼šä½¿ç”¨ intset æ¥å­˜å‚¨ç»“åˆå…ƒç´ ã€‚intset æ˜¯ç´§å‡‘çš„æ•°ç»„ç»“æ„ï¼ŒåŒæ—¶æ”¯æŒ 16 ä½ã€32 ä½å’Œ 64 ä½æ•´æ•°ã€‚struct intset{int32 encoding; // å†³å®šæ•´æ•°ä½å®½æ˜¯ 16 ä½ã€32 ä½è¿˜æ˜¯ 64 ä½int32 length; // å…ƒç´ ä¸ªæ•°intcontents; // æ•´æ•°æ•°ç»„ï¼Œå¯ä»¥æ˜¯ 16 ä½ã€32 ä½å’Œ 64 ä½}æ¯•ç«Ÿå®ƒåªæ˜¯ç”¨æ¥å­˜å‚¨å°æ•´æ•°çš„ï¼Œé•¿åº¦ä¸åº”è¯¥å¾ˆé•¿ï¼Œè€Œä¸” encoding åªæœ‰ 16 ä½ã€32 ä½å’Œ 64 ä½ä¸‰ä¸ªç±»å‹ï¼Œç”¨ä¸€ä¸ªå­—èŠ‚å­˜å‚¨å°±ç»°ç»°æœ‰ä½™ã€‚å…³äºè¿™ç‚¹ï¼Œè¯»è€…ä»¬å¯ä»¥è¿›ä¸€æ­¥è®¨è®ºã€‚12345678&gt; sadd codehole 1 2 3(integer) 3&gt; debug object codeholeValue at:0x7fec2dc2bde0 refcount:1 encoding:intset serializedlength:15 lru:6065795 lru_seconds_idle:4&gt; sadd codehole go java python(integer) 3&gt; debug object codeholeValue at:0x7fec2dc2bde0 refcount:1 encoding:hashtable serializedlength:22 lru:6065810 lru_seconds_idle:5æ³¨æ„è§‚å¯Ÿ debug object çš„è¾“å‡ºå­—æ®µ encoding çš„å€¼ï¼Œå¯ä»¥å‘ç°å½“ set é‡Œé¢æ”¾è¿›å»äº†éæ•´æ•°å€¼æ—¶ï¼Œå­˜å‚¨å½¢å¼ç«‹å³ä» intset è½¬å˜æˆäº† hash ç»“æ„ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[{"name":"redis","slug":"redis","permalink":"http://localhost:4000/tags/redis/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://localhost:4000/tags/æ•°æ®ç»“æ„/"}]},{"title":"Redis å­—å…¸ç»“æ„","slug":"Redis-å­—å…¸ç»“æ„","date":"2019-06-19T13:16:10.000Z","updated":"2019-06-19T15:26:00.708Z","comments":true,"path":"2019/06/19/Redis-å­—å…¸ç»“æ„/","link":"","permalink":"http://localhost:4000/2019/06/19/Redis-å­—å…¸ç»“æ„/","excerpt":"","text":"Redis å­—å…¸ç»“æ„1.ç®€ä»‹dict æ˜¯ Redis æœåŠ¡å™¨ä¸­å‡ºç°æœ€ä¸ºé¢‘ç¹çš„å¤åˆå‹æ•°æ®ç»“æ„ï¼Œé™¤äº† hash ç»“æ„çš„æ•°æ®ä¼šç”¨åˆ°å­—å…¸å¤–ï¼Œæ•´ä¸ª Redis æ•°æ®åº“çš„æ‰€æœ‰ key å’Œ value ä¹Ÿç»„æˆäº†ä¸€ä¸ªå…¨å±€å­—å…¸ï¼Œè¿˜æœ‰å¸¦è¿‡æœŸæ—¶é—´çš„ key é›†åˆä¹Ÿæ˜¯ä¸€ä¸ªå­—å…¸ã€‚zset é›†åˆä¸­å­˜å‚¨ value å’Œ score å€¼çš„æ˜ å°„å…³ç³»ä¹Ÿæ˜¯é€šè¿‡ dict ç»“æ„å®ç°çš„ã€‚12345678910struct RedisDb &#123;dict* dict; // all keys key=&gt;valuedict* expires; // all expired keys key=&gt;long(timestamp)...&#125;struct zset &#123;dict *dict; // all values value=&gt;scorezskiplist *zsl;&#125;2.dict å†…éƒ¨ç»“æ„dict ç»“æ„å†…éƒ¨åŒ…å«ä¸¤ä¸ª hashtableï¼Œé€šå¸¸æƒ…å†µä¸‹åªæœ‰ä¸€ä¸ª hashtable æ˜¯æœ‰å€¼çš„ã€‚ä½†æ˜¯åœ¨ dict æ‰©å®¹ç¼©å®¹æ—¶ï¼Œéœ€è¦åˆ†é…æ–°çš„ hashtableï¼Œç„¶åè¿›è¡Œæ¸è¿›å¼æ¬è¿ï¼Œè¿™æ—¶å€™ä¸¤ä¸ª hashtable å­˜å‚¨çš„åˆ†åˆ«æ˜¯æ—§çš„ hashtable å’Œæ–°çš„ hashtableã€‚å¾…æ¬è¿ç»“æŸåï¼Œæ—§çš„ hashtable è¢«åˆ é™¤ï¼Œæ–°çš„ hashtable å–è€Œä»£ä¹‹ã€‚1234struct dict &#123;...dictht ht[2];&#125;æ‰€ä»¥ï¼Œå­—å…¸æ•°æ®ç»“æ„çš„ç²¾åå°±è½åœ¨äº† hashtable ç»“æ„ä¸Šäº†ã€‚hashtable çš„ç»“æ„å’Œ Java çš„ HashMap å‡ ä¹æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯é€šè¿‡åˆ†æ¡¶çš„æ–¹å¼è§£å†³ hash å†²çªã€‚ç¬¬ä¸€ç»´æ˜¯æ•°ç»„ï¼Œç¬¬äºŒç»´æ˜¯é“¾è¡¨ã€‚æ•°ç»„ä¸­å­˜å‚¨çš„æ˜¯ç¬¬äºŒç»´é“¾è¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„æŒ‡é’ˆã€‚1234567891011struct dictEntry &#123;void* key;void* val;dictEntry* next; // é“¾æ¥ä¸‹ä¸€ä¸ª entry&#125;struct dictht &#123;dictEntry** table; // äºŒç»´long size; // ç¬¬ä¸€ç»´æ•°ç»„çš„é•¿åº¦long used; // hash è¡¨ä¸­çš„å…ƒç´ ä¸ªæ•°...&#125;3. æ¸è¿›å¼rehashå¤§å­—å…¸çš„æ‰©å®¹æ˜¯æ¯”è¾ƒè€—æ—¶é—´çš„ï¼Œéœ€è¦é‡æ–°ç”³è¯·æ–°çš„æ•°ç»„ï¼Œç„¶åå°†æ—§å­—å…¸æ‰€æœ‰é“¾è¡¨ä¸­çš„å…ƒç´ é‡æ–°æŒ‚æ¥åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ï¼Œè¿™æ˜¯ä¸€ä¸ªO(n)çº§åˆ«çš„æ“ä½œï¼Œä½œä¸ºå•çº¿ç¨‹çš„Redisè¡¨ç¤ºå¾ˆéš¾æ‰¿å—è¿™æ ·è€—æ—¶çš„è¿‡ç¨‹ã€‚æ­¥å­è¿ˆå¤§äº†ä¼šæ‰¯ç€è›‹ï¼Œæ‰€ä»¥Redisä½¿ç”¨æ¸è¿›å¼rehashå°æ­¥æ¬è¿ã€‚è™½ç„¶æ…¢ä¸€ç‚¹ï¼Œä½†æ˜¯è‚¯å®šå¯ä»¥æ¬å®Œã€‚1234567891011121314151617181920212223242526272829dictEntry *dictAddRaw(dict *d, void *key, dictEntry **existing)&#123;long index;dictEntry *entry;dictht *ht;// è¿™é‡Œè¿›è¡Œå°æ­¥æ¬è¿if (dictIsRehashing(d)) _dictRehashStep(d);/* Get the index of the new element, or -1 if* the element already exists. */if ((index = _dictKeyIndex(d, key, dictHashKey(d,key), existing)) == -1)return NULL;/* Allocate the memory and store the new entry.* Insert the element in top, with the assumption that in a database* system it is more likely that recently added entries are accessed* more frequently. */// å¦‚æœå­—å…¸å¤„äºæ¬è¿è¿‡ç¨‹ä¸­ï¼Œè¦å°†æ–°çš„å…ƒç´ æŒ‚æ¥åˆ°æ–°çš„æ•°ç»„ä¸‹é¢ht = dictIsRehashing(d) ? &amp;d-&gt;ht[1] : &amp;d-&gt;ht[0];entry = zmalloc(sizeof(*entry));entry-&gt;next = ht-&gt;table[index];ht-&gt;table[index] = entry;ht-&gt;used++;/* Set the hash entry fields. */dictSetKey(d, entry, key);return entry;&#125;æ¬è¿æ“ä½œåŸ‹ä¼åœ¨å½“å‰å­—å…¸çš„åç»­æŒ‡ä»¤ä¸­(æ¥è‡ªå®¢æˆ·ç«¯çš„hset/hdelæŒ‡ä»¤ç­‰)ï¼Œä½†æ˜¯æœ‰å¯èƒ½å®¢æˆ·ç«¯é—²ä¸‹æ¥äº†ï¼Œæ²¡æœ‰äº†åç»­æŒ‡ä»¤æ¥è§¦å‘è¿™ä¸ªæ¬è¿ï¼Œé‚£ä¹ˆRediså°±ç½®ä¹‹ä¸ç†äº†ä¹ˆï¼Ÿå½“ç„¶ä¸ä¼šï¼Œä¼˜é›…çš„Redisæ€ä¹ˆå¯èƒ½è®¾è®¡çš„è¿™æ ·æ½¦è‰ã€‚Redisè¿˜ä¼šåœ¨å®šæ—¶ä»»åŠ¡ä¸­å¯¹å­—å…¸è¿›è¡Œä¸»åŠ¨æ¬è¿ã€‚123456789101112131415161718// æœåŠ¡å™¨å®šæ—¶ä»»åŠ¡void databaseCron() &#123;...if (server.activerehashing) &#123;for (j = 0; j &lt; dbs_per_call; j++) &#123;int work_done = incrementallyRehash(rehash_db);if (work_done) &#123;/* If the function did some work, stop here, we'll do* more at the next cron loop. */break;&#125; else &#123;/* If this db didn't need rehash, we'll try the next one. */rehash_db++;rehash_db %= server.dbnum;&#125;&#125;&#125;&#125;4.æŸ¥æ‰¾è¿‡ç¨‹æ’å…¥å’Œåˆ é™¤æ“ä½œéƒ½ä¾èµ–äºæŸ¥æ‰¾ï¼Œå…ˆå¿…é¡»æŠŠå…ƒç´ æ‰¾åˆ°ï¼Œæ‰å¯ä»¥è¿›è¡Œæ•°æ®ç»“æ„çš„ä¿®æ”¹æ“ä½œã€‚hashtable çš„å…ƒç´ æ˜¯åœ¨ç¬¬äºŒç»´çš„é“¾è¡¨ä¸Šï¼Œæ‰€ä»¥é¦–å…ˆæˆ‘ä»¬å¾—æƒ³åŠæ³•å®šä½å‡ºå…ƒç´ åœ¨å“ªä¸ªé“¾è¡¨ä¸Šã€‚12345678910func get(key) &#123;let index = hash_func(key) % size;let entry = table[index];while(entry != NULL) &#123;if entry.key == target &#123;return entry.value;&#125;entry = entry.next;&#125;&#125;å€¼å¾—æ³¨æ„çš„æ˜¯ä»£ç ä¸­çš„hash_funcï¼Œå®ƒä¼šå°† key æ˜ å°„ä¸ºä¸€ä¸ªæ•´æ•°ï¼Œä¸åŒçš„ key ä¼šè¢«æ˜ å°„æˆåˆ†å¸ƒæ¯”è¾ƒå‡åŒ€æ•£ä¹±çš„æ•´æ•°ã€‚åªæœ‰ hash å€¼å‡åŒ€äº†ï¼Œæ•´ä¸ª hashtable æ‰æ˜¯å¹³è¡¡çš„ï¼Œæ‰€æœ‰çš„äºŒç»´é“¾è¡¨çš„é•¿åº¦å°±ä¸ä¼šå·®è·å¾ˆè¿œï¼ŒæŸ¥æ‰¾ç®—æ³•çš„æ€§èƒ½ä¹Ÿå°±æ¯”è¾ƒç¨³å®šã€‚5. hash å‡½æ•°hashtable çš„æ€§èƒ½å¥½ä¸å¥½å®Œå…¨å–å†³äº hash å‡½æ•°çš„è´¨é‡ã€‚hash å‡½æ•°å¦‚æœå¯ä»¥å°† key æ‰“æ•£çš„æ¯”è¾ƒå‡åŒ€ï¼Œé‚£ä¹ˆè¿™ä¸ª hash å‡½æ•°å°±æ˜¯ä¸ªå¥½å‡½æ•°ã€‚Redis çš„å­—å…¸é»˜è®¤çš„ hash å‡½æ•°æ˜¯ siphashã€‚siphash ç®—æ³•å³ä½¿åœ¨è¾“å…¥ key å¾ˆå°çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¯ä»¥äº§ç”Ÿéšæœºæ€§ç‰¹åˆ«å¥½çš„è¾“å‡ºï¼Œè€Œä¸”å®ƒçš„æ€§èƒ½ä¹Ÿéå¸¸çªå‡ºã€‚å¯¹äº Redis è¿™æ ·çš„å•çº¿ç¨‹æ¥è¯´ï¼Œå­—å…¸æ•°æ®ç»“æ„å¦‚æ­¤æ™®éï¼Œå­—å…¸æ“ä½œä¹Ÿä¼šéå¸¸é¢‘ç¹ï¼Œhash å‡½æ•°è‡ªç„¶ä¹Ÿæ˜¯è¶Šå¿«è¶Šå¥½ã€‚6.hash æ”»å‡»å¦‚æœ hash å‡½æ•°å­˜åœ¨åå‘æ€§ï¼Œé»‘å®¢å°±å¯èƒ½åˆ©ç”¨è¿™ç§åå‘æ€§å¯¹æœåŠ¡å™¨è¿›è¡Œæ”»å‡»ã€‚å­˜åœ¨åå‘æ€§çš„ hash å‡½æ•°åœ¨ç‰¹å®šæ¨¡å¼ä¸‹çš„è¾“å…¥ä¼šå¯¼è‡´ hash ç¬¬äºŒç»´é“¾è¡¨é•¿åº¦æä¸ºä¸å‡åŒ€ï¼Œç”šè‡³æ‰€æœ‰çš„å…ƒç´ éƒ½é›†ä¸­åˆ°ä¸ªåˆ«é“¾è¡¨ä¸­ï¼Œç›´æ¥å¯¼è‡´æŸ¥æ‰¾æ•ˆç‡æ€¥å‰§ä¸‹é™ï¼Œä»O(1)é€€åŒ–åˆ°O(n)ã€‚æœ‰é™çš„æœåŠ¡å™¨è®¡ç®—èƒ½åŠ›å°†ä¼šè¢« hashtable çš„æŸ¥æ‰¾æ•ˆç‡å½»åº•æ‹–å®ã€‚è¿™å°±æ˜¯æ‰€è°“ hash æ”»å‡»ã€‚7.æ‰©å®¹æ¡ä»¶123456789101112131415161718192021/* Expand the hash table if needed */static int _dictExpandIfNeeded(dict *d)&#123;/* Incremental rehashing already in progress. Return. */if (dictIsRehashing(d)) return DICT_OK;/* If the hash table is empty expand it to the initial size. */if (d-&gt;ht[0].size == 0) return dictExpand(d, DICT_HT_INITIAL_SIZE);/* If we reached the 1:1 ratio, and we are allowed to resize the hash* table (global setting) or we should avoid it but the ratio between* elements/buckets is over the \"safe\" threshold, we resize doubling* the number of buckets. */if (d-&gt;ht[0].used &gt;= d-&gt;ht[0].size &amp;&amp;(dict_can_resize ||d-&gt;ht[0].used/d-&gt;ht[0].size &gt; dict_force_resize_ratio))&#123;return dictExpand(d, d-&gt;ht[0].used*2);&#125;return DICT_OK;&#125;æ­£å¸¸æƒ…å†µä¸‹ï¼Œå½“ hash è¡¨ä¸­å…ƒç´ çš„ä¸ªæ•°ç­‰äºç¬¬ä¸€ç»´æ•°ç»„çš„é•¿åº¦æ—¶ï¼Œå°±ä¼šå¼€å§‹æ‰©å®¹ï¼Œæ‰©å®¹çš„æ–°æ•°ç»„æ˜¯åŸæ•°ç»„å¤§å°çš„ 2 å€ã€‚ä¸è¿‡å¦‚æœ Redis æ­£åœ¨åš bgsaveï¼Œä¸ºäº†å‡å°‘å†…å­˜é¡µçš„è¿‡å¤šåˆ†ç¦» (Copy On Write)ï¼ŒRedis å°½é‡ä¸å»æ‰©å®¹ (dict_can_resize)ï¼Œä½†æ˜¯å¦‚æœ hash è¡¨å·²ç»éå¸¸æ»¡äº†ï¼Œå…ƒç´ çš„ä¸ªæ•°å·²ç»è¾¾åˆ°äº†ç¬¬ä¸€ç»´æ•°ç»„é•¿åº¦çš„ 5 å€ (dict_force_resize_ratio)ï¼Œè¯´æ˜ hash è¡¨å·²ç»è¿‡äºæ‹¥æŒ¤äº†ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šå¼ºåˆ¶æ‰©å®¹ã€‚8.ç¼©å®¹æ¡ä»¶12345678int htNeedsResize(dict *dict) &#123;long long size, used;size = dictSlots(dict);used = dictSize(dict);return (size &gt; DICT_HT_INITIAL_SIZE &amp;&amp;(used*100/size &lt; HASHTABLE_MIN_FILL));&#125;å½“ hash è¡¨å› ä¸ºå…ƒç´ çš„é€æ¸åˆ é™¤å˜å¾—è¶Šæ¥è¶Šç¨€ç–æ—¶ï¼ŒRedis ä¼šå¯¹ hash è¡¨è¿›è¡Œç¼©å®¹æ¥å‡å°‘ hash è¡¨çš„ç¬¬ä¸€ç»´æ•°ç»„ç©ºé—´å ç”¨ã€‚ç¼©å®¹çš„æ¡ä»¶æ˜¯å…ƒç´ ä¸ªæ•°ä½äºæ•°ç»„é•¿åº¦çš„ 10%ã€‚ç¼©å®¹ä¸ä¼šè€ƒè™‘ Redis æ˜¯å¦æ­£åœ¨åš bgsaveã€‚9.set çš„ç»“æ„Redis é‡Œé¢ set çš„ç»“æ„åº•å±‚å®ç°ä¹Ÿæ˜¯å­—å…¸ï¼Œåªä¸è¿‡æ‰€æœ‰çš„ value éƒ½æ˜¯ NULLï¼Œå…¶å®ƒçš„ç‰¹æ€§å’Œå­—å…¸ä¸€æ¨¡ä¸€æ ·ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[{"name":"redis","slug":"redis","permalink":"http://localhost:4000/tags/redis/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://localhost:4000/tags/æ•°æ®ç»“æ„/"},{"name":"å­—å…¸","slug":"å­—å…¸","permalink":"http://localhost:4000/tags/å­—å…¸/"}]},{"title":"Redis å­—ç¬¦ä¸²ç»“æ„","slug":"Redis-å­—ç¬¦ä¸²ç»“æ„","date":"2019-06-19T13:11:22.000Z","updated":"2019-06-19T15:59:18.699Z","comments":true,"path":"2019/06/19/Redis-å­—ç¬¦ä¸²ç»“æ„/","link":"","permalink":"http://localhost:4000/2019/06/19/Redis-å­—ç¬¦ä¸²ç»“æ„/","excerpt":"","text":"Redis å­—ç¬¦ä¸²ç»“æ„1.ç®€ä»‹redis ä¸­çš„å­—ç¬¦ä¸²æ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œåœ¨å†…å­˜ä¸­å®ƒæ˜¯ä»¥å­—èŠ‚æ•°ç»„çš„å½¢å¼å­˜åœ¨çš„ã€‚æˆ‘ä»¬çŸ¥é“ C è¯­è¨€é‡Œé¢çš„å­—ç¬¦ä¸²æ ‡å‡†å½¢å¼æ˜¯ä»¥ NULL ä½œä¸ºç»“æŸç¬¦ï¼Œä½†æ˜¯åœ¨ Redis é‡Œé¢å­—ç¬¦ä¸²ä¸æ˜¯è¿™ä¹ˆè¡¨ç¤ºçš„ã€‚å› ä¸ºè¦è·å– NULL ç»“å°¾çš„å­—ç¬¦ä¸²çš„é•¿åº¦ä½¿ç”¨çš„æ˜¯ strlen æ ‡å‡†åº“å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ç®—æ³•å¤æ‚åº¦æ˜¯ O(n)ï¼Œå®ƒéœ€è¦å¯¹å­—èŠ‚æ•°ç»„è¿›è¡Œéå†æ‰«æï¼Œä½œä¸ºå•çº¿ç¨‹çš„ Redis è¡¨ç¤ºæ‰¿å—ä¸èµ·ã€‚redis ä¸­çš„å­—ç¬¦ä¸²æ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œåœ¨å†…å­˜ä¸­å®ƒæ˜¯ä»¥å­—èŠ‚æ•°ç»„çš„å½¢å¼å­˜åœ¨çš„ã€‚æˆ‘ä»¬çŸ¥é“ C è¯­è¨€é‡Œé¢çš„å­—ç¬¦ä¸²æ ‡å‡†å½¢å¼æ˜¯ä»¥ NULL ä½œä¸ºç»“æŸç¬¦ï¼Œä½†æ˜¯åœ¨ Redis é‡Œé¢å­—ç¬¦ä¸²ä¸æ˜¯è¿™ä¹ˆè¡¨ç¤ºçš„ã€‚å› ä¸ºè¦è·å– NULL ç»“å°¾çš„å­—ç¬¦ä¸²çš„é•¿åº¦ä½¿ç”¨çš„æ˜¯ strlen æ ‡å‡†åº“å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°çš„ç®—æ³•å¤æ‚åº¦æ˜¯ O(n)ï¼Œå®ƒéœ€è¦å¯¹å­—èŠ‚æ•°ç»„è¿›è¡Œéå†æ‰«æï¼Œä½œä¸ºå•çº¿ç¨‹çš„ Redis è¡¨ç¤ºæ‰¿å—ä¸èµ·ã€‚2.å†…éƒ¨ç»“æ„Redis çš„å­—ç¬¦ä¸²å«ç€ã€ŒSDSã€ï¼Œä¹Ÿå°±æ˜¯Simple Dynamic Stringã€‚å®ƒçš„ç»“æ„æ˜¯ä¸€ä¸ªå¸¦é•¿åº¦ä¿¡æ¯çš„å­—èŠ‚æ•°ç»„ã€‚123456struct SDS&lt;T&gt; &#123;T capacity; // æ•°ç»„å®¹é‡T len; // æ•°ç»„é•¿åº¦byte flags; // ç‰¹æ®Šæ ‡è¯†ä½ï¼Œä¸ç†ç¬å®ƒbyte[] content; // æ•°ç»„å†…å®¹&#125;å¦‚ä»£ç æ‰€ç¤ºï¼Œcontent é‡Œé¢å­˜å‚¨äº†çœŸæ­£çš„å­—ç¬¦ä¸²å†…å®¹ï¼Œé‚£ capacity å’Œ len è¡¨ç¤ºä»€ä¹ˆæ„æ€å‘¢ï¼Ÿå®ƒæœ‰ç‚¹ç±»ä¼¼äº Java è¯­è¨€çš„ ArrayList ç»“æ„ï¼Œéœ€è¦æ¯”å®é™…çš„å†…å®¹é•¿åº¦å¤šåˆ†é…ä¸€äº›å†—ä½™ç©ºé—´ã€‚capacity è¡¨ç¤ºæ‰€åˆ†é…æ•°ç»„çš„é•¿åº¦ï¼Œlen è¡¨ç¤ºå­—ç¬¦ä¸²çš„å®é™…é•¿åº¦ã€‚å‰é¢æˆ‘ä»¬æåˆ°å­—ç¬¦ä¸²æ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå®ƒè¦æ”¯æŒ append æ“ä½œã€‚å¦‚æœæ•°ç»„æ²¡æœ‰å†—ä½™ç©ºé—´ï¼Œé‚£ä¹ˆè¿½åŠ æ“ä½œå¿…ç„¶æ¶‰åŠåˆ°åˆ†é…æ–°æ•°ç»„ï¼Œç„¶åå°†æ—§å†…å®¹å¤åˆ¶è¿‡æ¥ï¼Œå† append æ–°å†…å®¹ã€‚å¦‚æœå­—ç¬¦ä¸²çš„é•¿åº¦éå¸¸é•¿ï¼Œè¿™æ ·çš„å†…å­˜åˆ†é…å’Œå¤åˆ¶å¼€é”€å°±ä¼šéå¸¸å¤§ã€‚12345678910111213141516/* Append the specified binary-safe string pointed by 't' of 'len' bytes to the* end of the specified sds string 's'.** After the call, the passed sds string is no longer valid and all the* references must be substituted with the new pointer returned by the call. */sds sdscatlen(sds s, const void *t, size_t len) &#123;size_t curlen = sdslen(s); // åŸå­—ç¬¦ä¸²é•¿åº¦// æŒ‰éœ€è°ƒæ•´ç©ºé—´ï¼Œå¦‚æœ capacity ä¸å¤Ÿå®¹çº³è¿½åŠ çš„å†…å®¹ï¼Œå°±ä¼šé‡æ–°åˆ†é…å­—èŠ‚æ•°ç»„å¹¶å¤åˆ¶åŸå­—ç¬¦ä¸²çš„å†…å®¹åˆ°æ–°æ•°ç»„ä¸­s = sdsMakeRoomFor(s,len);if (s == NULL) return NULL; // å†…å­˜ä¸è¶³memcpy(s+curlen, t, len); // è¿½åŠ ç›®æ ‡å­—ç¬¦ä¸²çš„å†…å®¹åˆ°å­—èŠ‚æ•°ç»„ä¸­sdssetlen(s, curlen+len); // è®¾ç½®è¿½åŠ åçš„é•¿åº¦å€¼s[curlen+len] = '\\0'; // è®©å­—ç¬¦ä¸²ä»¥\\0 ç»“å°¾ï¼Œä¾¿äºè°ƒè¯•æ‰“å°ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ glibc çš„å­—ç¬¦ä¸²å‡½æ•°è¿›è¡Œæ“ä½œreturn s;&#125;ä¸Šé¢çš„ SDS ç»“æ„ä½¿ç”¨äº†èŒƒå‹ Tï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ int å‘¢ï¼Œè¿™æ˜¯å› ä¸ºå½“å­—ç¬¦ä¸²æ¯”è¾ƒçŸ­æ—¶ï¼Œlen å’Œ capacity å¯ä»¥ä½¿ç”¨ byte å’Œ short æ¥è¡¨ç¤ºï¼ŒRedis ä¸ºäº†å¯¹å†…å­˜åšæè‡´çš„ä¼˜åŒ–ï¼Œä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ä½¿ç”¨ä¸åŒçš„ç»“æ„ä½“æ¥è¡¨ç¤ºã€‚Redis è§„å®šå­—ç¬¦ä¸²çš„é•¿åº¦ä¸å¾—è¶…è¿‡ 512M å­—èŠ‚ã€‚åˆ›å»ºå­—ç¬¦ä¸²æ—¶ len å’Œ capacity ä¸€æ ·é•¿ï¼Œä¸ä¼šå¤šåˆ†é…å†—ä½™ç©ºé—´ï¼Œè¿™æ˜¯å› ä¸ºç»å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬ä¸ä¼šä½¿ç”¨ append æ“ä½œæ¥ä¿®æ”¹å­—ç¬¦ä¸²ã€‚3.å­˜å‚¨æ–¹å¼Redis çš„å­—ç¬¦ä¸²æœ‰ä¸¤ç§å­˜å‚¨æ–¹å¼ï¼Œåœ¨é•¿åº¦ç‰¹åˆ«çŸ­æ—¶ï¼Œä½¿ç”¨ emb å½¢å¼å­˜å‚¨ (embeded)ï¼Œå½“é•¿åº¦è¶…è¿‡ 44 æ—¶ï¼Œä½¿ç”¨ raw å½¢å¼å­˜å‚¨ã€‚è¿™ä¸¤ç§ç±»å‹æœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä¸ºä»€ä¹ˆåˆ†ç•Œçº¿æ˜¯ 44 å‘¢ï¼Ÿ12345678&gt; set codehole abcdefghijklmnopqrstuvwxyz012345678912345678OK&gt; debug object codeholeValue at:0x7fec2de00370 refcount:1 encoding:embstr serializedlength:45 lru:5958906 lru_seconds_idle:1&gt; set codehole abcdefghijklmnopqrstuvwxyz0123456789123456789OK&gt; debug object codeholeValue at:0x7fec2dd0b750 refcount:1 encoding:raw serializedlength:46 lru:5958911 lru_seconds_idle:1æ³¨æ„ä¸Šé¢ debug object è¾“å‡ºä¸­æœ‰ä¸ª encoding å­—æ®µï¼Œä¸€ä¸ªå­—ç¬¦çš„å·®åˆ«ï¼Œå­˜å‚¨å½¢å¼å°±å‘ç”Ÿäº†å˜åŒ–ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿä¸ºäº†è§£é‡Šè¿™ç§ç°è±¡ï¼Œæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ Redis å¯¹è±¡å¤´ç»“æ„ä½“ï¼Œæ‰€æœ‰çš„ Redis å¯¹è±¡éƒ½æœ‰ä¸‹é¢çš„è¿™ä¸ªç»“æ„å¤´:1234567struct RedisObject &#123;int4 type; // 4bitsint4 encoding; // 4bitsint24 lru; // 24bitsint32 refcount; // 4bytesvoid *ptr; // 8bytesï¼Œ64-bit system&#125; robj;ä¸åŒçš„å¯¹è±¡å…·æœ‰ä¸åŒçš„ç±»å‹ type(4bit)ï¼ŒåŒä¸€ä¸ªç±»å‹çš„ type ä¼šæœ‰ä¸åŒçš„å­˜å‚¨å½¢å¼ encoding(4bit)ï¼Œä¸ºäº†è®°å½•å¯¹è±¡çš„ LRU ä¿¡æ¯ï¼Œä½¿ç”¨äº† 24 ä¸ª bit æ¥è®°å½• LRU ä¿¡æ¯ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸ºé›¶æ—¶ï¼Œå¯¹è±¡å°±ä¼šè¢«é”€æ¯ï¼Œå†…å­˜è¢«å›æ”¶ã€‚ptræŒ‡é’ˆå°†æŒ‡å‘å¯¹è±¡å†…å®¹ (body) çš„å…·ä½“å­˜å‚¨ä½ç½®ã€‚è¿™æ ·ä¸€ä¸ª RedisObject å¯¹è±¡å¤´éœ€è¦å æ® 16 å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚æ¥ç€æˆ‘ä»¬å†çœ‹ SDS ç»“æ„ä½“çš„å¤§å°ï¼Œåœ¨å­—ç¬¦ä¸²æ¯”è¾ƒå°æ—¶ï¼ŒSDS å¯¹è±¡å¤´çš„å¤§å°æ˜¯capacity+3ï¼Œè‡³å°‘æ˜¯ 3ã€‚æ„å‘³ç€åˆ†é…ä¸€ä¸ªå­—ç¬¦ä¸²çš„æœ€å°ç©ºé—´å ç”¨ä¸º 19 å­—èŠ‚ (16+3)ã€‚123456struct SDS &#123;int8 capacity; // 1byteint8 len; // 1byteint8 flags; // 1bytebyte[] content; // å†…è”æ•°ç»„ï¼Œé•¿åº¦ä¸º capacity&#125;å¦‚å›¾æ‰€ç¤ºï¼Œembstr å­˜å‚¨å½¢å¼æ˜¯è¿™æ ·ä¸€ç§å­˜å‚¨å½¢å¼ï¼Œå®ƒå°† RedisObject å¯¹è±¡å¤´å’Œ SDS å¯¹è±¡è¿ç»­å­˜åœ¨ä¸€èµ·ï¼Œä½¿ç”¨ malloc æ–¹æ³•ä¸€æ¬¡åˆ†é…ã€‚è€Œ raw å­˜å‚¨å½¢å¼ä¸ä¸€æ ·ï¼Œå®ƒéœ€è¦ä¸¤æ¬¡ mallocï¼Œä¸¤ä¸ªå¯¹è±¡å¤´åœ¨å†…å­˜åœ°å€ä¸Šä¸€èˆ¬æ˜¯ä¸è¿ç»­çš„ã€‚è€Œå†…å­˜åˆ†é…å™¨ jemalloc/tcmalloc ç­‰åˆ†é…å†…å­˜å¤§å°çš„å•ä½éƒ½æ˜¯ 2ã€4ã€8ã€16ã€32ã€64 ç­‰ç­‰ï¼Œä¸ºäº†èƒ½å®¹çº³ä¸€ä¸ªå®Œæ•´çš„ embstr å¯¹è±¡ï¼Œjemalloc æœ€å°‘ä¼šåˆ†é… 32 å­—èŠ‚çš„ç©ºé—´ï¼Œå¦‚æœå­—ç¬¦ä¸²å†ç¨å¾®é•¿ä¸€ç‚¹ï¼Œé‚£å°±æ˜¯ 64 å­—èŠ‚çš„ç©ºé—´ã€‚å¦‚æœæ€»ä½“è¶…å‡ºäº† 64 å­—èŠ‚ï¼ŒRedis è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¤§å­—ç¬¦ä¸²ï¼Œä¸å†ä½¿ç”¨ emdstr å½¢å¼å­˜å‚¨ï¼Œè€Œè¯¥ç”¨ raw å½¢å¼ã€‚å½“å†…å­˜åˆ†é…å™¨åˆ†é…äº† 64 ç©ºé—´æ—¶ï¼Œé‚£è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æœ€å¤§å¯ä»¥æ˜¯å¤šå°‘å‘¢ï¼Ÿè¿™ä¸ªé•¿åº¦å°±æ˜¯ 44ã€‚é‚£ä¸ºä»€ä¹ˆæ˜¯ 44 å‘¢ï¼Ÿå‰é¢æˆ‘ä»¬æåˆ° SDS ç»“æ„ä½“ä¸­çš„ content ä¸­çš„å­—ç¬¦ä¸²æ˜¯ä»¥å­—èŠ‚\\0ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œä¹‹æ‰€ä»¥å¤šå‡ºè¿™æ ·ä¸€ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸ºäº†ä¾¿äºç›´æ¥ä½¿ç”¨ glibc çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œä»¥åŠä¸ºäº†ä¾¿äºå­—ç¬¦ä¸²çš„è°ƒè¯•æ‰“å°è¾“å‡ºã€‚çœ‹ä¸Šé¢è¿™å¼ å›¾å¯ä»¥ç®—å‡ºï¼Œç•™ç»™ content çš„é•¿åº¦æœ€å¤šåªæœ‰ 45(64-19) å­—èŠ‚äº†ã€‚å­—ç¬¦ä¸²åˆæ˜¯ä»¥\\0ç»“å°¾ï¼Œæ‰€ä»¥ embstr æœ€å¤§èƒ½å®¹çº³çš„å­—ç¬¦ä¸²é•¿åº¦å°±æ˜¯ 44ã€‚4.æ‰©å®¹ç­–ç•¥å­—ç¬¦ä¸²åœ¨é•¿åº¦å°äº 1M ä¹‹å‰ï¼Œæ‰©å®¹ç©ºé—´é‡‡ç”¨åŠ å€ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¿ç•™ 100% çš„å†—ä½™ç©ºé—´ã€‚å½“é•¿åº¦è¶…è¿‡ 1M ä¹‹åï¼Œä¸ºäº†é¿å…åŠ å€åçš„å†—ä½™ç©ºé—´è¿‡å¤§è€Œå¯¼è‡´æµªè´¹ï¼Œæ¯æ¬¡æ‰©å®¹åªä¼šå¤šåˆ†é… 1M å¤§å°çš„å†—ä½™ç©ºé—´ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[{"name":"redis","slug":"redis","permalink":"http://localhost:4000/tags/redis/"},{"name":"æ•°æ®ç»“æ„","slug":"æ•°æ®ç»“æ„","permalink":"http://localhost:4000/tags/æ•°æ®ç»“æ„/"}]},{"title":"Redis æºç å†…éƒ¨ç»“æ„ç»¼è¿°","slug":"Redis-æºç å†…éƒ¨ç»“æ„ç»¼è¿°","date":"2019-06-18T14:03:31.000Z","updated":"2019-06-19T15:54:38.888Z","comments":true,"path":"2019/06/18/Redis-æºç å†…éƒ¨ç»“æ„ç»¼è¿°/","link":"","permalink":"http://localhost:4000/2019/06/18/Redis-æºç å†…éƒ¨ç»“æ„ç»¼è¿°/","excerpt":"","text":"Redis æºç å†…éƒ¨ç»“æ„ç»¼è¿°1.ç®€ä»‹Redis å’Œå…¶ä»–å¾ˆå¤škey-valueæ•°æ®åº“çš„ä¸åŒä¹‹å¤„åœ¨äºï¼ŒRedisä¸ä»…æ”¯æŒç®€å•çš„å­—ç¬¦ä¸²é”®å€¼å¯¹ï¼Œå®ƒè¿˜æä¾›äº†ä¸€ç³»åˆ—æ•°æ®ç»“æ„ç±»å‹å€¼ï¼Œæ¯”å¦‚åˆ—è¡¨ã€å“ˆå¸Œã€é›†åˆå’Œæœ‰åºé›†ï¼Œå¹¶åœ¨è¿™äº›æ•°æ®ç»“æ„ç±»å‹ä¸Šå®šä¹‰äº†ä¸€å¥—å¼ºå¤§çš„API ã€‚åœ¨Redisçš„å†…éƒ¨ï¼Œæ•°æ®ç»“æ„ç±»å‹å€¼ç”±é«˜æ•ˆçš„æ•°æ®ç»“æ„å’Œç®—æ³•è¿›è¡Œæ”¯æŒï¼Œå¹¶ä¸”åœ¨Redis è‡ªèº«çš„æ„å»ºå½“ä¸­ï¼Œä¹Ÿå¤§é‡ç”¨åˆ°äº†è¿™äº›æ•°æ®ç»“æ„ã€‚ä¸»è¦æœ‰å­—ç¬¦ä¸²ã€å­—å…¸ã€å‹ç¼©åˆ—è¡¨ã€å¿«é€Ÿåˆ—è¡¨ã€è·³è·ƒè¡¨ã€ç´§å‡‘åˆ—è¡¨å’ŒåŸºæ•°æ ‘ã€‚2.å†…éƒ¨ç»“æ„å…·ä½“åˆ†æç³»åˆ—æ–‡ç« åˆ—è¡¨Redis å­—ç¬¦ä¸²ç»“æ„Redis å­—å…¸ç»“æ„Redis å¿«é€Ÿåˆ—è¡¨ç»“æ„Redis å‹ç¼©åˆ—è¡¨ç»“æ„Redis è·³è·ƒåˆ—è¡¨ç»“æ„Redis ç´§å‡‘åˆ—è¡¨ç»“æ„Redis åŸºæ•°æ ‘","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"æºç ","slug":"Redis/æºç ","permalink":"http://localhost:4000/categories/Redis/æºç /"}],"tags":[{"name":"redis","slug":"redis","permalink":"http://localhost:4000/tags/redis/"},{"name":"æºç ","slug":"æºç ","permalink":"http://localhost:4000/tags/æºç /"}]},{"title":"Redis åŸºç¡€æ•°æ®ç»“æ„","slug":"Redis-åŸºç¡€æ•°æ®ç»“æ„","date":"2019-06-17T14:58:23.000Z","updated":"2019-06-19T15:59:18.743Z","comments":true,"path":"2019/06/17/Redis-åŸºç¡€æ•°æ®ç»“æ„/","link":"","permalink":"http://localhost:4000/2019/06/17/Redis-åŸºç¡€æ•°æ®ç»“æ„/","excerpt":"","text":"Redis åŸºç¡€æ•°æ®ç»“æ„1.å®‰è£…ä½“éªŒ Redis éœ€è¦ä½¿ç”¨ Linux æˆ–è€… Mac ç¯å¢ƒï¼Œå¦‚æœæ˜¯ Windows å¯ä»¥è€ƒè™‘ä½¿ç”¨è™šæ‹Ÿæœºã€‚ä¸»è¦æ–¹å¼æœ‰å››ç§ï¼šä½¿ç”¨ Docker å®‰è£…ã€‚é€šè¿‡ Github æºç ç¼–è¯‘ã€‚ç›´æ¥å®‰è£… apt-get install(Ubuntu)ã€yum install(RedHat) æˆ–è€… brew install(Mac)ã€‚å¦‚æœè¯»è€…æ‡’äºå®‰è£…æ“ä½œï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ç½‘é¡µç‰ˆçš„ Web Redis ç›´æ¥ä½“éªŒã€‚2.åŸºç¡€æ•°æ®ç»“æ„Redis æœ‰äº”ç§å¸¸ç”¨çš„æ•°æ®ç±»å‹ï¼Œåˆ†åˆ«æ˜¯string (å­—ç¬¦ä¸²)ã€list (åˆ—è¡¨)ã€set (é›†åˆ)ã€hash (å“ˆå¸Œ) å’Œ zset (æœ‰åºé›†åˆ)ã€‚ä¸€èˆ¬æˆ‘ä»¬ä¹Ÿæ˜¯ç»å¸¸ä½¿ç”¨è¿™äº”ç§ç±»å‹çš„æ•°æ®ï¼Œä¸‹é¢åˆ†åˆ«ç®€è¿°ä¸€ä¸‹å…¶ä¸­çš„å†…éƒ¨ç»“æ„æ˜¯æ€ä¹ˆæ ·çš„ã€‚2.1 string (å­—ç¬¦ä¸²)stringæ˜¯Redisä¸­æœ€ä¸ºç®€å•çš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡ç”¨Key-valueçš„æ–¹å¼å»å­˜å‚¨ã€æŸ¥æ‰¾å’Œæ›´æ–°ã€‚å¯¹äºä¸åŒçš„æ•°æ®ï¼Œvalueçš„æ•°æ®ç»“æ„ä¸åŒã€‚å­—ç¬¦ä¸²ç»“æ„ä½¿ç”¨éå¸¸å¹¿æ³›ï¼Œä¸€ä¸ªå¸¸è§çš„ç”¨é€”å°±æ˜¯ç¼“å­˜ç”¨æˆ·ä¿¡æ¯ã€‚æˆ‘ä»¬å°†ç”¨æˆ·ä¿¡æ¯ç»“æ„ä½“ä½¿ç”¨ JSON åºåˆ—åŒ–æˆå­—ç¬¦ä¸²ï¼Œç„¶åå°†åºåˆ—åŒ–åçš„å­—ç¬¦ä¸²å¡è¿› Redis æ¥ç¼“å­˜ã€‚åŒæ ·ï¼Œå–ç”¨æˆ·ä¿¡æ¯ä¼šç»è¿‡ä¸€æ¬¡ååºåˆ—åŒ–çš„è¿‡ç¨‹ã€‚Redis çš„å­—ç¬¦ä¸²æ˜¯åŠ¨æ€å­—ç¬¦ä¸²ï¼Œæ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå†…éƒ¨ç»“æ„å®ç°ä¸Šç±»ä¼¼äº Java çš„ ArrayListï¼Œé‡‡ç”¨é¢„åˆ†é…å†—ä½™ç©ºé—´çš„æ–¹å¼æ¥å‡å°‘å†…å­˜çš„é¢‘ç¹åˆ†é…ï¼Œå¦‚å›¾ä¸­æ‰€ç¤ºï¼Œå†…éƒ¨ä¸ºå½“å‰å­—ç¬¦ä¸²å®é™…åˆ†é…çš„ç©ºé—´ capacity ä¸€èˆ¬è¦é«˜äºå®é™…å­—ç¬¦ä¸²é•¿åº¦ lenã€‚å½“å­—ç¬¦ä¸²é•¿åº¦å°äº 1M æ—¶ï¼Œæ‰©å®¹éƒ½æ˜¯åŠ å€ç°æœ‰çš„ç©ºé—´ï¼Œå¦‚æœè¶…è¿‡ 1Mï¼Œæ‰©å®¹æ—¶ä¸€æ¬¡åªä¼šå¤šæ‰© 1M çš„ç©ºé—´ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å­—ç¬¦ä¸²æœ€å¤§é•¿åº¦ä¸º 512Mã€‚åœ¨å†…å­˜ä¸­æ˜¯ä»¥å­—èŠ‚æ•°ç»„çš„å­˜å‚¨çš„ã€‚Redis çš„å­—ç¬¦ä¸²å«ç€ã€ŒSDSã€ï¼Œä¹Ÿå°±æ˜¯Simple Dynamic Stringã€‚å®ƒçš„ç»“æ„æ˜¯ä¸€ä¸ªå¸¦é•¿åº¦ä¿¡æ¯çš„å­—èŠ‚æ•°ç»„ã€‚123456struct SDS&lt;T&gt; &#123;T capacity; // æ•°ç»„å®¹é‡T len; // æ•°ç»„é•¿åº¦byte flags; // ç‰¹æ®Šæ ‡è¯†ä½ï¼Œä¸ç†ç¬å®ƒbyte[] content; // æ•°ç»„å†…å®¹&#125;å‚æ•°åˆ†æï¼šcapacityæ˜¯æŒ‡æ•°ç»„çš„é•¿åº¦ï¼Œä¸€èˆ¬ä¼šæ¯”å®é™…çš„å†…å®¹å¤šåˆ†é…ä¸€äº›ç©ºé—´lenæ˜¯å®é™…çš„å­—ç¬¦ä¸²çš„çœŸæ˜¯é•¿åº¦contentæ˜¯å­˜å‚¨äº†çœŸæ­£çš„å­—ç¬¦ä¸²çš„å†…å®¹å­—ç¬¦ä¸²æ˜¯å¯ä»¥ä¿®æ”¹çš„å­—ç¬¦ä¸²ï¼Œå®ƒè¦æ”¯æŒ append æ“ä½œã€‚å¦‚æœæ•°ç»„æ²¡æœ‰å†—ä½™ç©ºé—´ï¼Œé‚£ä¹ˆè¿½åŠ æ“ä½œå¿…ç„¶æ¶‰åŠåˆ°åˆ†é…æ–°æ•°ç»„ï¼Œç„¶åå°†æ—§å†…å®¹å¤åˆ¶è¿‡æ¥ï¼Œå† append æ–°å†…å®¹ã€‚å¦‚æœå­—ç¬¦ä¸²çš„é•¿åº¦éå¸¸é•¿ï¼Œè¿™æ ·çš„å†…å­˜åˆ†é…å’Œå¤åˆ¶å¼€é”€å°±ä¼šéå¸¸å¤§ã€‚12345678910111213141516/* Append the specified binary-safe string pointed by 't' of 'len' bytes to the* end of the specified sds string 's'.** After the call, the passed sds string is no longer valid and all the* references must be substituted with the new pointer returned by the call. */sds sdscatlen(sds s, const void *t, size_t len) &#123;size_t curlen = sdslen(s); // åŸå­—ç¬¦ä¸²é•¿åº¦// æŒ‰éœ€è°ƒæ•´ç©ºé—´ï¼Œå¦‚æœ capacity ä¸å¤Ÿå®¹çº³è¿½åŠ çš„å†…å®¹ï¼Œå°±ä¼šé‡æ–°åˆ†é…å­—èŠ‚æ•°ç»„å¹¶å¤åˆ¶åŸå­—ç¬¦ä¸²çš„å†…å®¹åˆ°æ–°æ•°ç»„ä¸­s = sdsMakeRoomFor(s,len);if (s == NULL) return NULL; // å†…å­˜ä¸è¶³memcpy(s+curlen, t, len); // è¿½åŠ ç›®æ ‡å­—ç¬¦ä¸²çš„å†…å®¹åˆ°å­—èŠ‚æ•°ç»„ä¸­sdssetlen(s, curlen+len); // è®¾ç½®è¿½åŠ åçš„é•¿åº¦å€¼s[curlen+len] = '\\0'; // è®©å­—ç¬¦ä¸²ä»¥\\0 ç»“å°¾ï¼Œä¾¿äºè°ƒè¯•æ‰“å°ï¼Œè¿˜å¯ä»¥ç›´æ¥ä½¿ç”¨ glibc çš„å­—ç¬¦ä¸²å‡½æ•°è¿›è¡Œæ“ä½œreturn s;&#125;ä¸Šé¢çš„ SDS ç»“æ„ä½¿ç”¨äº†èŒƒå‹ Tï¼Œä¸ºä»€ä¹ˆä¸ç›´æ¥ç”¨ int å‘¢ï¼Œè¿™æ˜¯å› ä¸ºå½“å­—ç¬¦ä¸²æ¯”è¾ƒçŸ­æ—¶ï¼Œlen å’Œ capacity å¯ä»¥ä½¿ç”¨ byte å’Œ short æ¥è¡¨ç¤ºï¼ŒRedis ä¸ºäº†å¯¹å†…å­˜åšæè‡´çš„ä¼˜åŒ–ï¼Œä¸åŒé•¿åº¦çš„å­—ç¬¦ä¸²ä½¿ç”¨ä¸åŒçš„ç»“æ„ä½“æ¥è¡¨ç¤ºã€‚Redis è§„å®šå­—ç¬¦ä¸²çš„é•¿åº¦ä¸å¾—è¶…è¿‡ 512M å­—èŠ‚ã€‚åˆ›å»ºå­—ç¬¦ä¸²æ—¶ len å’Œ capacity ä¸€æ ·é•¿ï¼Œä¸ä¼šå¤šåˆ†é…å†—ä½™ç©ºé—´ï¼Œè¿™æ˜¯å› ä¸ºç»å¤§å¤šæ•°åœºæ™¯ä¸‹æˆ‘ä»¬ä¸ä¼šä½¿ç”¨ append æ“ä½œæ¥ä¿®æ”¹å­—ç¬¦ä¸²ã€‚embstr vs rawRedisçš„ä¸¤ç§å­˜å‚¨å­—ç¬¦ä¸²çš„æ–¹å¼ã€‚åœ¨é•¿åº¦ç‰¹åˆ«çŸ­æ—¶ï¼Œä½¿ç”¨ emb å½¢å¼å­˜å‚¨ (embeded)ï¼Œå½“é•¿åº¦è¶…è¿‡ 44 æ—¶ï¼Œä½¿ç”¨ raw å½¢å¼å­˜å‚¨ã€‚12345678127.0.0.1:6379&gt; set codehole abcdefghijklmnopqrstuvwxyz0123456789123456789OK127.0.0.1:6379&gt; debug object codeholeValue at:00007FD73D46E2D0 refcount:1 encoding:raw serializedlength:46 lru:505657 lru_seconds_idle:2127.0.0.1:6379&gt; set codehole abcdefghijOK127.0.0.1:6379&gt; debug object codeholeValue at:00007FD73D40A6A0 refcount:1 encoding:embstr serializedlength:11 lru:505690 lru_seconds_idle:2æ³¨æ„ä¸Šé¢ debug object è¾“å‡ºä¸­æœ‰ä¸ª encoding å­—æ®µï¼Œä¸€ä¸ªå­—ç¬¦çš„å·®åˆ«ï¼Œå­˜å‚¨å½¢å¼å°±å‘ç”Ÿäº†å˜åŒ–ã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬é¦–å…ˆæ¥äº†è§£ä¸€ä¸‹ Redis å¯¹è±¡å¤´ç»“æ„ä½“ï¼Œæ‰€æœ‰çš„ Redis å¯¹è±¡éƒ½æœ‰ä¸‹é¢çš„è¿™ä¸ªç»“æ„å¤´:1234567struct RedisObject &#123;int4 type; // 4bitsint4 encoding; // 4bitsint24 lru; // 24bitsint32 refcount; // 4bytesvoid *ptr; // 8bytesï¼Œ64-bit system&#125; robj;ä¸åŒçš„å¯¹è±¡å…·æœ‰ä¸åŒçš„ç±»å‹ type(4bit)ï¼ŒåŒä¸€ä¸ªç±»å‹çš„ type ä¼šæœ‰ä¸åŒçš„å­˜å‚¨å½¢å¼ encoding(4bit)ï¼Œä¸ºäº†è®°å½•å¯¹è±¡çš„ LRU ä¿¡æ¯ï¼Œä½¿ç”¨äº† 24 ä¸ª bit æ¥è®°å½• LRU ä¿¡æ¯ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸ªå¼•ç”¨è®¡æ•°ï¼Œå½“å¼•ç”¨è®¡æ•°ä¸ºé›¶æ—¶ï¼Œå¯¹è±¡å°±ä¼šè¢«é”€æ¯ï¼Œå†…å­˜è¢«å›æ”¶ã€‚ptræŒ‡é’ˆå°†æŒ‡å‘å¯¹è±¡å†…å®¹ (body) çš„å…·ä½“å­˜å‚¨ä½ç½®ã€‚è¿™æ ·ä¸€ä¸ª RedisObject å¯¹è±¡å¤´éœ€è¦å æ® 16 å­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚æ¥ç€æˆ‘ä»¬å†çœ‹ SDS ç»“æ„ä½“çš„å¤§å°ï¼Œåœ¨å­—ç¬¦ä¸²æ¯”è¾ƒå°æ—¶ï¼ŒSDS å¯¹è±¡å¤´çš„å¤§å°æ˜¯capacity+3ï¼Œè‡³å°‘æ˜¯ 3ã€‚æ„å‘³ç€åˆ†é…ä¸€ä¸ªå­—ç¬¦ä¸²çš„æœ€å°ç©ºé—´å ç”¨ä¸º 19 å­—èŠ‚ (16+3)ã€‚123456struct SDS &#123;int8 capacity; // 1byteint8 len; // 1byteint8 flags; // 1bytebyte[] content; // å†…è”æ•°ç»„ï¼Œé•¿åº¦ä¸º capacity&#125;å¦‚å›¾æ‰€ç¤ºï¼Œembstr å­˜å‚¨å½¢å¼æ˜¯è¿™æ ·ä¸€ç§å­˜å‚¨å½¢å¼ï¼Œå®ƒå°† RedisObject å¯¹è±¡å¤´å’Œ SDS å¯¹è±¡è¿ç»­å­˜åœ¨ä¸€èµ·ï¼Œä½¿ç”¨ malloc æ–¹æ³•ä¸€æ¬¡åˆ†é…ã€‚è€Œ raw å­˜å‚¨å½¢å¼ä¸ä¸€æ ·ï¼Œå®ƒéœ€è¦ä¸¤æ¬¡ mallocï¼Œä¸¤ä¸ªå¯¹è±¡å¤´åœ¨å†…å­˜åœ°å€ä¸Šä¸€èˆ¬æ˜¯ä¸è¿ç»­çš„ã€‚è€Œå†…å­˜åˆ†é…å™¨ jemalloc/tcmalloc ç­‰åˆ†é…å†…å­˜å¤§å°çš„å•ä½éƒ½æ˜¯ 2ã€4ã€8ã€16ã€32ã€64 ç­‰ç­‰ï¼Œä¸ºäº†èƒ½å®¹çº³ä¸€ä¸ªå®Œæ•´çš„ embstr å¯¹è±¡ï¼Œjemalloc æœ€å°‘ä¼šåˆ†é… 32 å­—èŠ‚çš„ç©ºé—´ï¼Œå¦‚æœå­—ç¬¦ä¸²å†ç¨å¾®é•¿ä¸€ç‚¹ï¼Œé‚£å°±æ˜¯ 64 å­—èŠ‚çš„ç©ºé—´ã€‚å¦‚æœæ€»ä½“è¶…å‡ºäº† 64 å­—èŠ‚ï¼ŒRedis è®¤ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¤§å­—ç¬¦ä¸²ï¼Œä¸å†ä½¿ç”¨ emdstr å½¢å¼å­˜å‚¨ï¼Œè€Œè¯¥ç”¨ raw å½¢å¼ã€‚å½“å†…å­˜åˆ†é…å™¨åˆ†é…äº† 64 ç©ºé—´æ—¶ï¼Œé‚£è¿™ä¸ªå­—ç¬¦ä¸²çš„é•¿åº¦æœ€å¤§å¯ä»¥æ˜¯å¤šå°‘å‘¢ï¼Ÿè¿™ä¸ªé•¿åº¦å°±æ˜¯ 44ã€‚é‚£ä¸ºä»€ä¹ˆæ˜¯ 44 å‘¢ï¼Ÿå‰é¢æˆ‘ä»¬æåˆ° SDS ç»“æ„ä½“ä¸­çš„ content ä¸­çš„å­—ç¬¦ä¸²æ˜¯ä»¥å­—èŠ‚\\0ç»“å°¾çš„å­—ç¬¦ä¸²ï¼Œä¹‹æ‰€ä»¥å¤šå‡ºè¿™æ ·ä¸€ä¸ªå­—èŠ‚ï¼Œæ˜¯ä¸ºäº†ä¾¿äºç›´æ¥ä½¿ç”¨ glibc çš„å­—ç¬¦ä¸²å¤„ç†å‡½æ•°ï¼Œä»¥åŠä¸ºäº†ä¾¿äºå­—ç¬¦ä¸²çš„è°ƒè¯•æ‰“å°è¾“å‡ºã€‚çœ‹ä¸Šé¢è¿™å¼ å›¾å¯ä»¥ç®—å‡ºï¼Œç•™ç»™ content çš„é•¿åº¦æœ€å¤šåªæœ‰ 45(64-19) å­—èŠ‚äº†ã€‚å­—ç¬¦ä¸²åˆæ˜¯ä»¥\\0ç»“å°¾ï¼Œæ‰€ä»¥ embstr æœ€å¤§èƒ½å®¹çº³çš„å­—ç¬¦ä¸²é•¿åº¦å°±æ˜¯ 44ã€‚æ‰©å®¹ç­–ç•¥å­—ç¬¦ä¸²åœ¨é•¿åº¦å°äº 1M ä¹‹å‰ï¼Œæ‰©å®¹ç©ºé—´é‡‡ç”¨åŠ å€ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¿ç•™ 100% çš„å†—ä½™ç©ºé—´ã€‚å½“é•¿åº¦è¶…è¿‡ 1M ä¹‹åï¼Œä¸ºäº†é¿å…åŠ å€åçš„å†—ä½™ç©ºé—´è¿‡å¤§è€Œå¯¼è‡´æµªè´¹ï¼Œæ¯æ¬¡æ‰©å®¹åªä¼šå¤šåˆ†é… 1M å¤§å°çš„å†—ä½™ç©ºé—´ã€‚æŒ‡ä»¤é”®å€¼å¯¹12345678910&gt; set name codeholeOK&gt; get name&quot;codehole&quot;&gt; exists name(integer) 1&gt; del name(integer) 1&gt; get name(nil)æ‰¹é‡é”®å€¼å¯¹12345678910111213&gt; set name1 codeholeOK&gt; set name2 holycoderOK&gt; mget name1 name2 name3 # è¿”å›ä¸€ä¸ªåˆ—è¡¨1) &quot;codehole&quot;2) &quot;holycoder&quot;3) (nil)&gt; mset name1 boy name2 girl name3 unknown&gt; mget name1 name2 name31) &quot;boy&quot;2) &quot;girl&quot;3) &quot;unknown&quot;è¿‡æœŸå’Œ set å‘½ä»¤æ‰©å±•1234567891011121314151617181920212223&gt; set name codehole&gt; get name&quot;codehole&quot;&gt; expire name 5 # 5s åè¿‡æœŸ... # wait for 5s&gt; get name(nil)&gt; setex name 5 codehole # 5s åè¿‡æœŸï¼Œç­‰ä»·äº set+expire&gt; get name&quot;codehole&quot;... # wait for 5s&gt; get name(nil)&gt; setnx name codehole # å¦‚æœ name ä¸å­˜åœ¨å°±æ‰§è¡Œ set åˆ›å»º(integer) 1&gt; get name&quot;codehole&quot;&gt; setnx name holycoder(integer) 0 # å› ä¸º name å·²ç»å­˜åœ¨ï¼Œæ‰€ä»¥ set åˆ›å»ºä¸æˆåŠŸ&gt; get name&quot;codehole&quot; # æ²¡æœ‰æ”¹å˜è®¡æ•°123456789101112&gt; set age 30OK&gt; incr age(integer) 31&gt; incrby age 5(integer) 36&gt; incrby age -5(integer) 31&gt; set codehole 9223372036854775807 # Long.MaxOK&gt; incr codehole(error) ERR increment or decrement would overflow2.2 list (åˆ—è¡¨)Redisçš„åˆ—è¡¨ç›¸å½“äºJavaçš„ArrayListï¼Œæ˜¯ç”±é“¾è¡¨ç»„æˆçš„ï¼Œæ‰€ä»¥æ’å…¥å’Œåˆ é™¤è¾ƒå¿«ï¼Œä½†æ˜¯æŸ¥è¯¢æ¯”è¾ƒæ…¢ã€‚listä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ å¼¹å‡ºåï¼Œè¯¥æ•°æ®ç»“æ„å°±è¢«åˆ é™¤ï¼Œå†…å­˜ä¹Ÿè¢«å›æ”¶äº†ã€‚å³è¾¹è¿›å·¦è¾¹å‡ºï¼šé˜Ÿåˆ—123456789101112&gt; rpush books python java golang(integer) 3&gt; llen books(integer) 3&gt; lpop books&quot;python&quot;&gt; lpop books&quot;java&quot;&gt; lpop books&quot;golang&quot;&gt; lpop books(nil)å³è¾¹è¿›å³è¾¹å‡ºï¼šæ ˆ12345678910&gt; rpush books python java golang(integer) 3&gt; rpop books&quot;golang&quot;&gt; rpop books&quot;java&quot;&gt; rpop books&quot;python&quot;&gt; rpop books(nil)æ…¢æ“ä½œlindex ç›¸å½“äº Java é“¾è¡¨çš„get(int index)æ–¹æ³•ï¼Œå®ƒéœ€è¦å¯¹é“¾è¡¨è¿›è¡Œéå†ï¼Œæ€§èƒ½éšç€å‚æ•°indexå¢å¤§è€Œå˜å·®ã€‚ltrim å’Œå­—é¢ä¸Šçš„å«ä¹‰ä¸å¤ªä¸€æ ·ï¼Œä¸ªäººè§‰å¾—å®ƒå« lretain(ä¿ç•™) æ›´åˆé€‚ä¸€äº›ï¼Œå› ä¸º ltrim è·Ÿçš„ä¸¤ä¸ªå‚æ•°start_indexå’Œend_indexå®šä¹‰äº†ä¸€ä¸ªåŒºé—´ï¼Œåœ¨è¿™ä¸ªåŒºé—´å†…çš„å€¼ï¼Œltrim è¦ä¿ç•™ï¼ŒåŒºé—´ä¹‹å¤–ç»Ÿç»Ÿç æ‰ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ltrimæ¥å®ç°ä¸€ä¸ªå®šé•¿çš„é“¾è¡¨ï¼Œè¿™ä¸€ç‚¹éå¸¸æœ‰ç”¨ã€‚index å¯ä»¥ä¸ºè´Ÿæ•°ï¼Œindex=-1è¡¨ç¤ºå€’æ•°ç¬¬ä¸€ä¸ªå…ƒç´ ï¼ŒåŒæ ·index=-2è¡¨ç¤ºå€’æ•°ç¬¬äºŒä¸ªå…ƒç´ ã€‚1234567891011121314151617&gt; rpush books python java golang(integer) 3&gt; lindex books 1 # O(n) æ…ç”¨&quot;java&quot;&gt; lrange books 0 -1 # è·å–æ‰€æœ‰å…ƒç´ ï¼ŒO(n) æ…ç”¨1) &quot;python&quot;2) &quot;java&quot;3) &quot;golang&quot;&gt; ltrim books 1 -1 # O(n) æ…ç”¨OK&gt; lrange books 0 -11) &quot;java&quot;2) &quot;golang&quot;&gt; ltrim books 1 0 # è¿™å…¶å®æ˜¯æ¸…ç©ºäº†æ•´ä¸ªåˆ—è¡¨ï¼Œå› ä¸ºåŒºé—´èŒƒå›´é•¿åº¦ä¸ºè´ŸOK&gt; llen books(integer) 0åº•å±‚æ•°æ®ç»“æ„Redis åº•å±‚å­˜å‚¨çš„è¿˜ä¸æ˜¯ä¸€ä¸ªç®€å•çš„ linkedlistï¼Œè€Œæ˜¯ç§°ä¹‹ä¸ºå¿«é€Ÿé“¾è¡¨ quicklist çš„ä¸€ä¸ªç»“æ„ã€‚é¦–å…ˆåœ¨åˆ—è¡¨å…ƒç´ è¾ƒå°‘çš„æƒ…å†µä¸‹ä¼šä½¿ç”¨ä¸€å—è¿ç»­çš„å†…å­˜å­˜å‚¨ï¼Œè¿™ä¸ªç»“æ„æ˜¯ ziplistï¼Œä¹Ÿå³æ˜¯å‹ç¼©åˆ—è¡¨ã€‚å®ƒå°†æ‰€æœ‰çš„å…ƒç´ ç´§æŒ¨ç€ä¸€èµ·å­˜å‚¨ï¼Œåˆ†é…çš„æ˜¯ä¸€å—è¿ç»­çš„å†…å­˜ã€‚å½“æ•°æ®é‡æ¯”è¾ƒå¤šçš„æ—¶å€™æ‰ä¼šæ”¹æˆ quicklistã€‚å› ä¸ºæ™®é€šçš„é“¾è¡¨éœ€è¦çš„é™„åŠ æŒ‡é’ˆç©ºé—´å¤ªå¤§ï¼Œä¼šæ¯”è¾ƒæµªè´¹ç©ºé—´ï¼Œè€Œä¸”ä¼šåŠ é‡å†…å­˜çš„ç¢ç‰‡åŒ–ã€‚æ¯”å¦‚è¿™ä¸ªåˆ—è¡¨é‡Œå­˜çš„åªæ˜¯ int ç±»å‹çš„æ•°æ®ï¼Œç»“æ„ä¸Šè¿˜éœ€è¦ä¸¤ä¸ªé¢å¤–çš„æŒ‡é’ˆ prev å’Œ next ã€‚æ‰€ä»¥ Redis å°†é“¾è¡¨å’Œ ziplist ç»“åˆèµ·æ¥ç»„æˆäº† quicklistã€‚ä¹Ÿå°±æ˜¯å°†å¤šä¸ª ziplist ä½¿ç”¨åŒå‘æŒ‡é’ˆä¸²èµ·æ¥ä½¿ç”¨ã€‚è¿™æ ·æ—¢æ»¡è¶³äº†å¿«é€Ÿçš„æ’å…¥åˆ é™¤æ€§èƒ½ï¼Œåˆä¸ä¼šå‡ºç°å¤ªå¤§çš„ç©ºé—´å†—ä½™ã€‚å¯ä»¥æŸ¥çœ‹åˆ—è¡¨ä¸­çš„å‹ç¼©åˆ—è¡¨å’Œå¿«é€Ÿåˆ—è¡¨ã€‚2.3 hash (å“ˆå¸Œ)hashç±»æ¯”äºJavaä¸­çš„HashMapï¼Œå®ƒæ˜¯æ— åºå­—å…¸ã€‚å†…éƒ¨å®ç°ç»“æ„ä¸ŠåŒ Java çš„ HashMap ä¹Ÿæ˜¯ä¸€è‡´çš„ï¼ŒåŒæ ·çš„æ•°ç»„ + é“¾è¡¨äºŒç»´ç»“æ„ã€‚ç¬¬ä¸€ç»´ hash çš„æ•°ç»„ä½ç½®ç¢°æ’æ—¶ï¼Œå°±ä¼šå°†ç¢°æ’çš„å…ƒç´ ä½¿ç”¨é“¾è¡¨ä¸²æ¥èµ·æ¥ã€‚ä¸åŒçš„æ˜¯ï¼ŒRedis çš„å­—å…¸çš„å€¼åªèƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œå¦å¤–å®ƒä»¬ rehash çš„æ–¹å¼ä¸ä¸€æ ·ï¼Œå› ä¸º Java çš„ HashMap åœ¨å­—å…¸å¾ˆå¤§æ—¶ï¼Œrehash æ˜¯ä¸ªè€—æ—¶çš„æ“ä½œï¼Œéœ€è¦ä¸€æ¬¡æ€§å…¨éƒ¨ rehashã€‚Redis ä¸ºäº†é«˜æ€§èƒ½ï¼Œä¸èƒ½å µå¡æœåŠ¡ï¼Œæ‰€ä»¥é‡‡ç”¨äº†æ¸è¿›å¼ rehash ç­–ç•¥ã€‚hash ç»“æ„ä¹Ÿå¯ä»¥ç”¨æ¥å­˜å‚¨ç”¨æˆ·ä¿¡æ¯ï¼Œä¸åŒäºå­—ç¬¦ä¸²ä¸€æ¬¡æ€§éœ€è¦å…¨éƒ¨åºåˆ—åŒ–æ•´ä¸ªå¯¹è±¡ï¼Œhash å¯ä»¥å¯¹ç”¨æˆ·ç»“æ„ä¸­çš„æ¯ä¸ªå­—æ®µå•ç‹¬å­˜å‚¨ã€‚è¿™æ ·å½“æˆ‘ä»¬éœ€è¦è·å–ç”¨æˆ·ä¿¡æ¯æ—¶å¯ä»¥è¿›è¡Œéƒ¨åˆ†è·å–ã€‚è€Œä»¥æ•´ä¸ªå­—ç¬¦ä¸²çš„å½¢å¼å»ä¿å­˜ç”¨æˆ·ä¿¡æ¯çš„è¯å°±åªèƒ½ä¸€æ¬¡æ€§å…¨éƒ¨è¯»å–ï¼Œè¿™æ ·å°±ä¼šæ¯”è¾ƒæµªè´¹ç½‘ç»œæµé‡ã€‚hash ä¹Ÿæœ‰ç¼ºç‚¹ï¼Œhash ç»“æ„çš„å­˜å‚¨æ¶ˆè€—è¦é«˜äºå•ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ°åº•è¯¥ä½¿ç”¨ hash è¿˜æ˜¯å­—ç¬¦ä¸²ï¼Œéœ€è¦æ ¹æ®å®é™…æƒ…å†µå†ä¸‰æƒè¡¡ã€‚æŒ‡ä»¤1234567891011121314151617181920212223&gt; hset books java &quot;think in java&quot; # å‘½ä»¤è¡Œçš„å­—ç¬¦ä¸²å¦‚æœåŒ…å«ç©ºæ ¼ï¼Œè¦ç”¨å¼•å·æ‹¬èµ·æ¥(integer) 1&gt; hset books golang &quot;concurrency in go&quot;(integer) 1&gt; hset books python &quot;python cookbook&quot;(integer) 1&gt; hgetall books # entries()ï¼Œkey å’Œ value é—´éš”å‡ºç°1) &quot;java&quot;2) &quot;think in java&quot;3) &quot;golang&quot;4) &quot;concurrency in go&quot;5) &quot;python&quot;6) &quot;python cookbook&quot;&gt; hlen books(integer) 3&gt; hget books java&quot;think in java&quot;&gt; hset books golang &quot;learning go programming&quot; # å› ä¸ºæ˜¯æ›´æ–°æ“ä½œï¼Œæ‰€ä»¥è¿”å› 0(integer) 0&gt; hget books golang&quot;learning go programming&quot;&gt; hmset books java &quot;effective java&quot; python &quot;learning python&quot; golang &quot;modern golang programming&quot; # æ‰¹é‡ setOKåŒå­—ç¬¦ä¸²ä¸€æ ·ï¼Œhash ç»“æ„ä¸­çš„å•ä¸ªå­ key ä¹Ÿå¯ä»¥è¿›è¡Œè®¡æ•°ï¼Œå®ƒå¯¹åº”çš„æŒ‡ä»¤æ˜¯ hincrbyï¼Œå’Œ incr ä½¿ç”¨åŸºæœ¬ä¸€æ ·ã€‚123# è€é’±åˆè€äº†ä¸€å²&gt; hincrby user-laoqian age 1(integer) 30å…³äºå­—å…¸çš„å†…éƒ¨ç»“æ„å®ç°ï¼Œå¯ä»¥æŸ¥çœ‹ã€Œå­—å…¸ã€å†…éƒ¨ã€‚2.4 set((é›†åˆ)setå¯¹æ¯”Javaä¸­çš„HashSetç›¸ä¼¼ï¼Œå†…éƒ¨valueä¹Ÿå”¯ä¸€æ— åºçš„ã€‚å®ƒçš„å†…éƒ¨å®ç°ç›¸å½“äºä¸€ä¸ªç‰¹æ®Šçš„å­—å…¸ï¼Œå­—å…¸ä¸­æ‰€æœ‰çš„ value éƒ½æ˜¯ä¸€ä¸ªå€¼NULLã€‚å’Œlistç›¸åŒï¼Œå½“é›†åˆä¸­æœ€åä¸€ä¸ªå…ƒç´ ç§»é™¤ä¹‹åï¼Œæ•°æ®ç»“æ„è‡ªåŠ¨åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚å¯ä»¥åœ¨å»é‡åº”ç”¨ç¯å¢ƒä¸­ã€‚æŒ‡ä»¤123456789101112131415161718&gt; sadd books python(integer) 1&gt; sadd books python # é‡å¤(integer) 0&gt; sadd books java golang(integer) 2&gt; smembers books # æ³¨æ„é¡ºåºï¼Œå’Œæ’å…¥çš„å¹¶ä¸ä¸€è‡´ï¼Œå› ä¸º set æ˜¯æ— åºçš„1) &quot;java&quot;2) &quot;python&quot;3) &quot;golang&quot;&gt; sismember books java # æŸ¥è¯¢æŸä¸ª value æ˜¯å¦å­˜åœ¨ï¼Œç›¸å½“äº contains(o)(integer) 1&gt; sismember books rust(integer) 0&gt; scard books # è·å–é•¿åº¦ç›¸å½“äº count()(integer) 3&gt; spop books # å¼¹å‡ºä¸€ä¸ª&quot;java&quot;2.5 zset (æœ‰åºé›†åˆ)zset å¯èƒ½æ˜¯ Redis æä¾›çš„æœ€ä¸ºç‰¹è‰²çš„æ•°æ®ç»“æ„ï¼Œå®ƒä¹Ÿæ˜¯åœ¨é¢è¯•ä¸­é¢è¯•å®˜æœ€çˆ±é—®çš„æ•°æ®ç»“æ„ã€‚å®ƒç±»ä¼¼äº Java çš„ SortedSet å’Œ HashMap çš„ç»“åˆä½“ï¼Œä¸€æ–¹é¢å®ƒæ˜¯ä¸€ä¸ª setï¼Œä¿è¯äº†å†…éƒ¨ value çš„å”¯ä¸€æ€§ï¼Œå¦ä¸€æ–¹é¢å®ƒå¯ä»¥ç»™æ¯ä¸ª value èµ‹äºˆä¸€ä¸ª scoreï¼Œä»£è¡¨è¿™ä¸ª value çš„æ’åºæƒé‡ã€‚å®ƒçš„å†…éƒ¨å®ç°ç”¨çš„æ˜¯ä¸€ç§å«åšã€Œè·³è·ƒåˆ—è¡¨ã€çš„æ•°æ®ç»“æ„ã€‚zset ä¸­æœ€åä¸€ä¸ª value è¢«ç§»é™¤åï¼Œæ•°æ®ç»“æ„è‡ªåŠ¨åˆ é™¤ï¼Œå†…å­˜è¢«å›æ”¶ã€‚æŒ‡ä»¤123456789101112131415161718192021222324252627282930313233&gt; zadd books 9.0 &quot;think in java&quot;(integer) 1&gt; zadd books 8.9 &quot;java concurrency&quot;(integer) 1&gt; zadd books 8.6 &quot;java cookbook&quot;(integer) 1&gt; zrange books 0 -1 # æŒ‰ score æ’åºåˆ—å‡ºï¼Œå‚æ•°åŒºé—´ä¸ºæ’åèŒƒå›´1) &quot;java cookbook&quot;2) &quot;java concurrency&quot;3) &quot;think in java&quot;&gt; zrevrange books 0 -1 # æŒ‰ score é€†åºåˆ—å‡ºï¼Œå‚æ•°åŒºé—´ä¸ºæ’åèŒƒå›´1) &quot;think in java&quot;2) &quot;java concurrency&quot;3) &quot;java cookbook&quot;&gt; zcard books # ç›¸å½“äº count()(integer) 3&gt; zscore books &quot;java concurrency&quot; # è·å–æŒ‡å®š value çš„ score&quot;8.9000000000000004&quot; # å†…éƒ¨ score ä½¿ç”¨ double ç±»å‹è¿›è¡Œå­˜å‚¨ï¼Œæ‰€ä»¥å­˜åœ¨å°æ•°ç‚¹ç²¾åº¦é—®é¢˜&gt; zrank books &quot;java concurrency&quot; # æ’å(integer) 1&gt; zrangebyscore books 0 8.91 # æ ¹æ®åˆ†å€¼åŒºé—´éå† zset1) &quot;java cookbook&quot;2) &quot;java concurrency&quot;&gt; zrangebyscore books -inf 8.91 withscores # æ ¹æ®åˆ†å€¼åŒºé—´ (-âˆ, 8.91] éå† zsetï¼ŒåŒæ—¶è¿”å›åˆ†å€¼ã€‚inf ä»£è¡¨ infiniteï¼Œæ— ç©·å¤§çš„æ„æ€ã€‚1) &quot;java cookbook&quot;2) &quot;8.5999999999999996&quot;3) &quot;java concurrency&quot;4) &quot;8.9000000000000004&quot;&gt; zrem books &quot;java concurrency&quot; # åˆ é™¤ value(integer) 1&gt; zrange books 0 -11) &quot;java cookbook&quot;2) &quot;think in java&quot;3.å…¶ä»–é€šç”¨è§„åˆ™list/set/hash/zset è¿™å››ç§æ•°æ®ç»“æ„æ˜¯å®¹å™¨å‹æ•°æ®ç»“æ„ï¼Œå®ƒä»¬å…±äº«ä¸‹é¢ä¸¤æ¡é€šç”¨è§„åˆ™ï¼šcreate if not existså¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œé‚£å°±åˆ›å»ºä¸€ä¸ªï¼Œå†è¿›è¡Œæ“ä½œã€‚æ¯”å¦‚ rpush æ“ä½œåˆšå¼€å§‹æ˜¯æ²¡æœ‰åˆ—è¡¨çš„ï¼ŒRedis å°±ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªï¼Œç„¶åå† rpush è¿›å»æ–°å…ƒç´ ã€‚drop if no elementså¦‚æœå®¹å™¨é‡Œå…ƒç´ æ²¡æœ‰äº†ï¼Œé‚£ä¹ˆç«‹å³åˆ é™¤å…ƒç´ ï¼Œé‡Šæ”¾å†…å­˜ã€‚è¿™æ„å‘³ç€ lpop æ“ä½œåˆ°æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ—è¡¨å°±æ¶ˆå¤±äº†ã€‚è¿‡æœŸæ—¶é—´Redis æ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œæ—¶é—´åˆ°äº†ï¼ŒRedis ä¼šè‡ªåŠ¨åˆ é™¤ç›¸åº”çš„å¯¹è±¡ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿‡æœŸæ˜¯ä»¥å¯¹è±¡ä¸ºå•ä½ï¼Œæ¯”å¦‚ä¸€ä¸ª hash ç»“æ„çš„è¿‡æœŸæ˜¯æ•´ä¸ª hash å¯¹è±¡çš„è¿‡æœŸï¼Œè€Œä¸æ˜¯å…¶ä¸­çš„æŸä¸ªå­ keyã€‚è¿˜æœ‰ä¸€ä¸ªéœ€è¦ç‰¹åˆ«æ³¨æ„çš„åœ°æ–¹æ˜¯å¦‚æœä¸€ä¸ªå­—ç¬¦ä¸²å·²ç»è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œç„¶åä½ è°ƒç”¨äº† set æ–¹æ³•ä¿®æ”¹äº†å®ƒï¼Œå®ƒçš„è¿‡æœŸæ—¶é—´ä¼šæ¶ˆå¤±ã€‚","categories":[{"name":"Redis","slug":"Redis","permalink":"http://localhost:4000/categories/Redis/"},{"name":"åŸºæœ¬ç»“æ„","slug":"Redis/åŸºæœ¬ç»“æ„","permalink":"http://localhost:4000/categories/Redis/åŸºæœ¬ç»“æ„/"}],"tags":[{"name":"redis","slug":"redis","permalink":"http://localhost:4000/tags/redis/"},{"name":"ç¼“å­˜","slug":"ç¼“å­˜","permalink":"http://localhost:4000/tags/ç¼“å­˜/"}]},{"title":"Javaçº¿ç¨‹æ± çš„åŸç†åˆ†æ","slug":"Javaçº¿ç¨‹æ± ","date":"2019-06-16T14:25:02.000Z","updated":"2019-06-17T04:59:56.308Z","comments":true,"path":"2019/06/16/Javaçº¿ç¨‹æ± /","link":"","permalink":"http://localhost:4000/2019/06/16/Javaçº¿ç¨‹æ± /","excerpt":"","text":"Javaçº¿ç¨‹æ± çš„åŸç†åˆ†æ1.ç®€ä»‹éšç€å¹¶å‘çš„ä¸æ–­å¢åŠ ï¼Œå•ä¸ªçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ä¼šå¸¦æ¥å¤§é‡çš„èµ„æºå¼€é”€ã€‚é€šè¿‡çº¿ç¨‹æ±  æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„å¤ç”¨çº¿ç¨‹ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹æ‰€å¸¦æ¥çš„å¼€é”€ã€‚åœ¨åº”ç”¨ä¸Šï¼Œçº¿ç¨‹æ± å¯åº”ç”¨åœ¨åç«¯ç›¸å…³æœåŠ¡ä¸­ã€‚æ¯”å¦‚ Web æœåŠ¡å™¨ï¼Œæ•°æ®åº“æœåŠ¡å™¨ç­‰ã€‚ä»¥ Web æœåŠ¡å™¨ä¸ºä¾‹ï¼Œå‡å¦‚ Web æœåŠ¡å™¨ä¼šæ”¶åˆ°å¤§é‡çŸ­æ—¶çš„ HTTP è¯·æ±‚ï¼Œå¦‚æœæ­¤æ—¶æˆ‘ä»¬ç®€å•çš„ä¸ºæ¯ä¸ª HTTP è¯·æ±‚åˆ›å»ºä¸€ä¸ªå¤„ç†çº¿ç¨‹ï¼Œé‚£ä¹ˆæœåŠ¡å™¨çš„èµ„æºå°†ä¼šå¾ˆå¿«è¢«è€—å°½ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»ç®¡ç†å¹¶å¤ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œä»¥é™åˆ¶èµ„æºçš„æ¶ˆè€—é‡ï¼Œä½†è¿™æ ·ä¼šä½¿ç”¨ç¨‹åºçš„é€»è¾‘å˜å¤æ‚ã€‚å¥½åœ¨ï¼Œå¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸å¿…é‚£æ ·åšã€‚åœ¨ JDK 1.5 ä¸­ï¼Œå®˜æ–¹å·²ç»æä¾›äº†å¼ºå¤§çš„çº¿ç¨‹æ± å·¥å…·ç±»ã€‚é€šè¿‡ä½¿ç”¨è¿™äº›å·¥å…·ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä½å»‰çš„ä»£ä»·ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯ã€‚åœ¨Javaç”¨æœ‰ä¸€ä¸ªExecutorså·¥å…·ç±»ï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå…¶æœ¬è´¨å°±æ˜¯newäº†ä¸€ä¸ªThreadPoolExecutorå¯¹è±¡ã€‚ è§‰å¾—å¾ˆæœ‰å¿…è¦å»å­¦ä¹ ä¸€ä¸‹çº¿ç¨‹æ± çš„ç›¸å…³åŸç†ã€‚æ¯•ç«Ÿçº¿ç¨‹æ± é™¤äº†è¦ç®¡ç†çº¿ç¨‹ï¼Œè¿˜è¦ç®¡ç†ä»»åŠ¡ï¼ŒåŒæ—¶è¿˜è¦å…·å¤‡ç»Ÿè®¡åŠŸèƒ½ã€‚æ‰€ä»¥å¤šäº†è§£ä¸€ç‚¹ï¼Œè¿˜æ˜¯å¯ä»¥æ‰©å……çœ¼ç•Œçš„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ›´ä¸ºç†Ÿæ‚‰çº¿ç¨‹æ± æŠ€æœ¯ã€‚2.Executorç»§æ‰¿å…³ç³»çº¿ç¨‹æ± æ‰€é‡‡ç”¨çš„æ¥å£å’Œç±»çš„ç»“æ„å¦‚ä¸‹å›¾å¦‚ä¸Šå›¾ï¼Œæœ€é¡¶å±‚çš„æ¥å£ Executor ä»…å£°æ˜äº†ä¸€ä¸ªæ–¹æ³•executeã€‚ExecutorService æ¥å£åœ¨å…¶çˆ¶ç±»æ¥å£åŸºç¡€ä¸Šï¼Œå£°æ˜äº†åŒ…å«ä½†ä¸é™äºshutdownã€submitã€invokeAllã€invokeAny ç­‰æ–¹æ³•ã€‚è‡³äº ScheduledExecutorService æ¥å£ï¼Œåˆ™æ˜¯å£°æ˜äº†ä¸€äº›å’Œå®šæ—¶ä»»åŠ¡ç›¸å…³çš„æ–¹æ³•ï¼Œæ¯”å¦‚ scheduleå’ŒscheduleAtFixedRateã€‚çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°æ˜¯åœ¨ ThreadPoolExecutor ç±»ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Executors è°ƒç”¨newFixedThreadPoolã€newSingleThreadExecutorå’ŒnewCachedThreadPoolç­‰æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± å‡æ˜¯ ThreadPoolExecutor ç±»å‹ã€‚ä»¥ä¸Šæ˜¯å¯¹çº¿ç¨‹æ± ç»§æ‰¿ä½“ç³»çš„ç®€å•ä»‹ç»ï¼Œè¿™é‡Œå…ˆè®©å¤§å®¶å¯¹çº¿ç¨‹æ± å¤§è‡´è½®å»“æœ‰ä¸€å®šçš„äº†è§£ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç»ä¸€ä¸‹çº¿ç¨‹æ± çš„å®ç°åŸç†ï¼Œç»§ç»­å¾€ä¸‹çœ‹å§ã€‚3.åŸç†åˆ†æ3.1æ ¸å¿ƒå…³ç³»åˆ†æ3.1.1æ ¸å¿ƒå‚æ•°ç®€ä»‹å¦‚ä¸ŠèŠ‚æ‰€è¯´ï¼Œçº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°å³ ThreadPoolExecutor ç±»ã€‚è¯¥ç±»åŒ…å«äº†å‡ ä¸ªæ ¸å¿ƒå±æ€§ï¼Œè¿™äº›å±æ€§åœ¨å¯åœ¨æ„é€ æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨ä»‹ç»æ ¸å¿ƒå±æ€§å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ ThreadPoolExecutor çš„æ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š12345678910111213141516171819202122public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler;&#125;å¦‚ä¸Šæ‰€ç¤ºï¼Œæ„é€ æ–¹æ³•çš„å‚æ•°å³æ ¸å¿ƒå‚æ•°ï¼Œè¿™é‡Œæˆ‘ç”¨ä¸€ä¸ªè¡¨æ ¼æ¥ç®€è¦è¯´æ˜ä¸€ä¸‹å„ä¸ªå‚æ•°çš„æ„ä¹‰ã€‚å¦‚ä¸‹ï¼šå‚æ•°è¯´æ˜corePoolSizeæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å½“çº¿ç¨‹æ•°å°äºè¯¥å€¼æ—¶ï¼Œçº¿ç¨‹æ± ä¼šä¼˜å…ˆåˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œæ–°ä»»åŠ¡maximumPoolSizeçº¿ç¨‹æ± æ‰€èƒ½ç»´æŠ¤çš„æœ€å¤§çº¿ç¨‹æ•°keepAliveTimeç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´workQueueä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºç¼“å­˜æœªæ‰§è¡Œçš„ä»»åŠ¡threadFactoryçº¿ç¨‹å·¥å‚ã€‚å¯é€šè¿‡å·¥å‚ä¸ºæ–°å»ºçš„çº¿ç¨‹è®¾ç½®æ›´æœ‰æ„ä¹‰çš„åå­—handleræ‹’ç»ç­–ç•¥ã€‚å½“çº¿ç¨‹æ± å’Œä»»åŠ¡é˜Ÿåˆ—å‡å¤„äºé¥±å’ŒçŠ¶æ€æ—¶ï¼Œä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°ä»»åŠ¡ã€‚é»˜è®¤æ˜¯ AbortPolicyï¼Œå³ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä»¥ä¸Šæ˜¯å„ä¸ªå‚æ•°çš„ç®€ä»‹ï¼Œä¸‹é¢æˆ‘å°†ä¼šé’ˆå¯¹éƒ¨åˆ†å‚æ•°è¿›è¡Œè¯¦ç»†è¯´æ˜ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚3.1.2çº¿ç¨‹åˆ›å»ºè§„åˆ™åœ¨ Java çº¿ç¨‹æ± å®ç°ä¸­ï¼Œçº¿ç¨‹æ± æ‰€èƒ½åˆ›å»ºçš„çº¿ç¨‹æ•°é‡å—é™äº corePoolSize å’Œ maximumPoolSize ä¸¤ä¸ªå‚æ•°å€¼ã€‚çº¿ç¨‹çš„åˆ›å»ºæ—¶æœºåˆ™å’Œ corePoolSize ä»¥åŠ workQueue ä¸¤ä¸ªå‚æ•°æœ‰å…³ã€‚ä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹çº¿ç¨‹åˆ›å»ºçš„4ä¸ªè§„åˆ™ï¼ˆçº¿ç¨‹æ± ä¸­æ— ç©ºé—²çº¿ç¨‹ï¼‰ï¼Œå¦‚ä¸‹ï¼šçº¿ç¨‹æ•°é‡å°äºcorePoolSize ï¼Œç›´æ¥æ–°åˆ›å»ºçº¿ç¨‹å¤„ç†ä»»åŠ¡çº¿ç¨‹æ•°é‡å¤§äºç­‰äºcorePoolSize ï¼ŒworkQueue æœªæ»¡æ—¶ï¼Œç¼“å­˜æ–°ä»»åŠ¡çº¿ç¨‹æ•°é‡å¤§äºç­‰äºcorePoolSize ï¼Œå°äºmaximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹å¤„ç†æ–°ä»»åŠ¡çº¿ç¨‹æ•°é‡å¤§äºç­‰äº maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ï¼Œåˆ™ä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°ä»»åŠ¡è§„åˆ™å¦‚ä¸‹åºå·è§„åˆ™åŠ¨ä½œ1çº¿ç¨‹æ•° &lt; corePoolSizeåˆ›å»ºæ–°çº¿ç¨‹2çº¿ç¨‹æ•° &gt;= corePoolSize ï¼Œä¸” workQueue æœªæ»¡ç¼“å­˜æ–°ä»»åŠ¡3corePoolSize â‰¤ çº¿ç¨‹æ•° ï¼œ maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡åˆ›å»ºæ–°çº¿ç¨‹4çº¿ç¨‹æ•° â‰¥ maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†3.1.3èµ„æºå›æ”¶è€ƒè™‘åˆ°ç³»ç»Ÿèµ„æºæ˜¯æœ‰é™çš„ï¼Œå¯¹äºçº¿ç¨‹æ± è¶…å‡º corePoolSize æ•°é‡çš„ç©ºé—²çº¿ç¨‹åº”è¿›è¡Œå›æ”¶æ“ä½œã€‚è¿›è¡Œæ­¤æ“ä½œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå³å›æ”¶æ—¶æœºã€‚ç›®å‰çš„å®ç°æ–¹å¼æ˜¯å½“çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTime åï¼Œè¿›è¡Œå›æ”¶ã€‚é™¤äº†æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹å¤–çš„çº¿ç¨‹å¯ä»¥è¿›è¡Œå›æ”¶ï¼Œæ ¸å¿ƒçº¿ç¨‹å†…çš„ç©ºé—²çº¿ç¨‹ä¹Ÿå¯ä»¥è¿›è¡Œå›æ”¶ã€‚å›æ”¶çš„å‰ææ˜¯allowCoreThreadTimeOutå±æ€§è¢«è®¾ç½®ä¸º trueï¼Œé€šè¿‡public void allowCoreThreadTimeOut(boolean) æ–¹æ³•å¯ä»¥è®¾ç½®å±æ€§å€¼ã€‚3.1.4æ’é˜Ÿç­–ç•¥å¦‚3.1.2 çº¿ç¨‹åˆ›å»ºè§„åˆ™ä¸€èŠ‚ä¸­è§„åˆ™2æ‰€è¯´ï¼Œå½“çº¿ç¨‹æ•°é‡å¤§äºç­‰äº corePoolSizeï¼ŒworkQueue æœªæ»¡æ—¶ï¼Œåˆ™ç¼“å­˜æ–°ä»»åŠ¡ã€‚è¿™é‡Œè¦è€ƒè™‘ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„å®¹å™¨ç¼“å­˜æ–°ä»»åŠ¡ï¼Œé€šè¿‡ JDK æ–‡æ¡£ä»‹ç»ï¼Œæˆ‘ä»¬å¯çŸ¥é“æœ‰3ä¸­ç±»å‹çš„å®¹å™¨å¯ä¾›ä½¿ç”¨ï¼Œåˆ†åˆ«æ˜¯åŒæ­¥é˜Ÿåˆ—ï¼Œæœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—ã€‚å¯¹äºæœ‰ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¿™é‡Œè¿˜å¯ä»¥å¢åŠ ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚ä»¥ä¸Šæ‰€ä»‹ç»çš„4ä¸­ç±»å‹çš„é˜Ÿåˆ—ï¼Œå¯¹åº”çš„å®ç°ç±»å¦‚ä¸‹ï¼šå®ç°ç±»ç±»å‹è¯´æ˜SynchronousQueueåŒæ­¥é˜Ÿåˆ—è¯¥é˜Ÿåˆ—ä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¼šä¸€ç›´é˜»å¡ArrayBlockingQueueæœ‰ç•Œé˜Ÿåˆ—åŸºäºæ•°ç»„çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ FIFO åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºLinkedBlockingQueueæ— ç•Œé˜Ÿåˆ—åŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ FIFO åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºPriorityBlockingQueueä¼˜å…ˆçº§é˜Ÿåˆ—å…·æœ‰ä¼˜å…ˆçº§çš„é˜»å¡é˜Ÿåˆ—3.1.5æ‹’ç»ç­–ç•¥å¦‚3.1.2 çº¿ç¨‹åˆ›å»ºè§„åˆ™ä¸€èŠ‚ä¸­è§„åˆ™4æ‰€è¯´ï¼Œçº¿ç¨‹æ•°é‡å¤§äºç­‰äº maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ï¼Œåˆ™ä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°ä»»åŠ¡ã€‚Java çº¿ç¨‹æ± æä¾›äº†4ä¸­æ‹’ç»ç­–ç•¥å®ç°ç±»ï¼Œå¦‚ä¸‹ï¼šå®ç°ç±»è¯´æ˜AbortPolicy ï¼ˆé»˜è®¤ï¼‰ä¸¢å¼ƒæ–°ä»»åŠ¡ï¼Œå¹¶æŠ›å‡º RejectedExecutionExceptionDiscardPolicyä¸åšä»»ä½•æ“ä½œï¼Œç›´æ¥ä¸¢å¼ƒæ–°ä»»åŠ¡DiscardOldestPolicyä¸¢å¼ƒé˜Ÿåˆ—é˜Ÿé¦–çš„å…ƒç´ ï¼Œå¹¶æ‰§è¡Œæ–°ä»»åŠ¡CallerRunsPolicyç”±è°ƒç”¨çº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ä»¥ä¸Š4ä¸ªæ‹’ç»ç­–ç•¥ä¸­ï¼ŒAbortPolicy æ˜¯çº¿ç¨‹æ± å®ç°ç±»æ‰€ä½¿ç”¨çš„ç­–ç•¥ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ–¹æ³•public void setRejectedExecutionHandler(RejectedExecutionHandler)ä¿®æ”¹çº¿ç¨‹æ± å†³ç»ç­–ç•¥ã€‚3.2 é‡è¦æ“ä½œ3.2.1çº¿ç¨‹çš„åˆ›å»ºä¸å¤ç”¨åœ¨çº¿ç¨‹æ± çš„å®ç°ä¸Šï¼Œçº¿ç¨‹çš„åˆ›å»ºæ˜¯é€šè¿‡çº¿ç¨‹å·¥å‚æ¥å£ThreadFactoryçš„å®ç°ç±»æ¥å®Œæˆçš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ä½¿ç”¨Executors.defaultThreadFactory()æ–¹æ³•è¿”å›çš„çº¿ç¨‹å·¥å‚å®ç°ç±»ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡public void setThreadFactory(ThreadFactory)æ–¹æ³•è¿›è¡ŒåŠ¨æ€ä¿®æ”¹ã€‚å…·ä½“ç»†èŠ‚è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œå¹¶ä¸å¤æ‚ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å»çœ‹ä¸‹æºç ã€‚åœ¨çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹çš„å¤ç”¨æ˜¯çº¿ç¨‹æ± çš„å…³é”®æ‰€åœ¨ã€‚è¿™å°±è¦æ±‚çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œä¸èƒ½ç«‹å³é€€å‡ºã€‚å¯¹åº”åˆ°å…·ä½“å®ç°ä¸Šï¼Œå·¥ä½œçº¿ç¨‹åœ¨æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œä¼šå†æ¬¡åˆ°ä»»åŠ¡é˜Ÿåˆ—è·å–æ–°çš„ä»»åŠ¡ã€‚å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œä¸” keepAliveTime ä¹Ÿæœªè¢«è®¾ç½®ï¼Œå·¥ä½œçº¿ç¨‹åˆ™ä¼šè¢«ä¸€è‡´é˜»å¡ä¸‹å»ã€‚é€šè¿‡è¿™ç§æ–¹å¼å³å¯å®ç°çº¿ç¨‹å¤ç”¨ã€‚è¯´å®ŒåŸç†ï¼Œå†æ¥çœ‹çœ‹çº¿ç¨‹çš„åˆ›å»ºå’Œå¤ç”¨çš„ç›¸å…³ä»£ç ï¼ˆåŸºäº JDK 1.8ï¼‰ï¼Œå¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120private final class Worker extends AbstractQueuedSynchronizer implements Runnable &#123; /** * This class will never be serialized, but we provide a * serialVersionUID to suppress a javac warning. */ private static final long serialVersionUID = 6138294804551838833L; /** Thread this worker is running in. Null if factory fails. */ final Thread thread; /** Initial task to run. Possibly null. */ Runnable firstTask; /** Per-thread task counter */ volatile long completedTasks; /** * Creates with given first task and thread from ThreadFactory. * @param firstTask the first task (null if none) */ Worker(Runnable firstTask) &#123; setState(-1); // inhibit interrupts until runWorker this.firstTask = firstTask; // è°ƒç”¨çº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹ this.thread = getThreadFactory().newThread(this); &#125; /** Delegates main run loop to outer runWorker */ public void run() &#123; //å…·ä½“çš„æ‰§è¡Œ runWorker(this); &#125; // Lock methods // // The value 0 represents the unlocked state. // The value 1 represents the locked state. protected boolean isHeldExclusively() &#123; return getState() != 0; &#125; protected boolean tryAcquire(int unused) &#123; if (compareAndSetState(0, 1)) &#123; setExclusiveOwnerThread(Thread.currentThread()); return true; &#125; return false; &#125; protected boolean tryRelease(int unused) &#123; setExclusiveOwnerThread(null); setState(0); return true; &#125; public void lock() &#123; acquire(1); &#125; public boolean tryLock() &#123; return tryAcquire(1); &#125; public void unlock() &#123; release(1); &#125; public boolean isLocked() &#123; return isHeldExclusively(); &#125; void interruptIfStarted() &#123; Thread t; if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) &#123; try &#123; t.interrupt(); &#125; catch (SecurityException ignore) &#123; &#125; &#125; &#125; &#125;//å…·ä½“çš„æ‰§è¡Œfinal void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // allow interrupts boolean completedAbruptly = true; try &#123; // å¾ªç¯ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–æ–°ä»»åŠ¡ while (task != null || (task = getTask()) != null) &#123; w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; // æ‰§è¡Œæ–°ä»»åŠ¡ task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125; &#125; finally &#123; task = null; w.completedTasks++; w.unlock(); &#125; &#125; completedAbruptly = false; &#125; finally &#123; // çº¿ç¨‹é€€å‡ºåï¼Œè¿›è¡Œåç»­å¤„ç† processWorkerExit(w, completedAbruptly); &#125; &#125;3.2.2 æäº¤ä»»åŠ¡é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡çº¿ç¨‹æ± çš„submitæ–¹æ³•æäº¤ä»»åŠ¡ã€‚è¢«æäº¤çš„ä»»åŠ¡å¯èƒ½ä¼šç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½ä¼šè¢«ç¼“å­˜æˆ–è€…è¢«æ‹’ç»ã€‚ä»»åŠ¡çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šä¸Šé¢çš„æµç¨‹å›¾ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä¸‹é¢å†æ¥çœ‹çœ‹æµç¨‹å›¾å¯¹åº”çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106+---- AbstractExecutorService.javapublic Future&lt;?&gt; submit(Runnable task) &#123; if (task == null) throw new NullPointerException(); // åˆ›å»ºä»»åŠ¡ RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null); // æäº¤ä»»åŠ¡ execute(ftask); return ftask;&#125;+---- ThreadPoolExecutor.javapublic void execute(Runnable command) &#123; if (command == null) throw new NullPointerException(); int c = ctl.get(); // å¦‚æœå·¥ä½œçº¿ç¨‹æ•°é‡ &lt; æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹ if (workerCountOf(c) &lt; corePoolSize) &#123; // æ·»åŠ å·¥ä½œè€…å¯¹è±¡ if (addWorker(command, true)) return; c = ctl.get(); &#125; // ç¼“å­˜ä»»åŠ¡ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ offer æ–¹æ³•è¿”å› falseã€‚å¦åˆ™ï¼Œoffer è¿”å› true if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; int recheck = ctl.get(); if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; // æ·»åŠ å·¥ä½œè€…å¯¹è±¡ï¼Œå¹¶åœ¨ addWorker æ–¹æ³•ä¸­æ£€æµ‹çº¿ç¨‹æ•°æ˜¯å¦å°äºæœ€å¤§çº¿ç¨‹æ•° else if (!addWorker(command, false)) // çº¿ç¨‹æ•° &gt;= æœ€å¤§çº¿ç¨‹æ•°ï¼Œä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡ reject(command);&#125;private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); // æ£€æµ‹å·¥ä½œçº¿ç¨‹æ•°ä¸æ ¸å¿ƒçº¿ç¨‹æ•°æˆ–æœ€å¤§çº¿ç¨‹æ•°çš„å…³ç³» if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; // åˆ›å»ºå·¥ä½œè€…å¯¹è±¡ï¼Œç»†èŠ‚å‚è€ƒä¸Šä¸€èŠ‚æ‰€è´´ä»£ç  w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); // å°† worker å¯¹è±¡æ·»åŠ åˆ° workers é›†åˆä¸­ workers.add(w); int s = workers.size(); // æ›´æ–° largestPoolSize å±æ€§ if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; // å¼€å§‹æ‰§è¡Œä»»åŠ¡ t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125;3.2.3 å…³é—­çº¿ç¨‹æ± æˆ‘ä»¬å¯ä»¥é€šè¿‡shutdownå’ŒshutdownNowä¸¤ä¸ªæ–¹æ³•å…³é—­çº¿ç¨‹æ± ã€‚ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œshutdown ä¼šå°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®ä¸ºSHUTDOWNï¼ŒåŒæ—¶è¯¥æ–¹æ³•è¿˜ä¼šä¸­æ–­ç©ºé—²çº¿ç¨‹ã€‚shutdownNow åˆ™ä¼šå°†çº¿ç¨‹æ± çŠ¶æ€è®¾ç½®ä¸ºSTOPï¼Œå¹¶å°è¯•ä¸­æ–­æ‰€æœ‰çš„çº¿ç¨‹ã€‚ä¸­æ–­çº¿ç¨‹ä½¿ç”¨çš„æ˜¯Thread.interruptæ–¹æ³•ï¼Œæœªå“åº”ä¸­æ–­æ–¹æ³•çš„ä»»åŠ¡æ˜¯æ— æ³•è¢«ä¸­æ–­çš„ã€‚æœ€åï¼ŒshutdownNow æ–¹æ³•ä¼šå°†æœªæ‰§è¡Œçš„ä»»åŠ¡å…¨éƒ¨è¿”å›ã€‚è°ƒç”¨ shutdown å’Œ shutdownNow æ–¹æ³•å…³é—­çº¿ç¨‹æ± åï¼Œå°±ä¸èƒ½å†å‘çº¿ç¨‹æ± æäº¤æ–°ä»»åŠ¡äº†ã€‚å¯¹äºå¤„äºå…³é—­çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œä¼šä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°æäº¤çš„ä»»åŠ¡ã€‚4.å‡ ç§çº¿ç¨‹æ± ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ç›´æ¥ä½¿ç”¨ ThreadPoolExecutor ç±»åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯é€šè¿‡ Executors å·¥å…·ç±»å»æ„å»ºçº¿ç¨‹æ± ã€‚é€šè¿‡ Executors å·¥å…·ç±»ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ 5ä¸­ä¸åŒçš„çº¿ç¨‹æ± ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªè¡¨æ ¼ç®€å•ä»‹ç»ä¸€ä¸‹å‡ ç§çº¿ç¨‹æ± ï¼Œå¦‚ä¸‹ï¼šæ„é€ æ–¹æ³•è¯´æ˜newFixedThreadPool(int nThreads)æ„å»ºåŒ…å«å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç©ºé—²çº¿ç¨‹ä¸ä¼šè¢«å›æ”¶newCachedThreadPool()æ„å»ºçº¿ç¨‹æ•°ä¸å®šçš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°é‡éšä»»åŠ¡é‡å˜åŠ¨ï¼Œç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´è¶…è¿‡60ç§’åä¼šè¢«å›æ”¶newSingleThreadExecutor()æ„å»ºçº¿ç¨‹æ•°ä¸º1çš„çº¿ç¨‹æ± ï¼Œç­‰ä»·äº newFixedThreadPool(1) æ‰€æ„é€ å‡ºçš„çº¿ç¨‹æ± newScheduledThreadPool(int corePoolSize)æ„å»ºæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º corePoolSizeï¼Œå¯æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± newSingleThreadScheduledExecutor()ç­‰ä»·äº newScheduledThreadPool(1)5.æ€»ç»“ä¸€èˆ¬éœ€è¦æ ¹æ®ä»»åŠ¡çš„ç±»å‹æ¥é…ç½®çº¿ç¨‹æ± å¤§å°ï¼šå¦‚æœæ˜¯CPUå¯†é›†å‹ä»»åŠ¡ï¼Œå°±éœ€è¦å°½é‡å‹æ¦¨CPUï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ä¸º NCPU+1ï¼›å¦‚æœæ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º2*NCPUã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå…·ä½“çš„è®¾ç½®è¿˜éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œæ¯”å¦‚å¯ä»¥å…ˆå°†çº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸ºå‚è€ƒå€¼ï¼Œå†è§‚å¯Ÿä»»åŠ¡è¿è¡Œæƒ…å†µå’Œç³»ç»Ÿè´Ÿè½½ã€èµ„æºåˆ©ç”¨ç‡æ¥è¿›è¡Œé€‚å½“è°ƒæ•´ã€‚å‚è€ƒhttp://developer.51cto.com/art/201203/321885.htmhttp://blog.csdn.net/cutesource/article/details/6061229http://blog.csdn.net/xieyuooo/article/details/8718741","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"http://localhost:4000/categories/JavaåŸºç¡€/"},{"name":"å¹¶å‘","slug":"JavaåŸºç¡€/å¹¶å‘","permalink":"http://localhost:4000/categories/JavaåŸºç¡€/å¹¶å‘/"}],"tags":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"http://localhost:4000/tags/JavaåŸºç¡€/"},{"name":"å¼€å‘","slug":"å¼€å‘","permalink":"http://localhost:4000/tags/å¼€å‘/"},{"name":"çº¿ç¨‹æ± ","slug":"çº¿ç¨‹æ± ","permalink":"http://localhost:4000/tags/çº¿ç¨‹æ± /"},{"name":"é”","slug":"é”","permalink":"http://localhost:4000/tags/é”/"}]},{"title":"ç®€æé™æµç®—æ³•","slug":"ç®€æé™æµç®—æ³•","date":"2019-06-15T15:24:02.000Z","updated":"2019-06-17T04:40:38.950Z","comments":true,"path":"2019/06/15/ç®€æé™æµç®—æ³•/","link":"","permalink":"http://localhost:4000/2019/06/15/ç®€æé™æµç®—æ³•/","excerpt":"","text":"1.ç®€ä»‹é™æµé¡¾åæ€ä¹‰æ˜¯é™åˆ¶æµé‡ï¼Œé™åˆ¶æµé‡çš„ç›®çš„æ˜¯ä¸ºäº†ä¿éšœæœåŠ¡ç¨³å®šè¿è¡Œï¼Œé¿å…æœåŠ¡è¢«æµé‡å†²å®ã€‚å½“æµé‡è¶…å‡ºæœåŠ¡å¤„ç†èƒ½åŠ›æ—¶ï¼Œéƒ¨åˆ†è¯·æ±‚å°†ä¼šè¢«é™æµç»„ä»¶æ‹¦æˆªã€‚è¢«æ‹¦æˆªçš„è¯·æ±‚å¯èƒ½ä¼šè¢«ä¸¢å¼ƒï¼Œå¦‚æœæ˜¯ C ç«¯è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚å¯èƒ½ä¼šè¢«å¯¼å‘æŒ‡å®šçš„é”™è¯¯é¡µä¸Šï¼Œè€Œä¸æ˜¯ç”Ÿç¡¬çš„æ‹’ç»ã€‚è¿™é‡Œæˆ‘ä»¬ä¸¢å¼ƒæ‰ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œä»¥ä¿è¯å¤§éƒ¨åˆ†è¯·æ±‚å¯ä»¥æ­£å¸¸å“åº”ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œé‚£ä¹ˆæœåŠ¡å´©æºƒåï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å°†æ— æ³•å“åº”äº†ã€‚å½“ä¸€å°æœºå™¨å´©æºƒåï¼Œè¯¥æœºå™¨çš„æ‰€æœ‰æµé‡å°†ç”±å…¶ä»–æœºå™¨æ‰¿æ‹…ï¼Œè¿™æ ·å°±ä¼šé€ æˆå‰©ä½™æœºå™¨å‹åŠ›å¢å¤§ï¼Œè¿›è€Œå¯¼è‡´å¥”æºƒï¼Œæœ€åå½¢æˆé›ªå´©ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒæœåŠ¡å´©æºƒè¿˜ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„ä¸¥é‡é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›æ•æ„Ÿæ•°æ®ã€‚æ¯”å¦‚å¯¹äºç”µå•†ç½‘ç«™ï¼Œå¦‚æœåå°æœåŠ¡å‡†å¤‡å°†æŸç¬”è®¢å•æ•°æ®å­˜å…¥æ•°æ®åº“æ—¶ï¼ŒæœåŠ¡çªç„¶å´©æºƒï¼Œå¯¼è‡´æ•°æ®æ²¡æœ‰è½åº“ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¼€å‘åŒå­¦å°±è¦æƒ³åŠæ³•ä¿®è®¢æ•°æ®äº†ã€‚ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥é™æµçš„é‡è¦æ€§ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°†å‘å¤§å®¶ä»‹ç»ä¸‰ç§å¸¸ç”¨çš„é™æµç®—æ³•ï¼Œåˆ†åˆ«æ˜¯è®¡æ•°å™¨ã€æ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ã€‚ä¸‹é¢æˆ‘ä»¬ä»æœ€ç®€å•çš„è®¡æ•°å™¨å¼€å§‹è¯´èµ·ã€‚2.é™æµç®—æ³•2.1 è®¡æ•°å™¨è®¡æ•°å™¨ç®—æ³•çš„æ€æƒ³å¾ˆç®€å•ï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬å°±å°†è®¡æ•°å™¨åŠ ä¸€ï¼Œå½“è®¡æ•°å™¨æ•°å€¼è¶…è¿‡é˜ˆå€¼åï¼Œå°±æ‹’ç»ä½™ä¸‹è¯·æ±‚ã€‚ä¸€ç§’é’Ÿåï¼Œæˆ‘ä»¬å°†è®¡æ•°å™¨æ¸…é›¶ï¼Œå¼€å§‹æ–°ä¸€è½®çš„è®¡æ•°ã€‚è®¡æ•°å™¨ç®—æ³•ç®€å•ç²—æš´ï¼Œæ˜“äºå®ç°ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€çªåˆºç°è±¡â€ã€‚ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬ç»™è®¡æ•°å™¨è®¾ç½®çš„é˜ˆå€¼ä¸º100ã€‚ç³»ç»Ÿç¬é—´å†…ï¼ˆæ¯”å¦‚10æ¯«ç§’å†…ï¼‰æœ‰200ä¸ªè¯·æ±‚åˆ°æ¥ï¼Œè¿™ä¸ªæ—¶å€™è®¡æ•°å™¨åªèƒ½æ”¾è¿‡å…¶ä¸­çš„100ä¸ªè¯·æ±‚ï¼Œä½™ä¸‹çš„100ä¸ªè¯·æ±‚å…¨éƒ¨è¢«æ‹’ç»æ‰ã€‚å¦‚æœç¬¬äºŒç§’å†…æ²¡æœ‰è¯·æ±‚åˆ°æ¥ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±å¤„äºç©ºé—²çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯ä¸Šä¸€ç§’å¿™çš„è¦æ­»ï¼Œè¿™ä¸€ç§’åˆé—²çš„è¦æ­»ã€‚å¦‚æœæˆ‘ä»¬èƒ½ç”¨ä¸€ä¸ªå®¹å™¨å°†å‰©ä½™çš„100ä¸ªè¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œå¾…è®¡æ•°å™¨é‡ç½®åå†å°†è¿™äº›è¯·æ±‚æ”¾å‡ºæ¥ã€‚è¿™æ ·ç³»ç»Ÿåœ¨è¿™ä¸¤ç§’å†…çš„ååé‡å°±ç”±100å˜æˆäº†200ï¼Œæå‡äº†ä¸€å€ã€‚åŸºäºè¿™ä¸ªæ€è€ƒï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹çœ‹æ¼æ¡¶ç®—æ³•ã€‚2.2 æ¼æ¡¶ç®—æ³•æ¼æ¡¶ç®—æ³•ç”±æµé‡å®¹å™¨ã€æµé‡å…¥å£å’Œå‡ºå£ç»„æˆã€‚å…¶ä¸­æµé‡å‡ºå£æµé€Ÿå³ä¸ºæˆ‘ä»¬æœŸæœ›çš„é™é€Ÿå€¼ï¼Œæ¯”å¦‚ 100 QPSã€‚æ¼æ¡¶ç®—æ³•é™¤äº†å…·å¤‡é™æµèƒ½åŠ›ï¼Œè¿˜å…·å¤‡æµé‡æ•´å‹åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€å¼ å›¾æ¥äº†è§£æ¼æ¡¶ç®—æ³•ã€‚å¦‚ä¸Šå›¾ï¼Œæµå…¥æ¼æ¡¶æµé‡çš„æµé€Ÿæ˜¯ä¸æ’å®šçš„ï¼Œç»è¿‡æ¼æ¡¶é™é€Ÿåï¼Œæµå‡ºæµé‡çš„é€Ÿåº¦æ˜¯æ’å®šçš„ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ¼æ¡¶çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œä¸€æ—¦æµå…¥æµé‡è¶…å‡ºæ¼æ¡¶å®¹é‡ï¼Œè¿™éƒ¨åˆ†æµé‡åªèƒ½è¢«ä¸¢å¼ƒäº†ã€‚æ¼æ¡¶æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é™æµæ•´å‹å·¥å…·ï¼Œä¸è¿‡æ¼æ¡¶ä¸èƒ½å¤„ç†çªå‘æµé‡ï¼Œä¸€äº›è§‚ç‚¹è®¤ä¸ºè¿™æ˜¯å®ƒçš„ä¸€ä¸ªç¼ºç‚¹ã€‚ä¸è¿‡å¦‚æœè¾ƒèµ·çœŸæ¥ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªç¼ºç‚¹æ˜¯ä¸æˆç«‹çš„ã€‚æ¯•ç«Ÿæ¼æ¡¶æœ¬å°±æ˜¯ç”¨æ¥å¹³æ»‘æµé‡çš„ï¼Œå¦‚æœæ”¯æŒçªå‘ï¼Œé‚£ä¹ˆè¾“å‡ºæµé‡åè€Œä¸å¹³æ»‘äº†ã€‚å¦‚æœè¦æ‰¾ä¸€ç§èƒ½å¤Ÿæ”¯æŒçªå‘æµé‡çš„é™æµç®—æ³•ï¼Œé‚£ä¹ˆä»¤ç‰Œæ¡¶ç®—æ³•å¯ä»¥æ»¡è¶³éœ€æ±‚2.3 ä»¤ç‰Œæ¡¶ç®—æ³•ä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶é¢‡æœ‰å‡ åˆ†ç›¸ä¼¼ï¼Œåªä¸è¿‡ä»¤ç‰Œé€šé‡Œå­˜æ”¾çš„æ˜¯ä»¤ç‰Œã€‚å®ƒçš„è¿è¡Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œä¸€ä¸ªä»¤ç‰Œå·¥å‚æŒ‰ç…§è®¾å®šå€¼å®šæœŸå‘ä»¤ç‰Œæ¡¶å‘æ”¾ä»¤ç‰Œã€‚å½“ä»¤ç‰Œæ¡¶æ»¡äº†åï¼Œå¤šå‡ºçš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒæ‰ã€‚æ¯å½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œè¯¥è¯·æ±‚å¯¹åº”çš„çº¿ç¨‹ä¼šä»ä»¤ç‰Œæ¡¶ä¸­å–ä»¤ç‰Œã€‚åˆæœŸç”±äºä»¤ç‰Œæ¡¶ä¸­å­˜æ”¾äº†å¾ˆå¤šä¸ªä»¤ç‰Œï¼Œå› æ­¤å…è®¸å¤šä¸ªè¯·æ±‚åŒæ—¶å–ä»¤ç‰Œã€‚å½“æ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œåï¼Œæ— æ³•è·å–åˆ°ä»¤ç‰Œçš„è¯·æ±‚å¯ä»¥ä¸¢å¼ƒï¼Œæˆ–è€…é‡è¯•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹çš„ä»¤ç‰Œæ¡¶ç¤ºæ„å›¾ï¼šå°½ç®¡ä»¤ç‰Œæ¡¶å…è®¸çªå‘æµé‡ï¼Œä½†çªå‘æµé‡é€Ÿç‡ R1 + é™æµé€Ÿç‡ R2 ä¸èƒ½è¶…è¿‡ç³»ç»Ÿæœ€å¤§çš„å¤„ç†èƒ½åŠ› Rtï¼Œå³ R1 + R2 â‰¤ Rt,å¦åˆ™ä¼šå†²å®ç³»ç»Ÿ3.RateLimiterç®€ä»‹Googleå¼€æºå·¥å…·åŒ…Guavaæä¾›äº†é™æµå·¥å…·ç±»RateLimiter,è¯¥ç±»åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•(Token Bucket)æ¥å®Œæˆé™æµ,éå¸¸æ˜“äºä½¿ç”¨.RateLimiterç»å¸¸ç”¨äºé™åˆ¶å¯¹ä¸€äº›ç‰©ç†èµ„æºæˆ–è€…é€»è¾‘èµ„æºçš„è®¿é—®é€Ÿç‡.å®ƒæ”¯æŒä¸¤ç§è·å–permitsæ¥å£,ä¸€ç§æ˜¯å¦‚æœæ‹¿ä¸åˆ°ç«‹åˆ»è¿”å›false,ä¸€ç§ä¼šé˜»å¡ç­‰å¾…ä¸€æ®µæ—¶é—´çœ‹èƒ½ä¸èƒ½æ‹¿åˆ°.RateLimiterå’ŒJavaä¸­çš„ä¿¡å·é‡(java.util.concurrent.Semaphore)ç±»ä¼¼,Semaphoreé€šå¸¸ç”¨äºé™åˆ¶å¹¶å‘é‡.æºç æ³¨é‡Šä¸­çš„ä¸€ä¸ªä¾‹å­,æ¯”å¦‚æˆ‘ä»¬æœ‰å¾ˆå¤šä»»åŠ¡éœ€è¦æ‰§è¡Œ,ä½†æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›æ¯ç§’è¶…è¿‡ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œ,é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨RateLimiter:1234567final RateLimiter rateLimiter = RateLimiter.create(2.0);void submitTasks(List&lt;Runnable&gt; tasks, Executor executor) &#123;for (Runnable task : tasks) &#123; rateLimiter.acquire(); // may wait executor.execute(task); &#125;&#125;å¦å¤–ä¸€ä¸ªä¾‹å­,å‡å¦‚æˆ‘ä»¬ä¼šäº§ç”Ÿä¸€ä¸ªæ•°æ®æµ,ç„¶åæˆ‘ä»¬æƒ³ä»¥æ¯ç§’5kbçš„é€Ÿåº¦å‘é€å‡ºå».æˆ‘ä»¬å¯ä»¥æ¯è·å–ä¸€ä¸ªä»¤ç‰Œ(permit)å°±å‘é€ä¸€ä¸ªbyteçš„æ•°æ®,è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸€ä¸ªæ¯ç§’5000ä¸ªä»¤ç‰Œçš„RateLimiteræ¥å®ç°:12345final RateLimiter rateLimiter = RateLimiter.create(5000.0);void submitPacket(byte[] packet) &#123; rateLimiter.acquire(packet.length); networkService.send(packet);&#125;4.å…¶ä»–é™æµå™¨ASP.NETç‰ˆæœ¬çš„ä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿé™æµå™¨:WebApiThrottle å‚è€ƒï¼šhttp://www.cnblogs.com/mushroom/archive/2015/07/21/4659200.htmlhttps://github.com/springside/springside4/wiki/Rate-Limiterhttps://en.wikipedia.org/wiki/Token_buckethttps://en.wikipedia.org/wiki/Leaky_bucket5.æ€»ç»“ä»¥ä¸Šå°±æ˜¯æœ¬ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹ã€‚æœ¬ç¯‡æ–‡ç« ç®€å•åˆ†æå‡ ç§å¸¸è§é™æµç®—æ³•çš„è¿è¡Œè¿‡ç¨‹ï¼Œé™äºèƒ½åŠ›åŸå› ï¼Œæ–‡ç« è‹¥æœ‰é”™è¯¯ä¸å¦¥ä¹‹å¤„è¿˜è¯·æŒ‡æ˜ã€‚å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ã€‚","categories":[{"name":"ä¸­é—´ä»¶","slug":"ä¸­é—´ä»¶","permalink":"http://localhost:4000/categories/ä¸­é—´ä»¶/"},{"name":"é™æµç»„ä»¶","slug":"ä¸­é—´ä»¶/é™æµç»„ä»¶","permalink":"http://localhost:4000/categories/ä¸­é—´ä»¶/é™æµç»„ä»¶/"}],"tags":[{"name":"é™æµç»„ä»¶","slug":"é™æµç»„ä»¶","permalink":"http://localhost:4000/tags/é™æµç»„ä»¶/"}]},{"title":"ä¸‰ç§åˆ†å¸ƒå¼é”å®ç°","slug":"ä¸‰ç§åˆ†å¸ƒå¼é”å®ç°","date":"2019-06-15T14:24:02.000Z","updated":"2019-06-17T04:45:11.514Z","comments":true,"path":"2019/06/15/ä¸‰ç§åˆ†å¸ƒå¼é”å®ç°/","link":"","permalink":"http://localhost:4000/2019/06/15/ä¸‰ç§åˆ†å¸ƒå¼é”å®ç°/","excerpt":"","text":"1.ç®€ä»‹å¯¹äºå•æœºæ¨¡å¼ï¼Œå¤šä¸ªçº¿ç¨‹å¯¹ä¸€ä¸ªå…±äº«å˜é‡è¿›è¡Œè®¿é—®å’Œä¿®æ”¹æ—¶ï¼Œ æˆ‘ä»¬å¯ä»¥é‡‡ç”¨Javaå¤šçº¿ç¨‹è¿›è¡Œå¤„ç†ï¼Œæ‰€æœ‰çš„è¯·æ±‚ä¼šåˆ†é…åˆ°æœ¬æœºçš„JVMå†…éƒ¨ï¼Œç„¶åæ˜ å°„åˆ°æ“ä½œç³»ç»Ÿè¿›è¡Œå¤„ç†ã€‚éšç€ä¸šåŠ¡çš„å‘å±•ï¼Œéœ€è¦å¯¹æœåŠ¡è¿›è¡Œé›†ç¾¤ï¼Œä¸€ä¸ªåº”ç”¨ä¼šéƒ¨ç½²åˆ°ä¸åŒçš„æœºå™¨ä¸Šï¼Œå…±äº«æ•°æ®ä¼šåœ¨ä¸åŒæœºå™¨çš„ä¸åŒJVMå†…å­˜ï¼ŒåŒæ—¶ä¸åŒæœºå™¨çš„ä¸­çš„å˜é‡ä¹Ÿæ˜¯ä¸å­˜åœ¨å…±äº«ï¼Œä¹Ÿä¸å…·æœ‰å¯è§æ€§ï¼Œå¦‚æœä¸åŠ ä»¥æ§åˆ¶çš„è¯ï¼Œå¤„ç†çš„å¾—åˆ°çš„ç»“æœä¹Ÿè®¸ä¸æ˜¯æˆ‘ä»¬æ‰€æœŸæœ›çš„å€¼ã€‚ä¸ºäº†ä¿è¯åŒä¸€æ—¶é—´å†…ï¼ŒåŒä¸€ä¸ªæ–¹æ³•æˆ–è€…å±æ€§å˜é‡åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹åªä¼šè¢«åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œåœ¨ä¼ ç»Ÿçš„å•æœºæ¨¡å¼ä¸‹ï¼Œé‡‡ç”¨Javaå¹¶å‘å¤„ç†åŒ…ï¼ˆå¦‚ReentrantLockæˆ–Synchronized)è¿›è¡Œäº’æ–¥æ§åˆ¶å³å¯ã€‚ä½†æ˜¯å¯¹äºåˆ†å¸ƒå¼é›†ç¾¤ç³»ç»Ÿä¸­ï¼Œç”±äºå¤šçº¿ç¨‹åˆ†å¸ƒåœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼ŒåŸå•æœºéƒ¨ç½²æƒ…å†µä¸‹çš„å¹¶å‘æ§åˆ¶é”ç­–ç•¥å¤±æ•ˆï¼Œå•çº¯çš„Java APIå¹¶ä¸èƒ½æä¾›åˆ†å¸ƒå¼é”çš„èƒ½åŠ›ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜å°±éœ€è¦ä¸€ç§è·¨JVMçš„äº’æ–¥æœºåˆ¶æ¥æ§åˆ¶å…±äº«èµ„æºçš„è®¿é—®ï¼Œè¿™å°±æ˜¯åˆ†å¸ƒå¼é”è¦è§£å†³çš„é—®é¢˜ï¼2.åˆ†å¸ƒå¼é”å…·å¤‡å“ªäº›æ¡ä»¶åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿç¯å¢ƒä¸‹ï¼Œä¸€ä¸ªæ–¹æ³•åœ¨åŒä¸€æ—¶é—´åªèƒ½è¢«ä¸€ä¸ªæœºå™¨çš„ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼›é«˜å¯ç”¨çš„è·å–é”ä¸é‡Šæ”¾é”ï¼›é«˜æ€§èƒ½çš„è·å–é”ä¸é‡Šæ”¾é”ï¼›å…·å¤‡å¯é‡å…¥ç‰¹æ€§ï¼›å…·å¤‡é”å¤±æ•ˆæœºåˆ¶ï¼Œé˜²æ­¢æ­»é”ï¼›å…·å¤‡éé˜»å¡é”ç‰¹æ€§ï¼Œå³æ²¡æœ‰è·å–åˆ°é”å°†ç›´æ¥è¿”å›è·å–é”å¤±è´¥ã€‚3.åˆ†å¸ƒå¼é”çš„ä¸‰ç§å®ç°æ–¹å¼3.1 åŸºäºæ•°æ®åº“å®ç°3.1.1 åŸºäºæ•°æ®åº“è¡¨çš„å®ç°è¦å®ç°åˆ†å¸ƒå¼é”ï¼Œæœ€ç®€å•çš„æ–¹å¼æ˜¯ç›´æ¥åˆ›å»ºä¸€å¼ é”è¡¨ï¼Œç„¶åé€šè¿‡æ“ä½œè¯¥è¡¨çš„æ•°æ®æ¥å®ç°ã€‚å½“æˆ‘ä»¬è¦é”ä½æŸä¸ªæ–¹æ³•æˆ–èµ„æºæ—¶ï¼Œæˆ‘ä»¬å°±åœ¨è¯¥è¡¨ä¸­å¢åŠ ä¸€æ¡è®°å½•ï¼Œæƒ³è¦é‡Šæ”¾é”çš„æ—¶å€™å°±åˆ é™¤è¿™æ¡è®°å½•ã€‚åˆ›å»ºè¿™æ ·ä¸€å¼ æ•°æ®åº“è¡¨ï¼š12345678CREATE TABLE `methodLock` ( `id` int(11) NOT NULL AUTO_INCREMENT COMMENT &apos;ä¸»é”®&apos;, `method_name` varchar(64) NOT NULL DEFAULT &apos;&apos; COMMENT &apos;é”å®šçš„æ–¹æ³•å&apos;, `desc` varchar(1024) NOT NULL DEFAULT &apos;å¤‡æ³¨ä¿¡æ¯&apos;, `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &apos;ä¿å­˜æ•°æ®æ—¶é—´ï¼Œè‡ªåŠ¨ç”Ÿæˆ&apos;, PRIMARY KEY (`id`), UNIQUE KEY `uidx_method_name` (`method_name `) USING BTREE) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&apos;é”å®šä¸­çš„æ–¹æ³•&apos;;å½“æˆ‘ä»¬æƒ³è¦é”ä½æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ‰§è¡Œä»¥ä¸‹SQLï¼š1insert into methodLock(method_name,desc) values (â€˜method_nameâ€™,â€˜descâ€™)å› ä¸ºæˆ‘ä»¬å¯¹method_nameåšäº†å”¯ä¸€æ€§çº¦æŸï¼Œè¿™é‡Œå¦‚æœæœ‰å¤šä¸ªè¯·æ±‚åŒæ—¶æäº¤åˆ°æ•°æ®åº“çš„è¯ï¼Œæ•°æ®åº“ä¼šä¿è¯åªæœ‰ä¸€ä¸ªæ“ä½œå¯ä»¥æˆåŠŸï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥è®¤ä¸ºæ“ä½œæˆåŠŸçš„é‚£ä¸ªçº¿ç¨‹è·å¾—äº†è¯¥æ–¹æ³•çš„é”ï¼Œå¯ä»¥æ‰§è¡Œæ–¹æ³•ä½“å†…å®¹ã€‚å½“æ–¹æ³•æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæƒ³è¦é‡Šæ”¾é”çš„è¯ï¼Œéœ€è¦æ‰§è¡Œä»¥ä¸‹Sql:1delete from methodLock where method_name =&apos;method_name&apos;ä¸Šé¢è¿™ç§ç®€å•çš„å®ç°æœ‰ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼šè¿™æŠŠé”å¼ºä¾èµ–æ•°æ®åº“çš„å¯ç”¨æ€§ï¼Œæ•°æ®åº“æ˜¯ä¸€ä¸ªå•ç‚¹ï¼Œä¸€æ—¦æ•°æ®åº“æŒ‚æ‰ï¼Œä¼šå¯¼è‡´ä¸šåŠ¡ç³»ç»Ÿä¸å¯ç”¨ã€‚è¿™æŠŠé”æ²¡æœ‰å¤±æ•ˆæ—¶é—´ï¼Œä¸€æ—¦è§£é”æ“ä½œå¤±è´¥ï¼Œå°±ä¼šå¯¼è‡´é”è®°å½•ä¸€ç›´åœ¨æ•°æ®åº“ä¸­ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†è·å¾—åˆ°é”ã€‚è¿™æŠŠé”åªèƒ½æ˜¯éé˜»å¡çš„ï¼Œå› ä¸ºæ•°æ®çš„insertæ“ä½œï¼Œä¸€æ—¦æ’å…¥å¤±è´¥å°±ä¼šç›´æ¥æŠ¥é”™ã€‚æ²¡æœ‰è·å¾—é”çš„çº¿ç¨‹å¹¶ä¸ä¼šè¿›å…¥æ’é˜Ÿé˜Ÿåˆ—ï¼Œè¦æƒ³å†æ¬¡è·å¾—é”å°±è¦å†æ¬¡è§¦å‘è·å¾—é”æ“ä½œã€‚è¿™æŠŠé”æ˜¯éé‡å…¥çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åœ¨æ²¡æœ‰é‡Šæ”¾é”ä¹‹å‰æ— æ³•å†æ¬¡è·å¾—è¯¥é”ã€‚å› ä¸ºæ•°æ®ä¸­æ•°æ®å·²ç»å­˜åœ¨äº†ã€‚é’ˆå¯¹ä¸Šé¢çš„é—®é¢˜ï¼Œå¯ä»¥é‡‡ç”¨ä»¥ä¸‹æ–¹å¼æ•°æ®åº“æ˜¯å•ç‚¹ï¼Ÿæä¸¤ä¸ªæ•°æ®åº“ï¼Œæ•°æ®ä¹‹å‰åŒå‘åŒæ­¥ã€‚ä¸€æ—¦æŒ‚æ‰å¿«é€Ÿåˆ‡æ¢åˆ°å¤‡åº“ä¸Šã€‚æ²¡æœ‰å¤±æ•ˆæ—¶é—´ï¼Ÿåªè¦åšä¸€ä¸ªå®šæ—¶ä»»åŠ¡ï¼Œæ¯éš”ä¸€å®šæ—¶é—´æŠŠæ•°æ®åº“ä¸­çš„è¶…æ—¶æ•°æ®æ¸…ç†ä¸€éã€‚éé˜»å¡çš„ï¼Ÿæä¸€ä¸ªwhileå¾ªç¯ï¼Œç›´åˆ°insertæˆåŠŸå†è¿”å›æˆåŠŸã€‚éé‡å…¥çš„ï¼Ÿåœ¨æ•°æ®åº“è¡¨ä¸­åŠ ä¸ªå­—æ®µï¼Œè®°å½•å½“å‰è·å¾—é”çš„æœºå™¨çš„ä¸»æœºä¿¡æ¯å’Œçº¿ç¨‹ä¿¡æ¯ï¼Œé‚£ä¹ˆä¸‹æ¬¡å†è·å–é”çš„æ—¶å€™å…ˆæŸ¥è¯¢æ•°æ®åº“ï¼Œå¦‚æœå½“å‰æœºå™¨çš„ä¸»æœºä¿¡æ¯å’Œçº¿ç¨‹ä¿¡æ¯åœ¨æ•°æ®åº“å¯ä»¥æŸ¥åˆ°çš„è¯ï¼Œç›´æ¥æŠŠé”åˆ†é…ç»™ä»–å°±å¯ä»¥äº†ã€‚3.1.2 åŸºäºæ•°æ®åº“è¡¨çš„æ’ä»–é”é™¤äº†å¯ä»¥é€šè¿‡å¢åˆ æ“ä½œæ•°æ®è¡¨ä¸­çš„è®°å½•ä»¥å¤–ï¼Œå…¶å®è¿˜å¯ä»¥å€ŸåŠ©æ•°æ®ä¸­è‡ªå¸¦çš„é”æ¥å®ç°åˆ†å¸ƒå¼çš„é”ã€‚æˆ‘ä»¬è¿˜ç”¨åˆšåˆšåˆ›å»ºçš„é‚£å¼ æ•°æ®åº“è¡¨ã€‚å¯ä»¥é€šè¿‡æ•°æ®åº“çš„æ’ä»–é”æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚ åŸºäºMySqlçš„InnoDBå¼•æ“ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•æ¥å®ç°åŠ é”æ“ä½œï¼š123456789101112131415public boolean lock()&#123; connection.setAutoCommit(false) while(true)&#123; try&#123; result = select * from methodLock where method_name=xxx for update; if(result==null)&#123; return true; &#125; &#125;catch(Exception e)&#123; &#125; sleep(1000); &#125; return false;&#125;åœ¨æŸ¥è¯¢è¯­å¥åé¢å¢åŠ for updateï¼Œæ•°æ®åº“ä¼šåœ¨æŸ¥è¯¢è¿‡ç¨‹ä¸­ç»™æ•°æ®åº“è¡¨å¢åŠ æ’ä»–é”ï¼ˆè¿™é‡Œå†å¤šæä¸€å¥ï¼ŒInnoDBå¼•æ“åœ¨åŠ é”çš„æ—¶å€™ï¼Œåªæœ‰é€šè¿‡ç´¢å¼•è¿›è¡Œæ£€ç´¢çš„æ—¶å€™æ‰ä¼šä½¿ç”¨è¡Œçº§é”ï¼Œå¦åˆ™ä¼šä½¿ç”¨è¡¨çº§é”ã€‚è¿™é‡Œæˆ‘ä»¬å¸Œæœ›ä½¿ç”¨è¡Œçº§é”ï¼Œå°±è¦ç»™method_nameæ·»åŠ ç´¢å¼•ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸ªç´¢å¼•ä¸€å®šè¦åˆ›å»ºæˆå”¯ä¸€ç´¢å¼•ï¼Œå¦åˆ™ä¼šå‡ºç°å¤šä¸ªé‡è½½æ–¹æ³•ä¹‹é—´æ— æ³•åŒæ—¶è¢«è®¿é—®çš„é—®é¢˜ã€‚é‡è½½æ–¹æ³•çš„è¯å»ºè®®æŠŠå‚æ•°ç±»å‹ä¹ŸåŠ ä¸Šã€‚ï¼‰ã€‚å½“æŸæ¡è®°å½•è¢«åŠ ä¸Šæ’ä»–é”ä¹‹åï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•å†åœ¨è¯¥è¡Œè®°å½•ä¸Šå¢åŠ æ’ä»–é”ã€‚æˆ‘ä»¬å¯ä»¥è®¤ä¸ºè·å¾—æ’å®ƒé”çš„çº¿ç¨‹å³å¯è·å¾—åˆ†å¸ƒå¼é”ï¼Œå½“è·å–åˆ°é”ä¹‹åï¼Œå¯ä»¥æ‰§è¡Œæ–¹æ³•çš„ä¸šåŠ¡é€»è¾‘ï¼Œæ‰§è¡Œå®Œæ–¹æ³•ä¹‹åï¼Œå†é€šè¿‡ä»¥ä¸‹æ–¹æ³•è§£é”ï¼š123public void unlock()&#123; connection.commit();&#125;é€šè¿‡connection.commit()æ“ä½œæ¥é‡Šæ”¾é”ã€‚è¿™ç§æ–¹æ³•å¯ä»¥æœ‰æ•ˆçš„è§£å†³ä¸Šé¢æåˆ°çš„æ— æ³•é‡Šæ”¾é”å’Œé˜»å¡é”çš„é—®é¢˜ã€‚é˜»å¡é”ï¼Ÿ for updateè¯­å¥ä¼šåœ¨æ‰§è¡ŒæˆåŠŸåç«‹å³è¿”å›ï¼Œåœ¨æ‰§è¡Œå¤±è´¥æ—¶ä¸€ç›´å¤„äºé˜»å¡çŠ¶æ€ï¼Œç›´åˆ°æˆåŠŸã€‚é”å®šä¹‹åæœåŠ¡å®•æœºï¼Œæ— æ³•é‡Šæ”¾ï¼Ÿä½¿ç”¨è¿™ç§æ–¹å¼ï¼ŒæœåŠ¡å®•æœºä¹‹åæ•°æ®åº“ä¼šè‡ªå·±æŠŠé”é‡Šæ”¾æ‰ã€‚ä½†æ˜¯è¿˜æ˜¯æ— æ³•ç›´æ¥è§£å†³æ•°æ®åº“å•ç‚¹å’Œå¯é‡å…¥é—®é¢˜ã€‚è¿™é‡Œè¿˜å¯èƒ½å­˜åœ¨å¦å¤–ä¸€ä¸ªé—®é¢˜ï¼Œè™½ç„¶æˆ‘ä»¬å¯¹method_name ä½¿ç”¨äº†å”¯ä¸€ç´¢å¼•ï¼Œå¹¶ä¸”æ˜¾ç¤ºä½¿ç”¨for updateæ¥ä½¿ç”¨è¡Œçº§é”ã€‚ä½†æ˜¯ï¼ŒMySqlä¼šå¯¹æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ï¼Œå³ä¾¿åœ¨æ¡ä»¶ä¸­ä½¿ç”¨äº†ç´¢å¼•å­—æ®µï¼Œä½†æ˜¯å¦ä½¿ç”¨ç´¢å¼•æ¥æ£€ç´¢æ•°æ®æ˜¯ç”± MySQL é€šè¿‡åˆ¤æ–­ä¸åŒæ‰§è¡Œè®¡åˆ’çš„ä»£ä»·æ¥å†³å®šçš„ï¼Œå¦‚æœ MySQL è®¤ä¸ºå…¨è¡¨æ‰«æ•ˆç‡æ›´é«˜ï¼Œæ¯”å¦‚å¯¹ä¸€äº›å¾ˆå°çš„è¡¨ï¼Œå®ƒå°±ä¸ä¼šä½¿ç”¨ç´¢å¼•ï¼Œè¿™ç§æƒ…å†µä¸‹ InnoDB å°†ä½¿ç”¨è¡¨é”ï¼Œè€Œä¸æ˜¯è¡Œé”ã€‚å¦‚æœå‘ç”Ÿè¿™ç§æƒ…å†µå°±æ‚²å‰§äº†ã€‚è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æˆ‘ä»¬è¦ä½¿ç”¨æ’ä»–é”æ¥è¿›è¡Œåˆ†å¸ƒå¼é”çš„lockï¼Œé‚£ä¹ˆä¸€ä¸ªæ’ä»–é”é•¿æ—¶é—´ä¸æäº¤ï¼Œå°±ä¼šå ç”¨æ•°æ®åº“è¿æ¥ã€‚ä¸€æ—¦ç±»ä¼¼çš„è¿æ¥å˜å¾—å¤šäº†ï¼Œå°±å¯èƒ½æŠŠæ•°æ®åº“è¿æ¥æ± æ’‘çˆ†3.1.3æ€»ç»“æ€»ç»“ä¸€ä¸‹ä½¿ç”¨æ•°æ®åº“æ¥å®ç°åˆ†å¸ƒå¼é”çš„æ–¹å¼ï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½æ˜¯ä¾èµ–æ•°æ®åº“çš„ä¸€å¼ è¡¨ï¼Œä¸€ç§æ˜¯é€šè¿‡è¡¨ä¸­çš„è®°å½•çš„å­˜åœ¨æƒ…å†µç¡®å®šå½“å‰æ˜¯å¦æœ‰é”å­˜åœ¨ï¼Œå¦å¤–ä¸€ç§æ˜¯é€šè¿‡æ•°æ®åº“çš„æ’ä»–é”æ¥å®ç°åˆ†å¸ƒå¼é”ã€‚æ•°æ®åº“å®ç°åˆ†å¸ƒå¼é”çš„ä¼˜ç‚¹æ˜¯ç›´æ¥å€ŸåŠ©æ•°æ®åº“ï¼Œå®¹æ˜“ç†è§£ï¼Œæ–¹ä¾¿ä½¿ç”¨ã€‚ä½†æ˜¯ä¼šæœ‰å„ç§å„æ ·çš„é—®é¢˜ï¼Œåœ¨è§£å†³é—®é¢˜çš„è¿‡ç¨‹ä¸­ä¼šä½¿æ•´ä¸ªæ–¹æ¡ˆå˜å¾—è¶Šæ¥è¶Šå¤æ‚ï¼Œå¦å¤–æ“ä½œæ“ä½œæ•°æ®åº“éœ€è¦ä¸€å®šçš„å¼€é”€ï¼Œæ€§èƒ½é—®é¢˜éœ€è¦è€ƒè™‘ã€‚ä½¿ç”¨æ•°æ®åº“çš„è¡Œçº§é”å¹¶ä¸ä¸€å®šé è°±ï¼Œå°¤å…¶æ˜¯å½“æˆ‘ä»¬çš„é”è¡¨å¹¶ä¸å¤§çš„æ—¶å€™ã€‚3.2 åŸºäºrediså®ç°3.2.1 åŠ é”ä»£ç ä»£ç å¦‚ä¸‹1234567891011121314151617181920212223242526public class RedisTool &#123; private static final String LOCK_SUCCESS = \"OK\"; private static final String SET_IF_NOT_EXIST = \"NX\"; private static final String SET_WITH_EXPIRE_TIME = \"PX\"; /** * å°è¯•è·å–åˆ†å¸ƒå¼é” * @param jedis Rediså®¢æˆ·ç«¯ * @param lockKey é” * @param requestId è¯·æ±‚æ ‡è¯† * @param expireTime è¶…æœŸæ—¶é—´ * @return æ˜¯å¦è·å–æˆåŠŸ */ public static boolean tryGetDistributedLock(Jedis jedis, String lockKey, String requestId, int expireTime) &#123; String result = jedis.set(lockKey, requestId, SET_IF_NOT_EXIST, SET_WITH_EXPIRE_TIME, expireTime); if (LOCK_SUCCESS.equals(result)) &#123; return true; &#125; return false; &#125;&#125;å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åŠ é”å°±ä¸€è¡Œä»£ç ï¼šjedis.set(String key, String value, String nxxx, String expx, int time)ï¼Œè¿™ä¸ªset()æ–¹æ³•ä¸€å…±æœ‰äº”ä¸ªå½¢å‚ï¼šç¬¬ä¸€ä¸ªä¸ºkeyï¼Œæˆ‘ä»¬ä½¿ç”¨keyæ¥å½“é”ï¼Œå› ä¸ºkeyæ˜¯å”¯ä¸€çš„ã€‚ç¬¬äºŒä¸ªä¸ºvalueï¼Œæˆ‘ä»¬ä¼ çš„æ˜¯requestIdï¼Œå¾ˆå¤šç«¥é‹å¯èƒ½ä¸æ˜ç™½ï¼Œæœ‰keyä½œä¸ºé”ä¸å°±å¤Ÿäº†å—ï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨åˆ°valueï¼ŸåŸå› å°±æ˜¯æˆ‘ä»¬åœ¨ä¸Šé¢è®²åˆ°å¯é æ€§æ—¶ï¼Œåˆ†å¸ƒå¼é”è¦æ»¡è¶³ç¬¬å››ä¸ªæ¡ä»¶è§£é“ƒè¿˜é¡»ç³»é“ƒäººï¼Œé€šè¿‡ç»™valueèµ‹å€¼ä¸ºrequestIdï¼Œæˆ‘ä»¬å°±çŸ¥é“è¿™æŠŠé”æ˜¯å“ªä¸ªè¯·æ±‚åŠ çš„äº†ï¼Œåœ¨è§£é”çš„æ—¶å€™å°±å¯ä»¥æœ‰ä¾æ®ã€‚requestIdå¯ä»¥ä½¿ç”¨UUID.randomUUID().toString()æ–¹æ³•ç”Ÿæˆã€‚ç¬¬ä¸‰ä¸ªä¸ºnxxxï¼Œè¿™ä¸ªå‚æ•°æˆ‘ä»¬å¡«çš„æ˜¯NXï¼Œæ„æ€æ˜¯SET IF NOT EXISTï¼Œå³å½“keyä¸å­˜åœ¨æ—¶ï¼Œæˆ‘ä»¬è¿›è¡Œsetæ“ä½œï¼›è‹¥keyå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸åšä»»ä½•æ“ä½œï¼›ç¬¬å››ä¸ªä¸ºexpxï¼Œè¿™ä¸ªå‚æ•°æˆ‘ä»¬ä¼ çš„æ˜¯PXï¼Œæ„æ€æ˜¯æˆ‘ä»¬è¦ç»™è¿™ä¸ªkeyåŠ ä¸€ä¸ªè¿‡æœŸçš„è®¾ç½®ï¼Œå…·ä½“æ—¶é—´ç”±ç¬¬äº”ä¸ªå‚æ•°å†³å®šã€‚ç¬¬äº”ä¸ªä¸ºtimeï¼Œä¸ç¬¬å››ä¸ªå‚æ•°ç›¸å‘¼åº”ï¼Œä»£è¡¨keyçš„è¿‡æœŸæ—¶é—´ã€‚æ€»çš„æ¥è¯´ï¼Œæ‰§è¡Œä¸Šé¢çš„set()æ–¹æ³•å°±åªä¼šå¯¼è‡´ä¸¤ç§ç»“æœï¼š1. å½“å‰æ²¡æœ‰é”ï¼ˆkeyä¸å­˜åœ¨ï¼‰ï¼Œé‚£ä¹ˆå°±è¿›è¡ŒåŠ é”æ“ä½œï¼Œå¹¶å¯¹é”è®¾ç½®ä¸ªæœ‰æ•ˆæœŸï¼ŒåŒæ—¶valueè¡¨ç¤ºåŠ é”çš„å®¢æˆ·ç«¯ã€‚2. å·²æœ‰é”å­˜åœ¨ï¼Œä¸åšä»»ä½•æ“ä½œã€‚å¿ƒç»†çš„ç«¥é‹å°±ä¼šå‘ç°äº†ï¼Œæˆ‘ä»¬çš„åŠ é”ä»£ç æ»¡è¶³æˆ‘ä»¬å¯é æ€§é‡Œæè¿°çš„ä¸‰ä¸ªæ¡ä»¶ã€‚é¦–å…ˆï¼Œset()åŠ å…¥äº†NXå‚æ•°ï¼Œå¯ä»¥ä¿è¯å¦‚æœå·²æœ‰keyå­˜åœ¨ï¼Œåˆ™å‡½æ•°ä¸ä¼šè°ƒç”¨æˆåŠŸï¼Œä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªå®¢æˆ·ç«¯èƒ½æŒæœ‰é”ï¼Œæ»¡è¶³äº’æ–¥æ€§ã€‚å…¶æ¬¡ï¼Œç”±äºæˆ‘ä»¬å¯¹é”è®¾ç½®äº†è¿‡æœŸæ—¶é—´ï¼Œå³ä½¿é”çš„æŒæœ‰è€…åç»­å‘ç”Ÿå´©æºƒè€Œæ²¡æœ‰è§£é”ï¼Œé”ä¹Ÿä¼šå› ä¸ºåˆ°äº†è¿‡æœŸæ—¶é—´è€Œè‡ªåŠ¨è§£é”ï¼ˆå³keyè¢«åˆ é™¤ï¼‰ï¼Œä¸ä¼šå‘ç”Ÿæ­»é”ã€‚æœ€åï¼Œå› ä¸ºæˆ‘ä»¬å°†valueèµ‹å€¼ä¸ºrequestIdï¼Œä»£è¡¨åŠ é”çš„å®¢æˆ·ç«¯è¯·æ±‚æ ‡è¯†ï¼Œé‚£ä¹ˆåœ¨å®¢æˆ·ç«¯åœ¨è§£é”çš„æ—¶å€™å°±å¯ä»¥è¿›è¡Œæ ¡éªŒæ˜¯å¦æ˜¯åŒä¸€ä¸ªå®¢æˆ·ç«¯ã€‚ç”±äºæˆ‘ä»¬åªè€ƒè™‘Rediså•æœºéƒ¨ç½²çš„åœºæ™¯ï¼Œæ‰€ä»¥å®¹é”™æ€§æˆ‘ä»¬æš‚ä¸è€ƒè™‘ã€‚æ¯”è¾ƒå¸¸è§çš„é”™è¯¯ç¤ºä¾‹å°±æ˜¯ä½¿ç”¨jedis.setnx()å’Œjedis.expire()ç»„åˆå®ç°åŠ é”ï¼Œä»£ç å¦‚ä¸‹ï¼š123456789public static void wrongGetLock1(Jedis jedis, String lockKey, String requestId, int expireTime) &#123; Long result = jedis.setnx(lockKey, requestId); if (result == 1) &#123; // è‹¥åœ¨è¿™é‡Œç¨‹åºçªç„¶å´©æºƒï¼Œåˆ™æ— æ³•è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œå°†å‘ç”Ÿæ­»é” jedis.expire(lockKey, expireTime); &#125;&#125;setnx()æ–¹æ³•ä½œç”¨å°±æ˜¯SET IF NOT EXISTï¼Œexpire()æ–¹æ³•å°±æ˜¯ç»™é”åŠ ä¸€ä¸ªè¿‡æœŸæ—¶é—´ã€‚ä¹ä¸€çœ‹å¥½åƒå’Œå‰é¢çš„set()æ–¹æ³•ç»“æœä¸€æ ·ï¼Œç„¶è€Œç”±äºè¿™æ˜¯ä¸¤æ¡Rediså‘½ä»¤ï¼Œä¸å…·æœ‰åŸå­æ€§ï¼Œå¦‚æœç¨‹åºåœ¨æ‰§è¡Œå®Œsetnx()ä¹‹åçªç„¶å´©æºƒï¼Œå¯¼è‡´é”æ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´ã€‚é‚£ä¹ˆå°†ä¼šå‘ç”Ÿæ­»é”ã€‚ç½‘ä¸Šä¹‹æ‰€ä»¥æœ‰äººè¿™æ ·å®ç°ï¼Œæ˜¯å› ä¸ºä½ç‰ˆæœ¬çš„jediså¹¶ä¸æ”¯æŒå¤šå‚æ•°çš„set()æ–¹æ³•ã€‚3.2.2è§£é”ä»£ç ä»£ç å¦‚ä¸‹123456789101112131415161718192021222324public class RedisTool &#123; private static final Long RELEASE_SUCCESS = 1L; /** * é‡Šæ”¾åˆ†å¸ƒå¼é” * @param jedis Rediså®¢æˆ·ç«¯ * @param lockKey é” * @param requestId è¯·æ±‚æ ‡è¯† * @return æ˜¯å¦é‡Šæ”¾æˆåŠŸ */ public static boolean releaseDistributedLock(Jedis jedis, String lockKey, String requestId) &#123; String script = \"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end\"; Object result = jedis.eval(script, Collections.singletonList(lockKey), Collections.singletonList(requestId)); if (RELEASE_SUCCESS.equals(result)) &#123; return true; &#125; return false; &#125;&#125;ä»ä¸Šé¢å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬è§£é”åªéœ€è¦ä¸¤è¡Œä»£ç å°±æå®šäº†ï¼ç¬¬ä¸€è¡Œä»£ç ï¼Œæˆ‘ä»¬å†™äº†ä¸€ä¸ªç®€å•çš„Luaè„šæœ¬ä»£ç ï¼Œä¸Šä¸€æ¬¡è§åˆ°è¿™ä¸ªç¼–ç¨‹è¯­è¨€è¿˜æ˜¯åœ¨ã€Šé»‘å®¢ä¸ç”»å®¶ã€‹é‡Œï¼Œæ²¡æƒ³åˆ°è¿™æ¬¡å±…ç„¶ç”¨ä¸Šäº†ã€‚ç¬¬äºŒè¡Œä»£ç ï¼Œæˆ‘ä»¬å°†Luaä»£ç ä¼ åˆ°jedis.eval()æ–¹æ³•é‡Œï¼Œå¹¶ä½¿å‚æ•°KEYS[1]èµ‹å€¼ä¸ºlockKeyï¼ŒARGV[1]èµ‹å€¼ä¸ºrequestIdã€‚eval()æ–¹æ³•æ˜¯å°†Luaä»£ç äº¤ç»™RedisæœåŠ¡ç«¯æ‰§è¡Œã€‚é‚£ä¹ˆè¿™æ®µLuaä»£ç çš„åŠŸèƒ½æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œé¦–å…ˆè·å–é”å¯¹åº”çš„valueå€¼ï¼Œæ£€æŸ¥æ˜¯å¦ä¸requestIdç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰åˆ™åˆ é™¤é”ï¼ˆè§£é”ï¼‰ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆè¦ä½¿ç”¨Luaè¯­è¨€æ¥å®ç°å‘¢ï¼Ÿå› ä¸ºè¦ç¡®ä¿ä¸Šè¿°æ“ä½œæ˜¯åŸå­æ€§çš„ ã€‚é‚£ä¹ˆä¸ºä»€ä¹ˆæ‰§è¡Œeval()æ–¹æ³•å¯ä»¥ç¡®ä¿åŸå­æ€§ï¼ŒæºäºRedisçš„ç‰¹æ€§ã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨evalå‘½ä»¤æ‰§è¡ŒLuaä»£ç çš„æ—¶å€™ï¼ŒLuaä»£ç å°†è¢«å½“æˆä¸€ä¸ªå‘½ä»¤å»æ‰§è¡Œï¼Œå¹¶ä¸”ç›´åˆ°evalå‘½ä»¤æ‰§è¡Œå®Œæˆï¼ŒRedisæ‰ä¼šæ‰§è¡Œå…¶ä»–å‘½ä»¤ã€‚æœ€å¸¸è§çš„è§£é”ä»£ç å°±æ˜¯ç›´æ¥ä½¿ç”¨jedis.del()æ–¹æ³•åˆ é™¤é”ï¼Œè¿™ç§ä¸å…ˆåˆ¤æ–­é”çš„æ‹¥æœ‰è€…è€Œç›´æ¥è§£é”çš„æ–¹å¼ï¼Œä¼šå¯¼è‡´ä»»ä½•å®¢æˆ·ç«¯éƒ½å¯ä»¥éšæ—¶è¿›è¡Œè§£é”ï¼Œå³ä½¿è¿™æŠŠé”ä¸æ˜¯å®ƒçš„ã€‚3.2.3æ€»ç»“å¦‚ä½•ä½¿ç”¨Javaä»£ç æ­£ç¡®å®ç°Redisåˆ†å¸ƒå¼é”ï¼Œå¯¹äºåŠ é”å’Œè§£é”ä¹Ÿåˆ†åˆ«ç»™å‡ºäº†ä¸¤ä¸ªæ¯”è¾ƒç»å…¸çš„é”™è¯¯ã€‚å…¶å®æƒ³è¦é€šè¿‡Rediså®ç°åˆ†å¸ƒå¼é”å¹¶ä¸éš¾ï¼Œåªè¦ä¿è¯èƒ½æ»¡è¶³å¯é æ€§é‡Œçš„å››ä¸ªæ¡ä»¶ã€‚äº’è”ç½‘è™½ç„¶ç»™æˆ‘ä»¬å¸¦æ¥äº†æ–¹ä¾¿ï¼Œåªè¦æœ‰é—®é¢˜å°±å¯ä»¥googleï¼Œç„¶è€Œç½‘ä¸Šçš„ç­”æ¡ˆä¸€å®šæ˜¯å¯¹çš„å—ï¼Ÿå…¶å®ä¸ç„¶ï¼Œæ‰€ä»¥æˆ‘ä»¬æ›´åº”è¯¥æ—¶åˆ»ä¿æŒç€è´¨ç–‘ç²¾ç¥ï¼Œå¤šæƒ³å¤šéªŒè¯ã€‚å¦‚æœä½ çš„é¡¹ç›®ä¸­Redisæ˜¯å¤šæœºéƒ¨ç½²çš„ï¼Œé‚£ä¹ˆå¯ä»¥å°è¯•ä½¿ç”¨Redissonå®ç°åˆ†å¸ƒå¼é”ã€‚3.3 åŸºäºzookeeperå®ç°åŸºäºzookeeperä¸´æ—¶æœ‰åºèŠ‚ç‚¹å¯ä»¥å®ç°çš„åˆ†å¸ƒå¼é”ã€‚å¤§è‡´æ€æƒ³å³ä¸ºï¼šæ¯ä¸ªå®¢æˆ·ç«¯å¯¹æŸä¸ªæ–¹æ³•åŠ é”æ—¶ï¼Œåœ¨zookeeperä¸Šçš„ä¸è¯¥æ–¹æ³•å¯¹åº”çš„æŒ‡å®šèŠ‚ç‚¹çš„ç›®å½•ä¸‹ï¼Œç”Ÿæˆä¸€ä¸ªå”¯ä¸€çš„ç¬æ—¶æœ‰åºèŠ‚ç‚¹ã€‚ åˆ¤æ–­æ˜¯å¦è·å–é”çš„æ–¹å¼å¾ˆç®€å•ï¼Œåªéœ€è¦åˆ¤æ–­æœ‰åºèŠ‚ç‚¹ä¸­åºå·æœ€å°çš„ä¸€ä¸ªã€‚ å½“é‡Šæ”¾é”çš„æ—¶å€™ï¼Œåªéœ€å°†è¿™ä¸ªç¬æ—¶èŠ‚ç‚¹åˆ é™¤å³å¯ã€‚åŒæ—¶ï¼Œå…¶å¯ä»¥é¿å…æœåŠ¡å®•æœºå¯¼è‡´çš„é”æ— æ³•é‡Šæ”¾ï¼Œè€Œäº§ç”Ÿçš„æ­»é”é—®é¢˜ã€‚æ¥çœ‹ä¸‹Zookeeperèƒ½ä¸èƒ½è§£å†³å‰é¢æåˆ°çš„é—®é¢˜ã€‚é”æ— æ³•é‡Šæ”¾ï¼Ÿä½¿ç”¨Zookeeperå¯ä»¥æœ‰æ•ˆçš„è§£å†³é”æ— æ³•é‡Šæ”¾çš„é—®é¢˜ï¼Œå› ä¸ºåœ¨åˆ›å»ºé”çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¼šåœ¨ZKä¸­åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œä¸€æ—¦å®¢æˆ·ç«¯è·å–åˆ°é”ä¹‹åçªç„¶æŒ‚æ‰ï¼ˆSessionè¿æ¥æ–­å¼€ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªä¸´æ—¶èŠ‚ç‚¹å°±ä¼šè‡ªåŠ¨åˆ é™¤æ‰ã€‚å…¶ä»–å®¢æˆ·ç«¯å°±å¯ä»¥å†æ¬¡è·å¾—é”ã€‚éé˜»å¡é”ï¼Ÿä½¿ç”¨Zookeeperå¯ä»¥å®ç°é˜»å¡çš„é”ï¼Œå®¢æˆ·ç«¯å¯ä»¥é€šè¿‡åœ¨ZKä¸­åˆ›å»ºé¡ºåºèŠ‚ç‚¹ï¼Œå¹¶ä¸”åœ¨èŠ‚ç‚¹ä¸Šç»‘å®šç›‘å¬å™¨ï¼Œä¸€æ—¦èŠ‚ç‚¹æœ‰å˜åŒ–ï¼ŒZookeeperä¼šé€šçŸ¥å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥æ£€æŸ¥è‡ªå·±åˆ›å»ºçš„èŠ‚ç‚¹æ˜¯ä¸æ˜¯å½“å‰æ‰€æœ‰èŠ‚ç‚¹ä¸­åºå·æœ€å°çš„ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆè‡ªå·±å°±è·å–åˆ°é”ï¼Œä¾¿å¯ä»¥æ‰§è¡Œä¸šåŠ¡é€»è¾‘äº†ã€‚ä¸å¯é‡å…¥ï¼Ÿä½¿ç”¨Zookeeperä¹Ÿå¯ä»¥æœ‰æ•ˆçš„è§£å†³ä¸å¯é‡å…¥çš„é—®é¢˜ï¼Œå®¢æˆ·ç«¯åœ¨åˆ›å»ºèŠ‚ç‚¹çš„æ—¶å€™ï¼ŒæŠŠå½“å‰å®¢æˆ·ç«¯çš„ä¸»æœºä¿¡æ¯å’Œçº¿ç¨‹ä¿¡æ¯ç›´æ¥å†™å…¥åˆ°èŠ‚ç‚¹ä¸­ï¼Œä¸‹æ¬¡æƒ³è¦è·å–é”çš„æ—¶å€™å’Œå½“å‰æœ€å°çš„èŠ‚ç‚¹ä¸­çš„æ•°æ®æ¯”å¯¹ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚å¦‚æœå’Œè‡ªå·±çš„ä¿¡æ¯ä¸€æ ·ï¼Œé‚£ä¹ˆè‡ªå·±ç›´æ¥è·å–åˆ°é”ï¼Œå¦‚æœä¸ä¸€æ ·å°±å†åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„é¡ºåºèŠ‚ç‚¹ï¼Œå‚ä¸æ’é˜Ÿã€‚å•ç‚¹é—®é¢˜ï¼Ÿä½¿ç”¨Zookeeperå¯ä»¥æœ‰æ•ˆçš„è§£å†³å•ç‚¹é—®é¢˜ï¼ŒZKæ˜¯é›†ç¾¤éƒ¨ç½²çš„ï¼Œåªè¦é›†ç¾¤ä¸­æœ‰åŠæ•°ä»¥ä¸Šçš„æœºå™¨å­˜æ´»ï¼Œå°±å¯ä»¥å¯¹å¤–æä¾›æœåŠ¡ã€‚å¯ä»¥ç›´æ¥ä½¿ç”¨zookeeperç¬¬ä¸‰æ–¹åº“Curatorå®¢æˆ·ç«¯ï¼Œè¿™ä¸ªå®¢æˆ·ç«¯ä¸­å°è£…äº†ä¸€ä¸ªå¯é‡å…¥çš„é”æœåŠ¡ã€‚123456789101112131415161718public boolean tryLock(long timeout, TimeUnit unit) throws InterruptedException &#123; try &#123; return interProcessMutex.acquire(timeout, unit); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return true;&#125;public boolean unlock() &#123; try &#123; interProcessMutex.release(); &#125; catch (Throwable e) &#123; log.error(e.getMessage(), e); &#125; finally &#123; executorService.schedule(new Cleaner(client, path), delayTimeForClean, TimeUnit.MILLISECONDS); &#125; return true;&#125;Curatoræä¾›çš„InterProcessMutexæ˜¯åˆ†å¸ƒå¼é”çš„å®ç°ã€‚acquireæ–¹æ³•ç”¨æˆ·è·å–é”ï¼Œreleaseæ–¹æ³•ç”¨äºé‡Šæ”¾é”ã€‚ä½¿ç”¨ZKå®ç°çš„åˆ†å¸ƒå¼é”å¥½åƒå®Œå…¨ç¬¦åˆäº†æœ¬æ–‡å¼€å¤´æˆ‘ä»¬å¯¹ä¸€ä¸ªåˆ†å¸ƒå¼é”çš„æ‰€æœ‰æœŸæœ›ã€‚ä½†æ˜¯ï¼Œå…¶å®å¹¶ä¸æ˜¯ï¼ŒZookeeperå®ç°çš„åˆ†å¸ƒå¼é”å…¶å®å­˜åœ¨ä¸€ä¸ªç¼ºç‚¹ï¼Œé‚£å°±æ˜¯æ€§èƒ½ä¸Šå¯èƒ½å¹¶æ²¡æœ‰ç¼“å­˜æœåŠ¡é‚£ä¹ˆé«˜ã€‚å› ä¸ºæ¯æ¬¡åœ¨åˆ›å»ºé”å’Œé‡Šæ”¾é”çš„è¿‡ç¨‹ä¸­ï¼Œéƒ½è¦åŠ¨æ€åˆ›å»ºã€é”€æ¯ç¬æ—¶èŠ‚ç‚¹æ¥å®ç°é”åŠŸèƒ½ã€‚ZKä¸­åˆ›å»ºå’Œåˆ é™¤èŠ‚ç‚¹åªèƒ½é€šè¿‡LeaderæœåŠ¡å™¨æ¥æ‰§è¡Œï¼Œç„¶åå°†æ•°æ®åŒä¸åˆ°æ‰€æœ‰çš„Followeræœºå™¨ä¸Šã€‚å…¶å®ï¼Œä½¿ç”¨Zookeeperä¹Ÿæœ‰å¯èƒ½å¸¦æ¥å¹¶å‘é—®é¢˜ï¼Œåªæ˜¯å¹¶ä¸å¸¸è§è€Œå·²ã€‚è€ƒè™‘è¿™æ ·çš„æƒ…å†µï¼Œç”±äºç½‘ç»œæŠ–åŠ¨ï¼Œå®¢æˆ·ç«¯å¯ZKé›†ç¾¤çš„sessionè¿æ¥æ–­äº†ï¼Œé‚£ä¹ˆzkä»¥ä¸ºå®¢æˆ·ç«¯æŒ‚äº†ï¼Œå°±ä¼šåˆ é™¤ä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿™æ—¶å€™å…¶ä»–å®¢æˆ·ç«¯å°±å¯ä»¥è·å–åˆ°åˆ†å¸ƒå¼é”äº†ã€‚å°±å¯èƒ½äº§ç”Ÿå¹¶å‘é—®é¢˜ã€‚è¿™ä¸ªé—®é¢˜ä¸å¸¸è§æ˜¯å› ä¸ºzkæœ‰é‡è¯•æœºåˆ¶ï¼Œä¸€æ—¦zké›†ç¾¤æ£€æµ‹ä¸åˆ°å®¢æˆ·ç«¯çš„å¿ƒè·³ï¼Œå°±ä¼šé‡è¯•ï¼ŒCuratorå®¢æˆ·ç«¯æ”¯æŒå¤šç§é‡è¯•ç­–ç•¥ã€‚å¤šæ¬¡é‡è¯•ä¹‹åè¿˜ä¸è¡Œçš„è¯æ‰ä¼šåˆ é™¤ä¸´æ—¶èŠ‚ç‚¹ã€‚ï¼ˆæ‰€ä»¥ï¼Œé€‰æ‹©ä¸€ä¸ªåˆé€‚çš„é‡è¯•ç­–ç•¥ä¹Ÿæ¯”è¾ƒé‡è¦ï¼Œè¦åœ¨é”çš„ç²’åº¦å’Œå¹¶å‘ä¹‹é—´æ‰¾ä¸€ä¸ªå¹³è¡¡ã€‚ï¼‰ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼é”çš„ä¼˜ç‚¹æœ‰æ•ˆçš„è§£å†³å•ç‚¹é—®é¢˜ï¼Œä¸å¯é‡å…¥é—®é¢˜ï¼Œéé˜»å¡é—®é¢˜ä»¥åŠé”æ— æ³•é‡Šæ”¾çš„é—®é¢˜ã€‚å®ç°èµ·æ¥è¾ƒä¸ºç®€å•ã€‚ä½¿ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼é”çš„ç¼ºç‚¹æ€§èƒ½ä¸Šä¸å¦‚ä½¿ç”¨ç¼“å­˜å®ç°åˆ†å¸ƒå¼é”ã€‚ éœ€è¦å¯¹ZKçš„åŸç†æœ‰æ‰€äº†è§£ã€‚4. æ€»ç»“ä¸Šé¢å‡ ç§æ–¹å¼ï¼Œå“ªç§æ–¹å¼éƒ½æ— æ³•åšåˆ°å®Œç¾ã€‚å°±åƒCAPä¸€æ ·ï¼Œåœ¨å¤æ‚æ€§ã€å¯é æ€§ã€æ€§èƒ½ç­‰æ–¹é¢æ— æ³•åŒæ—¶æ»¡è¶³ï¼Œæ‰€ä»¥ï¼Œæ ¹æ®ä¸åŒçš„åº”ç”¨åœºæ™¯é€‰æ‹©æœ€é€‚åˆè‡ªå·±çš„æ‰æ˜¯ç‹é“ã€‚ä»ç†è§£çš„éš¾æ˜“ç¨‹åº¦è§’åº¦ï¼ˆä»ä½åˆ°é«˜ï¼‰æ•°æ®åº“ &gt; ç¼“å­˜ &gt; Zookeeperä»å®ç°çš„å¤æ‚æ€§è§’åº¦ï¼ˆä»ä½åˆ°é«˜ï¼‰Zookeeper &gt;= ç¼“å­˜ &gt; æ•°æ®åº“ä»æ€§èƒ½è§’åº¦ï¼ˆä»é«˜åˆ°ä½ï¼‰ç¼“å­˜ &gt; Zookeeper &gt;= æ•°æ®åº“ä»å¯é æ€§è§’åº¦ï¼ˆä»é«˜åˆ°ä½ï¼‰Zookeeper &gt; ç¼“å­˜ &gt; æ•°æ®åº“å‚è€ƒhttps://blog.csdn.net/wuzhiwei549/article/details/80692278https://www.hollischuang.com/archives/1716","categories":[{"name":"ä¸­é—´ä»¶","slug":"ä¸­é—´ä»¶","permalink":"http://localhost:4000/categories/ä¸­é—´ä»¶/"},{"name":"åˆ†å¸ƒå¼","slug":"ä¸­é—´ä»¶/åˆ†å¸ƒå¼","permalink":"http://localhost:4000/categories/ä¸­é—´ä»¶/åˆ†å¸ƒå¼/"}],"tags":[{"name":"é”","slug":"é”","permalink":"http://localhost:4000/tags/é”/"},{"name":"ä¸­é—´ä»¶","slug":"ä¸­é—´ä»¶","permalink":"http://localhost:4000/tags/ä¸­é—´ä»¶/"},{"name":"åˆ†å¸ƒå¼","slug":"åˆ†å¸ƒå¼","permalink":"http://localhost:4000/tags/åˆ†å¸ƒå¼/"}]},{"title":"Hello World","slug":"hello-world","date":"2019-06-14T13:48:34.388Z","updated":"2019-06-16T07:30:14.246Z","comments":true,"path":"2019/06/14/hello-world/","link":"","permalink":"http://localhost:4000/2019/06/14/hello-world/","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.Quick StartCreate a new post1$ hexo new \"My New Post\"More info: WritingRun server1$ hexo serverMore info: ServerGenerate static files1$ hexo generateMore info: GeneratingDeploy to remote sites1$ hexo deployMore info: Deployment","categories":[],"tags":[]}]}