{"meta":{"title":"ctzzhang","subtitle":null,"description":null,"author":"Ctzzhang","url":"http://localhost:4000","root":"/"},"pages":[{"title":"å…³äº","date":"2019-06-16T07:30:14.312Z","updated":"2019-06-16T07:30:14.312Z","comments":false,"path":"about/index.html","permalink":"http://localhost:4000/about/index.html","excerpt":"","text":"æ¬¢è¿è®¿é—®æˆ‘çš„åšå®¢ï¼Œæˆ‘ä¼šä¿æŒä¸å®šæœŸæ›´æ–°ã€‚/** * * â”â”â”â”â”â”ç¥å…½å‡ºæ²¡â”â”â”â”â”â”â”â”“ â”â”“â”ƒ â”ƒ + +â”ƒ â” â”ƒ ++ + + +â–ˆâ–ˆâ–ˆâ–ˆâ”â–ˆâ–ˆâ–ˆâ–ˆ â”ƒ ğŸš‚ğŸš‚ğŸš‚-&lt;-&lt; æ¬¢è¿è®¿é—® https://ctzzhang.github.io/â”ƒ â”ƒ +â”ƒ â”» â”ƒ + +â”ƒ â”ƒâ”—â”â”“ â”â”â”›Code is far away from bug with the animal protectingâ”ƒ â”ƒ ç¥å…½æŠ¤ä½“ï¼Œæ°¸æ— bugâ”ƒ â”ƒ +â”ƒ â”—â”â”â”â”“+â”ƒ â”£â”“ ğŸ“¬ è”ç³»æˆ‘ï¼štzzhang021.com(at)163.comâ”ƒ â”â”› + +â”—â”“â”“â”â”â”³â”“â”â”› +â”ƒâ”«â”« â”ƒâ”«â”«â”—â”»â”› â”—â”»â”›/"},{"title":"ä¹¦å•","date":"2019-06-16T07:30:14.364Z","updated":"2019-06-16T07:30:14.364Z","comments":false,"path":"books/index.html","permalink":"http://localhost:4000/books/index.html","excerpt":"","text":""},{"title":"åˆ†ç±»","date":"2019-06-16T07:30:14.382Z","updated":"2019-06-16T07:30:14.382Z","comments":false,"path":"categories/index.html","permalink":"http://localhost:4000/categories/index.html","excerpt":"","text":""},{"title":"å‹æƒ…é“¾æ¥","date":"2019-06-16T07:30:14.380Z","updated":"2019-06-16T07:30:14.380Z","comments":true,"path":"links/index.html","permalink":"http://localhost:4000/links/index.html","excerpt":"","text":""},{"title":"Repositories","date":"2019-06-16T07:30:14.625Z","updated":"2019-06-16T07:30:14.625Z","comments":false,"path":"repository/index.html","permalink":"http://localhost:4000/repository/index.html","excerpt":"","text":""},{"title":"æ ‡ç­¾","date":"2019-06-16T07:30:14.367Z","updated":"2019-06-16T07:30:14.367Z","comments":false,"path":"tags/index.html","permalink":"http://localhost:4000/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"ç®€æé™æµç®—æ³•","slug":"ç®€æé™æµç®—æ³•","date":"2019-06-15T14:24:02.000Z","updated":"2019-06-16T09:03:38.852Z","comments":true,"path":"2019/06/15/ç®€æé™æµç®—æ³•/","link":"","permalink":"http://localhost:4000/2019/06/15/ç®€æé™æµç®—æ³•/","excerpt":"","text":"1.ç®€ä»‹é™æµé¡¾åæ€ä¹‰æ˜¯é™åˆ¶æµé‡ï¼Œé™åˆ¶æµé‡çš„ç›®çš„æ˜¯ä¸ºäº†ä¿éšœæœåŠ¡ç¨³å®šè¿è¡Œï¼Œé¿å…æœåŠ¡è¢«æµé‡å†²å®ã€‚å½“æµé‡è¶…å‡ºæœåŠ¡å¤„ç†èƒ½åŠ›æ—¶ï¼Œéƒ¨åˆ†è¯·æ±‚å°†ä¼šè¢«é™æµç»„ä»¶æ‹¦æˆªã€‚è¢«æ‹¦æˆªçš„è¯·æ±‚å¯èƒ½ä¼šè¢«ä¸¢å¼ƒï¼Œå¦‚æœæ˜¯ C ç«¯è¯·æ±‚ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯·æ±‚å¯èƒ½ä¼šè¢«å¯¼å‘æŒ‡å®šçš„é”™è¯¯é¡µä¸Šï¼Œè€Œä¸æ˜¯ç”Ÿç¡¬çš„æ‹’ç»ã€‚è¿™é‡Œæˆ‘ä»¬ä¸¢å¼ƒæ‰ä¸€éƒ¨åˆ†è¯·æ±‚ï¼Œä»¥ä¿è¯å¤§éƒ¨åˆ†è¯·æ±‚å¯ä»¥æ­£å¸¸å“åº”ã€‚å¦‚æœæˆ‘ä»¬ä¸è¿™æ ·åšï¼Œé‚£ä¹ˆæœåŠ¡å´©æºƒåï¼Œæ‰€æœ‰è¯·æ±‚éƒ½å°†æ— æ³•å“åº”äº†ã€‚å½“ä¸€å°æœºå™¨å´©æºƒåï¼Œè¯¥æœºå™¨çš„æ‰€æœ‰æµé‡å°†ç”±å…¶ä»–æœºå™¨æ‰¿æ‹…ï¼Œè¿™æ ·å°±ä¼šé€ æˆå‰©ä½™æœºå™¨å‹åŠ›å¢å¤§ï¼Œè¿›è€Œå¯¼è‡´å¥”æºƒï¼Œæœ€åå½¢æˆé›ªå´©ã€‚é™¤æ­¤ä¹‹å¤–ï¼ŒæœåŠ¡å´©æºƒè¿˜ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„ä¸¥é‡é—®é¢˜ï¼Œç‰¹åˆ«æ˜¯ä¸€äº›æ•æ„Ÿæ•°æ®ã€‚æ¯”å¦‚å¯¹äºç”µå•†ç½‘ç«™ï¼Œå¦‚æœåå°æœåŠ¡å‡†å¤‡å°†æŸç¬”è®¢å•æ•°æ®å­˜å…¥æ•°æ®åº“æ—¶ï¼ŒæœåŠ¡çªç„¶å´©æºƒï¼Œå¯¼è‡´æ•°æ®æ²¡æœ‰è½åº“ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¼€å‘åŒå­¦å°±è¦æƒ³åŠæ³•ä¿®è®¢æ•°æ®äº†ã€‚ç»¼ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥é™æµçš„é‡è¦æ€§ã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘å°†å‘å¤§å®¶ä»‹ç»ä¸‰ç§å¸¸ç”¨çš„é™æµç®—æ³•ï¼Œåˆ†åˆ«æ˜¯è®¡æ•°å™¨ã€æ¼æ¡¶ç®—æ³•å’Œä»¤ç‰Œæ¡¶ç®—æ³•ã€‚ä¸‹é¢æˆ‘ä»¬ä»æœ€ç®€å•çš„è®¡æ•°å™¨å¼€å§‹è¯´èµ·ã€‚2.é™æµç®—æ³•2.1 è®¡æ•°å™¨è®¡æ•°å™¨ç®—æ³•çš„æ€æƒ³å¾ˆç®€å•ï¼Œæ¯å½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œæˆ‘ä»¬å°±å°†è®¡æ•°å™¨åŠ ä¸€ï¼Œå½“è®¡æ•°å™¨æ•°å€¼è¶…è¿‡é˜ˆå€¼åï¼Œå°±æ‹’ç»ä½™ä¸‹è¯·æ±‚ã€‚ä¸€ç§’é’Ÿåï¼Œæˆ‘ä»¬å°†è®¡æ•°å™¨æ¸…é›¶ï¼Œå¼€å§‹æ–°ä¸€è½®çš„è®¡æ•°ã€‚è®¡æ•°å™¨ç®—æ³•ç®€å•ç²—æš´ï¼Œæ˜“äºå®ç°ã€‚ä½†æ˜¯ç¼ºç‚¹ä¹Ÿæ˜¯æœ‰çš„ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„â€çªåˆºç°è±¡â€ã€‚ä¸¾ä¾‹è¯´æ˜ä¸€ä¸‹ï¼Œå‡å¦‚æˆ‘ä»¬ç»™è®¡æ•°å™¨è®¾ç½®çš„é˜ˆå€¼ä¸º100ã€‚ç³»ç»Ÿç¬é—´å†…ï¼ˆæ¯”å¦‚10æ¯«ç§’å†…ï¼‰æœ‰200ä¸ªè¯·æ±‚åˆ°æ¥ï¼Œè¿™ä¸ªæ—¶å€™è®¡æ•°å™¨åªèƒ½æ”¾è¿‡å…¶ä¸­çš„100ä¸ªè¯·æ±‚ï¼Œä½™ä¸‹çš„100ä¸ªè¯·æ±‚å…¨éƒ¨è¢«æ‹’ç»æ‰ã€‚å¦‚æœç¬¬äºŒç§’å†…æ²¡æœ‰è¯·æ±‚åˆ°æ¥ï¼Œé‚£ä¹ˆç³»ç»Ÿå°±å¤„äºç©ºé—²çŠ¶æ€ã€‚ä¹Ÿå°±æ˜¯ä¸Šä¸€ç§’å¿™çš„è¦æ­»ï¼Œè¿™ä¸€ç§’åˆé—²çš„è¦æ­»ã€‚å¦‚æœæˆ‘ä»¬èƒ½ç”¨ä¸€ä¸ªå®¹å™¨å°†å‰©ä½™çš„100ä¸ªè¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œå¾…è®¡æ•°å™¨é‡ç½®åå†å°†è¿™äº›è¯·æ±‚æ”¾å‡ºæ¥ã€‚è¿™æ ·ç³»ç»Ÿåœ¨è¿™ä¸¤ç§’å†…çš„ååé‡å°±ç”±100å˜æˆäº†200ï¼Œæå‡äº†ä¸€å€ã€‚åŸºäºè¿™ä¸ªæ€è€ƒï¼Œä¸‹é¢æˆ‘ä»¬å†æ¥çœ‹çœ‹æ¼æ¡¶ç®—æ³•ã€‚2.2 æ¼æ¡¶ç®—æ³•æ¼æ¡¶ç®—æ³•ç”±æµé‡å®¹å™¨ã€æµé‡å…¥å£å’Œå‡ºå£ç»„æˆã€‚å…¶ä¸­æµé‡å‡ºå£æµé€Ÿå³ä¸ºæˆ‘ä»¬æœŸæœ›çš„é™é€Ÿå€¼ï¼Œæ¯”å¦‚ 100 QPSã€‚æ¼æ¡¶ç®—æ³•é™¤äº†å…·å¤‡é™æµèƒ½åŠ›ï¼Œè¿˜å…·å¤‡æµé‡æ•´å‹åŠŸèƒ½ã€‚ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€å¼ å›¾æ¥äº†è§£æ¼æ¡¶ç®—æ³•ã€‚å¦‚ä¸Šå›¾ï¼Œæµå…¥æ¼æ¡¶æµé‡çš„æµé€Ÿæ˜¯ä¸æ’å®šçš„ï¼Œç»è¿‡æ¼æ¡¶é™é€Ÿåï¼Œæµå‡ºæµé‡çš„é€Ÿåº¦æ˜¯æ’å®šçš„ã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œæ¼æ¡¶çš„å®¹é‡æ˜¯æœ‰é™çš„ï¼Œä¸€æ—¦æµå…¥æµé‡è¶…å‡ºæ¼æ¡¶å®¹é‡ï¼Œè¿™éƒ¨åˆ†æµé‡åªèƒ½è¢«ä¸¢å¼ƒäº†ã€‚æ¼æ¡¶æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¥½çš„é™æµæ•´å‹å·¥å…·ï¼Œä¸è¿‡æ¼æ¡¶ä¸èƒ½å¤„ç†çªå‘æµé‡ï¼Œä¸€äº›è§‚ç‚¹è®¤ä¸ºè¿™æ˜¯å®ƒçš„ä¸€ä¸ªç¼ºç‚¹ã€‚ä¸è¿‡å¦‚æœè¾ƒèµ·çœŸæ¥ï¼Œæˆ‘è§‰å¾—è¿™ä¸ªç¼ºç‚¹æ˜¯ä¸æˆç«‹çš„ã€‚æ¯•ç«Ÿæ¼æ¡¶æœ¬å°±æ˜¯ç”¨æ¥å¹³æ»‘æµé‡çš„ï¼Œå¦‚æœæ”¯æŒçªå‘ï¼Œé‚£ä¹ˆè¾“å‡ºæµé‡åè€Œä¸å¹³æ»‘äº†ã€‚å¦‚æœè¦æ‰¾ä¸€ç§èƒ½å¤Ÿæ”¯æŒçªå‘æµé‡çš„é™æµç®—æ³•ï¼Œé‚£ä¹ˆä»¤ç‰Œæ¡¶ç®—æ³•å¯ä»¥æ»¡è¶³éœ€æ±‚2.3 ä»¤ç‰Œæ¡¶ç®—æ³•ä»¤ç‰Œæ¡¶å’Œæ¼æ¡¶é¢‡æœ‰å‡ åˆ†ç›¸ä¼¼ï¼Œåªä¸è¿‡ä»¤ç‰Œé€šé‡Œå­˜æ”¾çš„æ˜¯ä»¤ç‰Œã€‚å®ƒçš„è¿è¡Œè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼Œä¸€ä¸ªä»¤ç‰Œå·¥å‚æŒ‰ç…§è®¾å®šå€¼å®šæœŸå‘ä»¤ç‰Œæ¡¶å‘æ”¾ä»¤ç‰Œã€‚å½“ä»¤ç‰Œæ¡¶æ»¡äº†åï¼Œå¤šå‡ºçš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒæ‰ã€‚æ¯å½“ä¸€ä¸ªè¯·æ±‚åˆ°æ¥æ—¶ï¼Œè¯¥è¯·æ±‚å¯¹åº”çš„çº¿ç¨‹ä¼šä»ä»¤ç‰Œæ¡¶ä¸­å–ä»¤ç‰Œã€‚åˆæœŸç”±äºä»¤ç‰Œæ¡¶ä¸­å­˜æ”¾äº†å¾ˆå¤šä¸ªä»¤ç‰Œï¼Œå› æ­¤å…è®¸å¤šä¸ªè¯·æ±‚åŒæ—¶å–ä»¤ç‰Œã€‚å½“æ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œåï¼Œæ— æ³•è·å–åˆ°ä»¤ç‰Œçš„è¯·æ±‚å¯ä»¥ä¸¢å¼ƒï¼Œæˆ–è€…é‡è¯•ã€‚ä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹çš„ä»¤ç‰Œæ¡¶ç¤ºæ„å›¾ï¼šå°½ç®¡ä»¤ç‰Œæ¡¶å…è®¸çªå‘æµé‡ï¼Œä½†çªå‘æµé‡é€Ÿç‡ R1 + é™æµé€Ÿç‡ R2 ä¸èƒ½è¶…è¿‡ç³»ç»Ÿæœ€å¤§çš„å¤„ç†èƒ½åŠ› Rtï¼Œå³ R1 + R2 â‰¤ Rt,å¦åˆ™ä¼šå†²å®ç³»ç»Ÿ3.RateLimiterç®€ä»‹Googleå¼€æºå·¥å…·åŒ…Guavaæä¾›äº†é™æµå·¥å…·ç±»RateLimiter,è¯¥ç±»åŸºäºä»¤ç‰Œæ¡¶ç®—æ³•(Token Bucket)æ¥å®Œæˆé™æµ,éå¸¸æ˜“äºä½¿ç”¨.RateLimiterç»å¸¸ç”¨äºé™åˆ¶å¯¹ä¸€äº›ç‰©ç†èµ„æºæˆ–è€…é€»è¾‘èµ„æºçš„è®¿é—®é€Ÿç‡.å®ƒæ”¯æŒä¸¤ç§è·å–permitsæ¥å£,ä¸€ç§æ˜¯å¦‚æœæ‹¿ä¸åˆ°ç«‹åˆ»è¿”å›false,ä¸€ç§ä¼šé˜»å¡ç­‰å¾…ä¸€æ®µæ—¶é—´çœ‹èƒ½ä¸èƒ½æ‹¿åˆ°.RateLimiterå’ŒJavaä¸­çš„ä¿¡å·é‡(java.util.concurrent.Semaphore)ç±»ä¼¼,Semaphoreé€šå¸¸ç”¨äºé™åˆ¶å¹¶å‘é‡.æºç æ³¨é‡Šä¸­çš„ä¸€ä¸ªä¾‹å­,æ¯”å¦‚æˆ‘ä»¬æœ‰å¾ˆå¤šä»»åŠ¡éœ€è¦æ‰§è¡Œ,ä½†æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›æ¯ç§’è¶…è¿‡ä¸¤ä¸ªä»»åŠ¡æ‰§è¡Œ,é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨RateLimiter:1234567final RateLimiter rateLimiter = RateLimiter.create(2.0);void submitTasks(List&lt;Runnable&gt; tasks, Executor executor) &#123;for (Runnable task : tasks) &#123; rateLimiter.acquire(); // may wait executor.execute(task); &#125;&#125;å¦å¤–ä¸€ä¸ªä¾‹å­,å‡å¦‚æˆ‘ä»¬ä¼šäº§ç”Ÿä¸€ä¸ªæ•°æ®æµ,ç„¶åæˆ‘ä»¬æƒ³ä»¥æ¯ç§’5kbçš„é€Ÿåº¦å‘é€å‡ºå».æˆ‘ä»¬å¯ä»¥æ¯è·å–ä¸€ä¸ªä»¤ç‰Œ(permit)å°±å‘é€ä¸€ä¸ªbyteçš„æ•°æ®,è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡ä¸€ä¸ªæ¯ç§’5000ä¸ªä»¤ç‰Œçš„RateLimiteræ¥å®ç°:12345final RateLimiter rateLimiter = RateLimiter.create(5000.0);void submitPacket(byte[] packet) &#123; rateLimiter.acquire(packet.length); networkService.send(packet);&#125;4.å…¶ä»–é™æµå™¨ASP.NETç‰ˆæœ¬çš„ä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿé™æµå™¨:WebApiThrottle å‚è€ƒï¼šhttp://www.cnblogs.com/mushroom/archive/2015/07/21/4659200.htmlhttps://github.com/springside/springside4/wiki/Rate-Limiterhttps://en.wikipedia.org/wiki/Token_buckethttps://en.wikipedia.org/wiki/Leaky_bucket5.æ€»ç»“ä»¥ä¸Šå°±æ˜¯æœ¬ç¯‡æ–‡ç« çš„å…¨éƒ¨å†…å®¹ã€‚æœ¬ç¯‡æ–‡ç« ç®€å•åˆ†æå‡ ç§å¸¸è§é™æµç®—æ³•çš„è¿è¡Œè¿‡ç¨‹ï¼Œé™äºèƒ½åŠ›åŸå› ï¼Œæ–‡ç« è‹¥æœ‰é”™è¯¯ä¸å¦¥ä¹‹å¤„è¿˜è¯·æŒ‡æ˜ã€‚å¥½äº†ï¼Œæœ¬ç¯‡æ–‡ç« åˆ°è¿™é‡Œå°±ç»“æŸäº†ï¼Œæ„Ÿè°¢å¤§å®¶çš„é˜…è¯»ã€‚","categories":[{"name":"ä¸­é—´ä»¶","slug":"ä¸­é—´ä»¶","permalink":"http://localhost:4000/categories/ä¸­é—´ä»¶/"},{"name":"é™æµç»„ä»¶","slug":"ä¸­é—´ä»¶/é™æµç»„ä»¶","permalink":"http://localhost:4000/categories/ä¸­é—´ä»¶/é™æµç»„ä»¶/"}],"tags":[{"name":"é™æµç»„ä»¶","slug":"é™æµç»„ä»¶","permalink":"http://localhost:4000/tags/é™æµç»„ä»¶/"}]},{"title":"Javaçº¿ç¨‹æ± çš„åŸç†åˆ†æ","slug":"Javaçº¿ç¨‹æ± ","date":"2019-06-15T14:24:02.000Z","updated":"2019-06-16T11:16:35.504Z","comments":true,"path":"2019/06/15/Javaçº¿ç¨‹æ± /","link":"","permalink":"http://localhost:4000/2019/06/15/Javaçº¿ç¨‹æ± /","excerpt":"","text":"Javaçº¿ç¨‹æ± çš„åŸç†åˆ†æ1.ç®€ä»‹éšç€å¹¶å‘çš„ä¸æ–­å¢åŠ ï¼Œå•ä¸ªçº¿ç¨‹çš„åˆ›å»ºå’Œé”€æ¯ä¼šå¸¦æ¥å¤§é‡çš„èµ„æºå¼€é”€ã€‚é€šè¿‡çº¿ç¨‹æ±  æˆ‘ä»¬å¯ä»¥æ–¹ä¾¿çš„å¤ç”¨çº¿ç¨‹ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹æ‰€å¸¦æ¥çš„å¼€é”€ã€‚åœ¨åº”ç”¨ä¸Šï¼Œçº¿ç¨‹æ± å¯åº”ç”¨åœ¨åç«¯ç›¸å…³æœåŠ¡ä¸­ã€‚æ¯”å¦‚ Web æœåŠ¡å™¨ï¼Œæ•°æ®åº“æœåŠ¡å™¨ç­‰ã€‚ä»¥ Web æœåŠ¡å™¨ä¸ºä¾‹ï¼Œå‡å¦‚ Web æœåŠ¡å™¨ä¼šæ”¶åˆ°å¤§é‡çŸ­æ—¶çš„ HTTP è¯·æ±‚ï¼Œå¦‚æœæ­¤æ—¶æˆ‘ä»¬ç®€å•çš„ä¸ºæ¯ä¸ª HTTP è¯·æ±‚åˆ›å»ºä¸€ä¸ªå¤„ç†çº¿ç¨‹ï¼Œé‚£ä¹ˆæœåŠ¡å™¨çš„èµ„æºå°†ä¼šå¾ˆå¿«è¢«è€—å°½ã€‚å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±å»ç®¡ç†å¹¶å¤ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹ï¼Œä»¥é™åˆ¶èµ„æºçš„æ¶ˆè€—é‡ï¼Œä½†è¿™æ ·ä¼šä½¿ç”¨ç¨‹åºçš„é€»è¾‘å˜å¤æ‚ã€‚å¥½åœ¨ï¼Œå¹¸è¿çš„æ˜¯ï¼Œæˆ‘ä»¬ä¸å¿…é‚£æ ·åšã€‚åœ¨ JDK 1.5 ä¸­ï¼Œå®˜æ–¹å·²ç»æä¾›äº†å¼ºå¤§çš„çº¿ç¨‹æ± å·¥å…·ç±»ã€‚é€šè¿‡ä½¿ç”¨è¿™äº›å·¥å…·ç±»ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä½å»‰çš„ä»£ä»·ä½¿ç”¨å¤šçº¿ç¨‹æŠ€æœ¯ã€‚åœ¨Javaç”¨æœ‰ä¸€ä¸ªExecutorså·¥å…·ç±»ï¼Œå¯ä»¥ä¸ºæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå…¶æœ¬è´¨å°±æ˜¯newäº†ä¸€ä¸ªThreadPoolExecutorå¯¹è±¡ã€‚ è§‰å¾—å¾ˆæœ‰å¿…è¦å»å­¦ä¹ ä¸€ä¸‹çº¿ç¨‹æ± çš„ç›¸å…³åŸç†ã€‚æ¯•ç«Ÿçº¿ç¨‹æ± é™¤äº†è¦ç®¡ç†çº¿ç¨‹ï¼Œè¿˜è¦ç®¡ç†ä»»åŠ¡ï¼ŒåŒæ—¶è¿˜è¦å…·å¤‡ç»Ÿè®¡åŠŸèƒ½ã€‚æ‰€ä»¥å¤šäº†è§£ä¸€ç‚¹ï¼Œè¿˜æ˜¯å¯ä»¥æ‰©å……çœ¼ç•Œçš„ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æ›´ä¸ºç†Ÿæ‚‰çº¿ç¨‹æ± æŠ€æœ¯ã€‚2.Executorç»§æ‰¿å…³ç³»çº¿ç¨‹æ± æ‰€é‡‡ç”¨çš„æ¥å£å’Œç±»çš„ç»“æ„å¦‚ä¸‹å›¾å¦‚ä¸Šå›¾ï¼Œæœ€é¡¶å±‚çš„æ¥å£ Executor ä»…å£°æ˜äº†ä¸€ä¸ªæ–¹æ³•executeã€‚ExecutorService æ¥å£åœ¨å…¶çˆ¶ç±»æ¥å£åŸºç¡€ä¸Šï¼Œå£°æ˜äº†åŒ…å«ä½†ä¸é™äºshutdownã€submitã€invokeAllã€invokeAny ç­‰æ–¹æ³•ã€‚è‡³äº ScheduledExecutorService æ¥å£ï¼Œåˆ™æ˜¯å£°æ˜äº†ä¸€äº›å’Œå®šæ—¶ä»»åŠ¡ç›¸å…³çš„æ–¹æ³•ï¼Œæ¯”å¦‚ scheduleå’ŒscheduleAtFixedRateã€‚çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°æ˜¯åœ¨ ThreadPoolExecutor ç±»ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ Executors è°ƒç”¨newFixedThreadPoolã€newSingleThreadExecutorå’ŒnewCachedThreadPoolç­‰æ–¹æ³•åˆ›å»ºçº¿ç¨‹æ± å‡æ˜¯ ThreadPoolExecutor ç±»å‹ã€‚ä»¥ä¸Šæ˜¯å¯¹çº¿ç¨‹æ± ç»§æ‰¿ä½“ç³»çš„ç®€å•ä»‹ç»ï¼Œè¿™é‡Œå…ˆè®©å¤§å®¶å¯¹çº¿ç¨‹æ± å¤§è‡´è½®å»“æœ‰ä¸€å®šçš„äº†è§£ã€‚æ¥ä¸‹æ¥æˆ‘ä¼šä»‹ç»ä¸€ä¸‹çº¿ç¨‹æ± çš„å®ç°åŸç†ï¼Œç»§ç»­å¾€ä¸‹çœ‹å§ã€‚3.åŸç†åˆ†æ3.1æ ¸å¿ƒå…³ç³»åˆ†æ3.1.1æ ¸å¿ƒå‚æ•°ç®€ä»‹å¦‚ä¸ŠèŠ‚æ‰€è¯´ï¼Œçº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°å³ ThreadPoolExecutor ç±»ã€‚è¯¥ç±»åŒ…å«äº†å‡ ä¸ªæ ¸å¿ƒå±æ€§ï¼Œè¿™äº›å±æ€§åœ¨å¯åœ¨æ„é€ æ–¹æ³•è¿›è¡Œåˆå§‹åŒ–ã€‚åœ¨ä»‹ç»æ ¸å¿ƒå±æ€§å‰ï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ ThreadPoolExecutor çš„æ„é€ æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748/** * Creates a new &#123;@code ThreadPoolExecutor&#125; with the given initial * parameters. * * @param corePoolSize the number of threads to keep in the pool, even * if they are idle, unless &#123;@code allowCoreThreadTimeOut&#125; is set * @param maximumPoolSize the maximum number of threads to allow in the * pool * @param keepAliveTime when the number of threads is greater than * the core, this is the maximum time that excess idle threads * will wait for new tasks before terminating. * @param unit the time unit for the &#123;@code keepAliveTime&#125; argument * @param workQueue the queue to use for holding tasks before they are * executed. This queue will hold only the &#123;@code Runnable&#125; * tasks submitted by the &#123;@code execute&#125; method. * @param threadFactory the factory to use when the executor * creates a new thread * @param handler the handler to use when execution is blocked * because the thread bounds and queue capacities are reached * @throws IllegalArgumentException if one of the following holds:&lt;br&gt; * &#123;@code corePoolSize &lt; 0&#125;&lt;br&gt; * &#123;@code keepAliveTime &lt; 0&#125;&lt;br&gt; * &#123;@code maximumPoolSize &lt;= 0&#125;&lt;br&gt; * &#123;@code maximumPoolSize &lt; corePoolSize&#125; * @throws NullPointerException if &#123;@code workQueue&#125; * or &#123;@code threadFactory&#125; or &#123;@code handler&#125; is null */public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler;&#125;å¦‚ä¸Šæ‰€ç¤ºï¼Œæ„é€ æ–¹æ³•çš„å‚æ•°å³æ ¸å¿ƒå‚æ•°ï¼Œè¿™é‡Œæˆ‘ç”¨ä¸€ä¸ªè¡¨æ ¼æ¥ç®€è¦è¯´æ˜ä¸€ä¸‹å„ä¸ªå‚æ•°çš„æ„ä¹‰ã€‚å¦‚ä¸‹ï¼šå‚æ•°è¯´æ˜corePoolSizeæ ¸å¿ƒçº¿ç¨‹æ•°ã€‚å½“çº¿ç¨‹æ•°å°äºè¯¥å€¼æ—¶ï¼Œçº¿ç¨‹æ± ä¼šä¼˜å…ˆåˆ›å»ºæ–°çº¿ç¨‹æ¥æ‰§è¡Œæ–°ä»»åŠ¡maximumPoolSizeçº¿ç¨‹æ± æ‰€èƒ½ç»´æŠ¤çš„æœ€å¤§çº¿ç¨‹æ•°keepAliveTimeç©ºé—²çº¿ç¨‹çš„å­˜æ´»æ—¶é—´workQueueä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºç¼“å­˜æœªæ‰§è¡Œçš„ä»»åŠ¡threadFactoryçº¿ç¨‹å·¥å‚ã€‚å¯é€šè¿‡å·¥å‚ä¸ºæ–°å»ºçš„çº¿ç¨‹è®¾ç½®æ›´æœ‰æ„ä¹‰çš„åå­—handleræ‹’ç»ç­–ç•¥ã€‚å½“çº¿ç¨‹æ± å’Œä»»åŠ¡é˜Ÿåˆ—å‡å¤„äºé¥±å’ŒçŠ¶æ€æ—¶ï¼Œä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°ä»»åŠ¡ã€‚é»˜è®¤æ˜¯ AbortPolicyï¼Œå³ç›´æ¥æŠ›å‡ºå¼‚å¸¸ä»¥ä¸Šæ˜¯å„ä¸ªå‚æ•°çš„ç®€ä»‹ï¼Œä¸‹é¢æˆ‘å°†ä¼šé’ˆå¯¹éƒ¨åˆ†å‚æ•°è¿›è¡Œè¯¦ç»†è¯´æ˜ï¼Œç»§ç»­å¾€ä¸‹çœ‹ã€‚3.1.2çº¿ç¨‹åˆ›å»ºè§„åˆ™åœ¨ Java çº¿ç¨‹æ± å®ç°ä¸­ï¼Œçº¿ç¨‹æ± æ‰€èƒ½åˆ›å»ºçš„çº¿ç¨‹æ•°é‡å—é™äº corePoolSize å’Œ maximumPoolSize ä¸¤ä¸ªå‚æ•°å€¼ã€‚çº¿ç¨‹çš„åˆ›å»ºæ—¶æœºåˆ™å’Œ corePoolSize ä»¥åŠ workQueue ä¸¤ä¸ªå‚æ•°æœ‰å…³ã€‚ä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹çº¿ç¨‹åˆ›å»ºçš„4ä¸ªè§„åˆ™ï¼ˆçº¿ç¨‹æ± ä¸­æ— ç©ºé—²çº¿ç¨‹ï¼‰ï¼Œå¦‚ä¸‹ï¼šçº¿ç¨‹æ•°é‡å°äºcorePoolSize ï¼Œç›´æ¥æ–°åˆ›å»ºçº¿ç¨‹å¤„ç†ä»»åŠ¡çº¿ç¨‹æ•°é‡å¤§äºç­‰äºcorePoolSize ï¼ŒworkQueue æœªæ»¡æ—¶ï¼Œç¼“å­˜æ–°ä»»åŠ¡çº¿ç¨‹æ•°é‡å¤§äºç­‰äºcorePoolSize ï¼Œå°äºmaximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹å¤„ç†æ–°ä»»åŠ¡çº¿ç¨‹æ•°é‡å¤§äºç­‰äº maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ï¼Œåˆ™ä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°ä»»åŠ¡è§„åˆ™å¦‚ä¸‹åºå·è§„åˆ™åŠ¨ä½œ1çº¿ç¨‹æ•° &lt; corePoolSizeåˆ›å»ºæ–°çº¿ç¨‹2çº¿ç¨‹æ•° &gt;= corePoolSize ï¼Œä¸” workQueue æœªæ»¡ç¼“å­˜æ–°ä»»åŠ¡3corePoolSize â‰¤ çº¿ç¨‹æ•° ï¼œ maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡åˆ›å»ºæ–°çº¿ç¨‹4çº¿ç¨‹æ•° â‰¥ maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†3.1.3èµ„æºå›æ”¶è€ƒè™‘åˆ°ç³»ç»Ÿèµ„æºæ˜¯æœ‰é™çš„ï¼Œå¯¹äºçº¿ç¨‹æ± è¶…å‡º corePoolSize æ•°é‡çš„ç©ºé—²çº¿ç¨‹åº”è¿›è¡Œå›æ”¶æ“ä½œã€‚è¿›è¡Œæ­¤æ“ä½œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå³å›æ”¶æ—¶æœºã€‚ç›®å‰çš„å®ç°æ–¹å¼æ˜¯å½“çº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTime åï¼Œè¿›è¡Œå›æ”¶ã€‚é™¤äº†æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹å¤–çš„çº¿ç¨‹å¯ä»¥è¿›è¡Œå›æ”¶ï¼Œæ ¸å¿ƒçº¿ç¨‹å†…çš„ç©ºé—²çº¿ç¨‹ä¹Ÿå¯ä»¥è¿›è¡Œå›æ”¶ã€‚å›æ”¶çš„å‰ææ˜¯allowCoreThreadTimeOutå±æ€§è¢«è®¾ç½®ä¸º trueï¼Œé€šè¿‡public void allowCoreThreadTimeOut(boolean) æ–¹æ³•å¯ä»¥è®¾ç½®å±æ€§å€¼ã€‚3.1.4æ’é˜Ÿç­–ç•¥å¦‚3.1.2 çº¿ç¨‹åˆ›å»ºè§„åˆ™ä¸€èŠ‚ä¸­è§„åˆ™2æ‰€è¯´ï¼Œå½“çº¿ç¨‹æ•°é‡å¤§äºç­‰äº corePoolSizeï¼ŒworkQueue æœªæ»¡æ—¶ï¼Œåˆ™ç¼“å­˜æ–°ä»»åŠ¡ã€‚è¿™é‡Œè¦è€ƒè™‘ä½¿ç”¨ä»€ä¹ˆç±»å‹çš„å®¹å™¨ç¼“å­˜æ–°ä»»åŠ¡ï¼Œé€šè¿‡ JDK æ–‡æ¡£ä»‹ç»ï¼Œæˆ‘ä»¬å¯çŸ¥é“æœ‰3ä¸­ç±»å‹çš„å®¹å™¨å¯ä¾›ä½¿ç”¨ï¼Œåˆ†åˆ«æ˜¯åŒæ­¥é˜Ÿåˆ—ï¼Œæœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—ã€‚å¯¹äºæœ‰ä¼˜å…ˆçº§çš„ä»»åŠ¡ï¼Œè¿™é‡Œè¿˜å¯ä»¥å¢åŠ ä¼˜å…ˆçº§é˜Ÿåˆ—ã€‚ä»¥ä¸Šæ‰€ä»‹ç»çš„4ä¸­ç±»å‹çš„é˜Ÿåˆ—ï¼Œå¯¹åº”çš„å®ç°ç±»å¦‚ä¸‹ï¼šå®ç°ç±»ç±»å‹è¯´æ˜SynchronousQueueåŒæ­¥é˜Ÿåˆ—è¯¥é˜Ÿåˆ—ä¸å­˜å‚¨å…ƒç´ ï¼Œæ¯ä¸ªæ’å…¥æ“ä½œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ç§»é™¤æ“ä½œï¼Œå¦åˆ™æ’å…¥æ“ä½œä¼šä¸€ç›´é˜»å¡ArrayBlockingQueueæœ‰ç•Œé˜Ÿåˆ—åŸºäºæ•°ç»„çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ FIFO åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºLinkedBlockingQueueæ— ç•Œé˜Ÿåˆ—åŸºäºé“¾è¡¨çš„é˜»å¡é˜Ÿåˆ—ï¼ŒæŒ‰ç…§ FIFO åŸåˆ™å¯¹å…ƒç´ è¿›è¡Œæ’åºPriorityBlockingQueueä¼˜å…ˆçº§é˜Ÿåˆ—å…·æœ‰ä¼˜å…ˆçº§çš„é˜»å¡é˜Ÿåˆ—3.1.5æ‹’ç»ç­–ç•¥å¦‚3.1.2 çº¿ç¨‹åˆ›å»ºè§„åˆ™ä¸€èŠ‚ä¸­è§„åˆ™4æ‰€è¯´ï¼Œçº¿ç¨‹æ•°é‡å¤§äºç­‰äº maximumPoolSizeï¼Œä¸” workQueue å·²æ»¡ï¼Œåˆ™ä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°ä»»åŠ¡ã€‚Java çº¿ç¨‹æ± æä¾›äº†4ä¸­æ‹’ç»ç­–ç•¥å®ç°ç±»ï¼Œå¦‚ä¸‹ï¼šå®ç°ç±»è¯´æ˜AbortPolicy ï¼ˆé»˜è®¤ï¼‰ä¸¢å¼ƒæ–°ä»»åŠ¡ï¼Œå¹¶æŠ›å‡º RejectedExecutionExceptionDiscardPolicyä¸åšä»»ä½•æ“ä½œï¼Œç›´æ¥ä¸¢å¼ƒæ–°ä»»åŠ¡DiscardOldestPolicyä¸¢å¼ƒé˜Ÿåˆ—é˜Ÿé¦–çš„å…ƒç´ ï¼Œå¹¶æ‰§è¡Œæ–°ä»»åŠ¡CallerRunsPolicyç”±è°ƒç”¨çº¿ç¨‹æ‰§è¡Œæ–°ä»»åŠ¡ä»¥ä¸Š4ä¸ªæ‹’ç»ç­–ç•¥ä¸­ï¼ŒAbortPolicy æ˜¯çº¿ç¨‹æ± å®ç°ç±»æ‰€ä½¿ç”¨çš„ç­–ç•¥ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ–¹æ³•public void setRejectedExecutionHandler(RejectedExecutionHandler)ä¿®æ”¹çº¿ç¨‹æ± å†³ç»ç­–ç•¥ã€‚3.2 é‡è¦æ“ä½œ3.2.1çº¿ç¨‹çš„åˆ›å»ºä¸å¤ç”¨åœ¨çº¿ç¨‹æ± çš„å®ç°ä¸Šï¼Œçº¿ç¨‹çš„åˆ›å»ºæ˜¯é€šè¿‡çº¿ç¨‹å·¥å‚æ¥å£ThreadFactoryçš„å®ç°ç±»æ¥å®Œæˆçš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹æ± ä½¿ç”¨Executors.defaultThreadFactory()æ–¹æ³•è¿”å›çš„çº¿ç¨‹å·¥å‚å®ç°ç±»ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡public void setThreadFactory(ThreadFactory)æ–¹æ³•è¿›è¡ŒåŠ¨æ€ä¿®æ”¹ã€‚å…·ä½“ç»†èŠ‚è¿™é‡Œå°±ä¸å¤šè¯´äº†ï¼Œå¹¶ä¸å¤æ‚ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å»çœ‹ä¸‹æºç ã€‚åœ¨çº¿ç¨‹æ± ä¸­ï¼Œçº¿ç¨‹çš„å¤ç”¨æ˜¯çº¿ç¨‹æ± çš„å…³é”®æ‰€åœ¨ã€‚è¿™å°±è¦æ±‚çº¿ç¨‹åœ¨æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œä¸èƒ½ç«‹å³é€€å‡ºã€‚å¯¹åº”åˆ°å…·ä½“å®ç°ä¸Šï¼Œå·¥ä½œçº¿ç¨‹åœ¨æ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œä¼šå†æ¬¡åˆ°ä»»åŠ¡é˜Ÿåˆ—è·å–æ–°çš„ä»»åŠ¡ã€‚å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­æ²¡æœ‰ä»»åŠ¡ï¼Œä¸” keepAliveTime ä¹Ÿæœªè¢«è®¾ç½®ï¼Œå·¥ä½œçº¿ç¨‹åˆ™ä¼šè¢«ä¸€è‡´é˜»å¡ä¸‹å»ã€‚é€šè¿‡è¿™ç§æ–¹å¼å³å¯å®ç°çº¿ç¨‹å¤ç”¨ã€‚è¯´å®ŒåŸç†ï¼Œå†æ¥çœ‹çœ‹çº¿ç¨‹çš„åˆ›å»ºå’Œå¤ç”¨çš„ç›¸å…³ä»£ç ï¼ˆåŸºäº JDK 1.8ï¼‰ï¼Œå¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120private final class Worker extends AbstractQueuedSynchronizer implements Runnable &#123; /** * This class will never be serialized, but we provide a * serialVersionUID to suppress a javac warning. */ private static final long serialVersionUID = 6138294804551838833L; /** Thread this worker is running in. Null if factory fails. */ final Thread thread; /** Initial task to run. Possibly null. */ Runnable firstTask; /** Per-thread task counter */ volatile long completedTasks; /** * Creates with given first task and thread from ThreadFactory. * @param firstTask the first task (null if none) */ Worker(Runnable firstTask) &#123; setState(-1); // inhibit interrupts until runWorker this.firstTask = firstTask; // è°ƒç”¨çº¿ç¨‹å·¥å‚åˆ›å»ºçº¿ç¨‹ this.thread = getThreadFactory().newThread(this); &#125; /** Delegates main run loop to outer runWorker */ public void run() &#123; //å…·ä½“çš„æ‰§è¡Œ runWorker(this); &#125; // Lock methods // // The value 0 represents the unlocked state. // The value 1 represents the locked state. protected boolean isHeldExclusively() &#123; return getState() != 0; &#125; protected boolean tryAcquire(int unused) &#123; if (compareAndSetState(0, 1)) &#123; setExclusiveOwnerThread(Thread.currentThread()); return true; &#125; return false; &#125; protected boolean tryRelease(int unused) &#123; setExclusiveOwnerThread(null); setState(0); return true; &#125; public void lock() &#123; acquire(1); &#125; public boolean tryLock() &#123; return tryAcquire(1); &#125; public void unlock() &#123; release(1); &#125; public boolean isLocked() &#123; return isHeldExclusively(); &#125; void interruptIfStarted() &#123; Thread t; if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) &#123; try &#123; t.interrupt(); &#125; catch (SecurityException ignore) &#123; &#125; &#125; &#125; &#125;//å…·ä½“çš„æ‰§è¡Œfinal void runWorker(Worker w) &#123; Thread wt = Thread.currentThread(); Runnable task = w.firstTask; w.firstTask = null; w.unlock(); // allow interrupts boolean completedAbruptly = true; try &#123; // å¾ªç¯ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–æ–°ä»»åŠ¡ while (task != null || (task = getTask()) != null) &#123; w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; beforeExecute(wt, task); Throwable thrown = null; try &#123; // æ‰§è¡Œæ–°ä»»åŠ¡ task.run(); &#125; catch (RuntimeException x) &#123; thrown = x; throw x; &#125; catch (Error x) &#123; thrown = x; throw x; &#125; catch (Throwable x) &#123; thrown = x; throw new Error(x); &#125; finally &#123; afterExecute(task, thrown); &#125; &#125; finally &#123; task = null; w.completedTasks++; w.unlock(); &#125; &#125; completedAbruptly = false; &#125; finally &#123; // çº¿ç¨‹é€€å‡ºåï¼Œè¿›è¡Œåç»­å¤„ç† processWorkerExit(w, completedAbruptly); &#125; &#125;3.2.2 æäº¤ä»»åŠ¡é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡çº¿ç¨‹æ± çš„submitæ–¹æ³•æäº¤ä»»åŠ¡ã€‚è¢«æäº¤çš„ä»»åŠ¡å¯èƒ½ä¼šç«‹å³æ‰§è¡Œï¼Œä¹Ÿå¯èƒ½ä¼šè¢«ç¼“å­˜æˆ–è€…è¢«æ‹’ç»ã€‚ä»»åŠ¡çš„å¤„ç†æµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼šä¸Šé¢çš„æµç¨‹å›¾ä¸æ˜¯å¾ˆå¤æ‚ï¼Œä¸‹é¢å†æ¥çœ‹çœ‹æµç¨‹å›¾å¯¹åº”çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106+---- AbstractExecutorService.javapublic Future&lt;?&gt; submit(Runnable task) &#123; if (task == null) throw new NullPointerException(); // åˆ›å»ºä»»åŠ¡ RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null); // æäº¤ä»»åŠ¡ execute(ftask); return ftask;&#125;+---- ThreadPoolExecutor.javapublic void execute(Runnable command) &#123; if (command == null) throw new NullPointerException(); int c = ctl.get(); // å¦‚æœå·¥ä½œçº¿ç¨‹æ•°é‡ &lt; æ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ–°çº¿ç¨‹ if (workerCountOf(c) &lt; corePoolSize) &#123; // æ·»åŠ å·¥ä½œè€…å¯¹è±¡ if (addWorker(command, true)) return; c = ctl.get(); &#125; // ç¼“å­˜ä»»åŠ¡ï¼Œå¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œåˆ™ offer æ–¹æ³•è¿”å› falseã€‚å¦åˆ™ï¼Œoffer è¿”å› true if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; int recheck = ctl.get(); if (! isRunning(recheck) &amp;&amp; remove(command)) reject(command); else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; // æ·»åŠ å·¥ä½œè€…å¯¹è±¡ï¼Œå¹¶åœ¨ addWorker æ–¹æ³•ä¸­æ£€æµ‹çº¿ç¨‹æ•°æ˜¯å¦å°äºæœ€å¤§çº¿ç¨‹æ•° else if (!addWorker(command, false)) // çº¿ç¨‹æ•° &gt;= æœ€å¤§çº¿ç¨‹æ•°ï¼Œä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡ reject(command);&#125;private boolean addWorker(Runnable firstTask, boolean core) &#123; retry: for (;;) &#123; int c = ctl.get(); int rs = runStateOf(c); // Check if queue empty only if necessary. if (rs &gt;= SHUTDOWN &amp;&amp; ! (rs == SHUTDOWN &amp;&amp; firstTask == null &amp;&amp; ! workQueue.isEmpty())) return false; for (;;) &#123; int wc = workerCountOf(c); // æ£€æµ‹å·¥ä½œçº¿ç¨‹æ•°ä¸æ ¸å¿ƒçº¿ç¨‹æ•°æˆ–æœ€å¤§çº¿ç¨‹æ•°çš„å…³ç³» if (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize)) return false; if (compareAndIncrementWorkerCount(c)) break retry; c = ctl.get(); // Re-read ctl if (runStateOf(c) != rs) continue retry; // else CAS failed due to workerCount change; retry inner loop &#125; &#125; boolean workerStarted = false; boolean workerAdded = false; Worker w = null; try &#123; // åˆ›å»ºå·¥ä½œè€…å¯¹è±¡ï¼Œç»†èŠ‚å‚è€ƒä¸Šä¸€èŠ‚æ‰€è´´ä»£ç  w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; int rs = runStateOf(ctl.get()); if (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); // å°† worker å¯¹è±¡æ·»åŠ åˆ° workers é›†åˆä¸­ workers.add(w); int s = workers.size(); // æ›´æ–° largestPoolSize å±æ€§ if (s &gt; largestPoolSize) largestPoolSize = s; workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; if (workerAdded) &#123; // å¼€å§‹æ‰§è¡Œä»»åŠ¡ t.start(); workerStarted = true; &#125; &#125; &#125; finally &#123; if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125;3.2.3 å…³é—­çº¿ç¨‹æ± æˆ‘ä»¬å¯ä»¥é€šè¿‡shutdownå’ŒshutdownNowä¸¤ä¸ªæ–¹æ³•å…³é—­çº¿ç¨‹æ± ã€‚ä¸¤ä¸ªæ–¹æ³•çš„åŒºåˆ«åœ¨äºï¼Œshutdown ä¼šå°†çº¿ç¨‹æ± çš„çŠ¶æ€è®¾ç½®ä¸ºSHUTDOWNï¼ŒåŒæ—¶è¯¥æ–¹æ³•è¿˜ä¼šä¸­æ–­ç©ºé—²çº¿ç¨‹ã€‚shutdownNow åˆ™ä¼šå°†çº¿ç¨‹æ± çŠ¶æ€è®¾ç½®ä¸ºSTOPï¼Œå¹¶å°è¯•ä¸­æ–­æ‰€æœ‰çš„çº¿ç¨‹ã€‚ä¸­æ–­çº¿ç¨‹ä½¿ç”¨çš„æ˜¯Thread.interruptæ–¹æ³•ï¼Œæœªå“åº”ä¸­æ–­æ–¹æ³•çš„ä»»åŠ¡æ˜¯æ— æ³•è¢«ä¸­æ–­çš„ã€‚æœ€åï¼ŒshutdownNow æ–¹æ³•ä¼šå°†æœªæ‰§è¡Œçš„ä»»åŠ¡å…¨éƒ¨è¿”å›ã€‚è°ƒç”¨ shutdown å’Œ shutdownNow æ–¹æ³•å…³é—­çº¿ç¨‹æ± åï¼Œå°±ä¸èƒ½å†å‘çº¿ç¨‹æ± æäº¤æ–°ä»»åŠ¡äº†ã€‚å¯¹äºå¤„äºå…³é—­çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œä¼šä½¿ç”¨æ‹’ç»ç­–ç•¥å¤„ç†æ–°æäº¤çš„ä»»åŠ¡ã€‚4.å‡ ç§çº¿ç¨‹æ± ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¹¶ä¸ç›´æ¥ä½¿ç”¨ ThreadPoolExecutor ç±»åˆ›å»ºçº¿ç¨‹æ± ï¼Œè€Œæ˜¯é€šè¿‡ Executors å·¥å…·ç±»å»æ„å»ºçº¿ç¨‹æ± ã€‚é€šè¿‡ Executors å·¥å…·ç±»ï¼Œæˆ‘ä»¬å¯ä»¥æ„é€ 5ä¸­ä¸åŒçš„çº¿ç¨‹æ± ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªè¡¨æ ¼ç®€å•ä»‹ç»ä¸€ä¸‹å‡ ç§çº¿ç¨‹æ± ï¼Œå¦‚ä¸‹ï¼šæ„é€ æ–¹æ³•è¯´æ˜newFixedThreadPool(int nThreads)æ„å»ºåŒ…å«å›ºå®šçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œç©ºé—²çº¿ç¨‹ä¸ä¼šè¢«å›æ”¶newCachedThreadPool()æ„å»ºçº¿ç¨‹æ•°ä¸å®šçš„çº¿ç¨‹æ± ï¼Œçº¿ç¨‹æ•°é‡éšä»»åŠ¡é‡å˜åŠ¨ï¼Œç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´è¶…è¿‡60ç§’åä¼šè¢«å›æ”¶newSingleThreadExecutor()æ„å»ºçº¿ç¨‹æ•°ä¸º1çš„çº¿ç¨‹æ± ï¼Œç­‰ä»·äº newFixedThreadPool(1) æ‰€æ„é€ å‡ºçš„çº¿ç¨‹æ± newScheduledThreadPool(int corePoolSize)æ„å»ºæ ¸å¿ƒçº¿ç¨‹æ•°ä¸º corePoolSizeï¼Œå¯æ‰§è¡Œå®šæ—¶ä»»åŠ¡çš„çº¿ç¨‹æ± newSingleThreadScheduledExecutor()ç­‰ä»·äº newScheduledThreadPool(1)5.æ€»ç»“ä¸€èˆ¬éœ€è¦æ ¹æ®ä»»åŠ¡çš„ç±»å‹æ¥é…ç½®çº¿ç¨‹æ± å¤§å°ï¼šå¦‚æœæ˜¯CPUå¯†é›†å‹ä»»åŠ¡ï¼Œå°±éœ€è¦å°½é‡å‹æ¦¨CPUï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ä¸º NCPU+1ï¼›å¦‚æœæ˜¯IOå¯†é›†å‹ä»»åŠ¡ï¼Œå‚è€ƒå€¼å¯ä»¥è®¾ç½®ä¸º2*NCPUã€‚å½“ç„¶ï¼Œè¿™åªæ˜¯ä¸€ä¸ªå‚è€ƒå€¼ï¼Œå…·ä½“çš„è®¾ç½®è¿˜éœ€è¦æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œè°ƒæ•´ï¼Œæ¯”å¦‚å¯ä»¥å…ˆå°†çº¿ç¨‹æ± å¤§å°è®¾ç½®ä¸ºå‚è€ƒå€¼ï¼Œå†è§‚å¯Ÿä»»åŠ¡è¿è¡Œæƒ…å†µå’Œç³»ç»Ÿè´Ÿè½½ã€èµ„æºåˆ©ç”¨ç‡æ¥è¿›è¡Œé€‚å½“è°ƒæ•´ã€‚å‚è€ƒhttp://developer.51cto.com/art/201203/321885.htmhttp://blog.csdn.net/cutesource/article/details/6061229http://blog.csdn.net/xieyuooo/article/details/8718741","categories":[{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"http://localhost:4000/categories/JavaåŸºç¡€/"},{"name":"å¹¶å‘","slug":"JavaåŸºç¡€/å¹¶å‘","permalink":"http://localhost:4000/categories/JavaåŸºç¡€/å¹¶å‘/"}],"tags":[{"name":"é”","slug":"é”","permalink":"http://localhost:4000/tags/é”/"},{"name":"JavaåŸºç¡€","slug":"JavaåŸºç¡€","permalink":"http://localhost:4000/tags/JavaåŸºç¡€/"},{"name":"å¼€å‘","slug":"å¼€å‘","permalink":"http://localhost:4000/tags/å¼€å‘/"},{"name":"çº¿ç¨‹æ± ","slug":"çº¿ç¨‹æ± ","permalink":"http://localhost:4000/tags/çº¿ç¨‹æ± /"}]},{"title":"Hello World","slug":"hello-world","date":"2019-06-14T13:48:34.388Z","updated":"2019-06-16T07:30:14.246Z","comments":true,"path":"2019/06/14/hello-world/","link":"","permalink":"http://localhost:4000/2019/06/14/hello-world/","excerpt":"","text":"Welcome to Hexo! This is your very first post. Check documentation for more info. If you get any problems when using Hexo, you can find the answer in troubleshooting or you can ask me on GitHub.Quick StartCreate a new post1$ hexo new \"My New Post\"More info: WritingRun server1$ hexo serverMore info: ServerGenerate static files1$ hexo generateMore info: GeneratingDeploy to remote sites1$ hexo deployMore info: Deployment","categories":[],"tags":[]}]}